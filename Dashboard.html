<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark">
  <title>Dashboard — Scope</title>
  <style>
    :root{
      --brand-600:#7d79f9; --brand-700:#6c63d9;
      --brand-gradient:linear-gradient(90deg,#7d79f9,#c864aa);
      --brand-outline:color-mix(in srgb,var(--brand-600),#fff 40%);
      --ink-900:#0b1220; --ink-800:#111827; --ink-700:#1f2937; --ink-600:#374151; --ink-500:#4b5563;
      --surface:#ffffff; --muted:#f9fafb; --border:#e5e7eb; --card-border:#c4b5fd;
      --radius:16px; --shadow:0 10px 28px rgba(2,6,23,.06); --ring:0 0 0 3px rgba(125,121,249,0.6);
      --track-light:#e5e7eb; --track-dark:#374151;
      --card-radius:16px; --card-shadow:0 10px 28px rgba(2,6,23,.06);
      --appbar-h:72px;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--muted);color:var(--ink-900);line-height:1.7;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    button:focus-visible,a:focus-visible{outline:none;box-shadow:var(--ring)}

    header{position:sticky;top:0;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);box-shadow:0 8px 18px rgba(2,6,23,.04);z-index:50}
    body[data-theme="dark"] header{background:rgba(17,24,39,.96);border-bottom-color:var(--border)}
    .nav{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:14px;padding-block:14px;padding-inline-end:clamp(28px,6vw,96px)}
    .brand{display:flex;gap:.6rem;align-items:center;font-weight:800;color:var(--ink-900);text-decoration:none}
    .brand .logo{inline-size:40px;block-size:40px;border-radius:12px;background:#fff;border:2px solid var(--brand-600);display:grid;place-items:center;box-shadow:var(--shadow)}
    .brand span{font-size:18px}
    .appbar-center{justify-self:center;font-weight:800;color:var(--ink-900)}
    .nav-right{display:flex;align-items:center;gap:12px;contain:layout paint}
    .nav-right>*{display:flex;align-items:center}
    .nav-actions{display:flex;align-items:center;gap:12px;white-space:nowrap}
    #lang-toggle,.theme-switch{height:32px}
    .theme-switch{min-width:56px}

    .chip{border:1px solid var(--brand-outline);border-radius:999px;padding:0 10px;height:32px;font-weight:700;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-width:52px;font-size:14px;box-shadow:0 1px 2px rgba(2,6,23,.06);transition:background-color .20s ease,border-color .20s ease,color .20s ease;will-change:background-color,border-color,color;backface-visibility:hidden;transform:translateZ(0)}
    .chip:focus-visible{outline:none;box-shadow:var(--ring)}
    .chip:hover{background:var(--muted)}
    body:not([data-theme="dark"]) .chip{color:#0b1220}
    body[data-theme="dark"] .chip{background:var(--surface);border-color:var(--brand-outline);color:#f3f5fa}

    .hamburger{
      background:transparent;border:1px solid var(--brand-outline);
      width:36px;height:36px;border-radius:999px;line-height:1;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:18px;color:var(--ink-900);cursor:pointer;
    }
    .hamburger:focus-visible{outline:none;box-shadow:var(--ring)}

    .theme-switch{position:relative;display:inline-flex;width:56px;height:32px}
    .theme-switch input{opacity:0;width:0;height:0}
    .theme-switch .slider{position:relative;cursor:pointer;display:block;width:100%;height:100%;background:var(--track-light);transition:background-color .20s ease,border-color .20s ease,left .20s ease,transform .20s ease;border-radius:9999px;box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid var(--brand-outline);padding:3px;backface-visibility:hidden;transform:translateZ(0)}
    .theme-switch input:focus-visible + .slider{box-shadow:var(--ring)}
    body[data-theme="dark"] .theme-switch .slider{background:var(--track-dark);box-shadow:0 1px 2px rgba(255,255,255,.3)}
    .theme-switch .thumb{position:absolute;top:50%;left:3px;width:24px;height:24px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background-color .20s ease,border-color .20s ease,left .20s ease,transform .20s ease;border:1px solid var(--brand-outline);box-shadow:0 2px 4px rgba(0,0,0,.2);transform:translateY(-50%) translateZ(0);backface-visibility:hidden}
    .theme-switch input:checked + .slider{background:var(--brand-600)}
    .theme-switch input:checked + .slider .thumb{left:calc(100% - 3px);transform:translate(-100%,-50%) translateZ(0)}
    .theme-switch .icon{width:16px;height:16px;stroke-width:2}
    .theme-switch .icon.sun{stroke:#FDB813;fill:none}
    .theme-switch .icon.moon{fill:#20354a;stroke:none;display:none}
    .theme-switch input:checked + .slider .icon.sun{display:none}
    .theme-switch input:checked + .slider .icon.moon{display:block}

    .theme-changing .chip,
    .theme-changing .theme-switch .slider,
    .theme-changing .theme-switch .thumb{transition-duration:.10s}

    .mobile-toggle{display:none;background:none;border:1px solid var(--border);border-radius:999px;padding:10px 14px}
    .mobile-toggle:focus-visible{outline:none;box-shadow:var(--ring)}
    @media (max-width:820px){
      .mobile-toggle{display:inline-flex}
    }

    body[data-theme="dark"]{--ink-900:#f9fafb;--ink-800:#e5e7eb;--ink-700:#d1d5db;--ink-600:#9ca3af;--ink-500:#6b7280;--surface:#111827;--muted:#1f2937;--border:#374151;background:#0b1220;color:var(--ink-900)}

    /* Drawer */
    #drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);z-index:40}
    .drawer{position:fixed;top:0;right:0;height:100%;width:280px;max-width:80%;background:var(--surface);border-left:1px solid var(--card-border);box-shadow:-4px 0 18px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .3s;z-index:50;padding:20px;display:flex;flex-direction:column;gap:20px}
    .drawer.open{transform:translateX(0)}
    .drawer a{padding:10px 0;font-weight:600}
    /* Layout */

    :root{
      --brand-1: #8e2de2;  /* purple */
      --brand-2: #ff66c7;  /* pink   */
      --surface: #ffffff;
      --border: #e8e8f2;
      --shadow: 0 10px 28px rgba(2,6,23,.06);
    }

    .container{ max-width: 1400px; margin-inline: auto; padding-inline: clamp(16px,4vw,40px); }

    .cards{
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: clamp(16px, 2.4vw, 26px);
      padding-bottom: 32px;
    }

    /* Gradient border (no weird masks): use border-image */
    .card.big{
      background: var(--surface);
      border: 2px solid transparent;
      border-radius: 20px;
      border-image: linear-gradient(135deg, var(--brand-1), var(--brand-2)) 1;
      min-height: clamp(320px, 52vh, 560px);
      box-shadow: var(--shadow);
    }

    /* Dark mode parity */
    body[data-theme="dark"] .card.big{
      background: var(--surface);
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
    }

    /* Responsive: 3 -> 2 -> 1 columns */
    @media (max-width: 1200px){
      .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 760px){
      .cards{ grid-template-columns: 1fr; }
    }
    :root{
      --brand-1:#8e2de2; /* purple */
      --brand-2:#ff66c7; /* pink */
      --surface:#ffffff;
      --border:#e8e8f2;
      --ink-900:#0b1220;
      --shadow:0 10px 28px rgba(2,6,23,.06);
    }

    .container{ max-width:1400px; margin-inline:auto; padding-inline:clamp(16px,4vw,40px); }

    .cards{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:clamp(16px,2.4vw,26px);
      padding-bottom:24px;
    }

    /* gradient border + rounded corners + fills remaining height */
    .card.big{
      background:var(--surface);
      border:2px solid transparent;
      border-radius:24px;
      border-image:linear-gradient(135deg,var(--brand-1),var(--brand-2)) 1;
      overflow:hidden;
      box-shadow:var(--shadow);

      /* “helt ned”: viewport minus header & topp-margin */
      min-height:clamp(520px, calc(100vh - 160px), 1000px);
      display:flex;
      flex-direction:column;
    }

    /* space for future content */
    .card.big > *:not(.card-header){ padding:18px; }

    /* dark mode */
    body[data-theme="dark"] .card.big{
      background:#111827;
      box-shadow:0 10px 28px rgba(0,0,0,.28);
    }

    /* responsive: 3 -> 2 -> 1 columns */
    @media (max-width:1200px){ .cards{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:760px){ .cards{ grid-template-columns:1fr; } }

    /* Dashboard card tweaks */
    .card.big{
      border-radius:24px;         /* round corners */
      overflow:hidden;            /* clip header to radius */
    }

    /* Header layout */
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px 10px;
    }
    .card-header h3{
      margin:0;
      font-size:20px;
      font-weight:700;
    }
    .card-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    /* Button base */
    .btn{font-weight:600;line-height:1;cursor:pointer;transition:.2s ease}
    .btn-pill{border-radius:9999px;padding:10px 18px;font-size:16px}
    .btn-outline{
      background:transparent;
      border:2px solid var(--brand-300,#bfa7ff);
      color:var(--ink-900,#0b1220);
      box-shadow:0 0 0 0 rgba(0,0,0,0);
    }
    .btn-outline:hover{
      background:rgba(143,45,226,.06);
      transform:translateY(-1px);
    }
    .btn-outline:focus-visible{
      outline:none;
      box-shadow:0 0 0 3px rgba(179,144,255,.35);
    }
    [data-theme="dark"] .btn-outline{
      border-color:var(--brand-400,#c38cff);
      color:var(--ink-100,#f5f7ff);
    }
    [data-theme="dark"] .btn-outline:hover{
      background:rgba(195,140,255,.10);
    }

    :root{
      --card-radius: 24px;              /* adjust if you want softer/harder corners */
    }

    .card.big{
      position: relative;
      border: 1px solid transparent;    /* needed for the gradient border trick */
      border-radius: var(--card-radius);
      border-image: none;
      background:
        linear-gradient(var(--surface), var(--surface)) padding-box,         /* inner fill */
        var(--brand-gradient) border-box;                                    /* outer gradient */
      box-shadow: 0 10px 28px rgba(2,6,23,.06);
      overflow: hidden;                           /* clip content & shadows to radius */
      isolation: isolate;                         /* safer with shadows/filters */
    }

    /* If there is an inner content wrapper, keep the same radius */
    .card.big .card-inner,
    .card.big .card-body{
      border-radius: inherit;
      background: transparent;
    }

    /* Hover state keeps radius */
    .card.big:hover{
      box-shadow: 0 12px 34px rgba(2,6,23,.10);
      transform: translateY(-1px);
    }

    /* KILL any old gradient border implementations that break corners */
    .card.big::before,
    .card.big::after{
      content: none !important;
      display: none !important;
    }

    /* If some previous rule forces a different radius, neutralize it */
    .card,
    .panel,
    .board-card{
      border-radius: var(--card-radius);
    }

    /* Dark mode divider/header inside the card should also follow radius if needed */
    body[data-theme="dark"] .card.big{
      background:
        linear-gradient(var(--surface), var(--surface)) padding-box,
        var(--brand-gradient) border-box;
    }
    /* Popover shell */
    .month-popover{
      position:absolute; z-index:1000; min-width:260px;
      background:var(--surface); color:var(--ink-900);
      border:1px solid var(--brand-outline); border-radius:14px;
      box-shadow:0 12px 28px rgba(2,6,23,.18); padding:10px;
      animation:mpo .12s ease;
    }
    @keyframes mpo{from{opacity:.0; transform:translateY(-6px)} to{opacity:1; transform:none}}
    body[data-theme="dark"] .month-popover{
      background:var(--surface); border-color:var(--brand-outline);
    }
    .month-popover .mpo-head{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:6px 6px 8px; border-bottom:1px solid var(--border);
    }
    .mpo-head .mpo-nav{display:flex; gap:6px}
    .mpo-head .icon-btn{
      appearance:none; border:1px solid var(--brand-outline); background:transparent;
      width:28px; height:28px; border-radius:999px; display:grid; place-items:center;
      cursor:pointer;
    }
    .mpo-grid{
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px; padding:10px 4px 4px;
    }
    .mpo-grid button{
      appearance:none; cursor:pointer; border:1px solid var(--brand-outline);
      background:transparent; color:inherit; border-radius:12px;
      padding:10px 8px; font-weight:700;
    }
    .mpo-grid button:hover{background:var(--muted)}
    .mpo-grid button[aria-pressed="true"]{
      background:var(--brand-gradient); border-color:transparent; color:#fff;
    }
    .mpo-foot{padding:8px 6px 4px; color:var(--ink-600); font-size:12px; min-height:18px}

    .btn.sm{padding:6px 12px;font-size:14px;border:1px solid var(--brand-outline);border-radius:8px;background:var(--surface)}
    .btn.sm.ghost{background:transparent}
  </style>
  <!-- Inline SVGs for Scope logo -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <symbol id="icon-scope" viewBox="0 0 40 40">
        <circle cx="20" cy="20" r="18" fill="none" stroke="currentColor" stroke-width="3"/>
        <circle cx="20" cy="20" r="12" fill="none" stroke="currentColor" stroke-width="3"/>
        <circle cx="20" cy="20" r="6" fill="none" stroke="currentColor" stroke-width="3"/>
        <circle cx="20" cy="20" r="2.2" fill="currentColor"/>
      </symbol>
    </defs>
  </svg>
  <script>
    (function(){
      try{
        const authed = localStorage.getItem('scope.authed') === '1';
        const user = (localStorage.getItem('scope.user')||'').toLowerCase();
        if(!authed || user!=='test@gressholmen.no'){
          window.location.replace('login.html');
        }
      }catch(e){ window.location.replace('login.html'); }
    })();
  </script>
</head>
<body>
  <header>
    <div class="container nav" role="navigation" aria-label="Toppmeny">
      <a class="brand" href="/" aria-label="Scope">
        <div class="logo" style="color:var(--brand-600)"><svg width="24" height="24" viewBox="0 0 40 40" aria-hidden="true"><use href="#icon-scope"/></svg></div>
        <span>Scope</span>
      </a>

      <div class="appbar-center"><span id="company-name">Gressholmen Kro</span></div>

      <div class="nav-actions">
        <button id="lang-toggle" class="chip">NO</button>
        <label class="theme-switch">
          <input type="checkbox" id="theme-toggle" aria-label="Tema">
          <span class="slider">
            <span class="thumb">
              <svg class="icon sun" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <svg class="icon moon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/>
              </svg>
            </span>
          </span>
        </label>
        <button id="menu-toggle" class="hamburger" aria-label="Meny" type="button">☰</button>
      </div>
    </div>
    </header>

  <section class="cards container" aria-label="Hovedpanel">
    <article class="card big" aria-label="KPI-er">
      <div class="card-header">
        <h3>KPI-er</h3>
        <div class="card-actions">
          <button id="monthStartBtn" class="chip" type="button">Start</button>
          <button id="monthEndBtn" class="chip" type="button">Slutt</button>
        </div>
      </div>
      <!-- content can go here -->
    </article>
    <article class="card big" aria-label="Oversikt">
      <div class="card-header"><h3>Oversikt</h3></div>
    </article>
    <article class="card big ai-tips" aria-label="AI-tips">
      <div class="card-header">
        <h3>AI-tips</h3>
      </div>
    </article>
    <section class="card" id="tripletex-sales" style="border-radius:16px; border:1px solid #c4b5fd; padding:16px; box-shadow:0 10px 28px rgba(2,6,23,.06);">
      <header style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0">Tripletex — Salg (konto 3003)</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="start-date" type="date" />
          <input id="end-date" type="date" />
          <button class="btn sm" data-tt="fetch">Hent</button>
          <button class="btn sm" data-tt="csv">CSV</button>
        </div>
      </header>
      <p data-tt="out" style="margin:10px 0">–</p>
      <div class="table-wrap" style="overflow:auto;">
        <table class="table" style="width:100%; border-collapse:collapse;">
          <thead><tr><th>ID</th><th>Dato</th><th style="text-align:right">Beløp</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </section>
  <script defer src="/assets/js/tripletex.js"></script>

  <div id="drawer-backdrop" hidden></div>
  <aside id="side-drawer" class="drawer" hidden>
    <a href="dashboard.html">Dashboard</a>
    <a href="#">Reports</a>
    <a href="#">Inventory</a>
    <a href="#">Settings</a>
    <a href="#" id="logout">Log out</a>
  </aside>
  <div id="month-portals"></div>
  <script>
    function applyTheme(theme){
      document.body.setAttribute('data-theme', theme);
      const toggle=document.querySelector('#theme-toggle');
      if(toggle) toggle.checked = (theme === 'dark');
      document.body.classList.add('theme-changing');
      requestAnimationFrame(()=> setTimeout(()=> {
        document.body.classList.remove('theme-changing');
      }, 160));
    }
    (function(){
      const btn = document.getElementById('lang-toggle');
      if(btn){
        const saved = localStorage.getItem('scope.lang') || 'no';
        if (typeof applyLang === 'function') applyLang(saved); else document.documentElement.lang = saved;
        btn.textContent = (saved==='no' ? 'EN' : 'NO');
        btn.addEventListener('click', ()=>{
          const current = document.documentElement.lang === 'en' ? 'en' : 'no';
          const next = current === 'en' ? 'no' : 'en';
          localStorage.setItem('scope.lang', next);
          if (typeof applyLang === 'function') applyLang(next); else document.documentElement.lang = next;
          btn.textContent = (next==='no' ? 'EN' : 'NO');
        });
      }
      const t = document.getElementById('theme-toggle');
      if(t){
        const savedTheme = localStorage.getItem('scope.theme') || 'light';
        applyTheme(savedTheme);
        t.checked = (savedTheme==='dark');
        t.addEventListener('change', ()=>{
          const theme = t.checked ? 'dark' : 'light';
          localStorage.setItem('scope.theme', theme);
          applyTheme(theme);
        });
      }
    })();
  </script>
  <script>
    const drawer=document.getElementById('side-drawer');
    const backdrop=document.getElementById('drawer-backdrop');
    const menuToggle=document.getElementById('menu-toggle');
    menuToggle?.addEventListener('click',()=>{
      const hidden=drawer.hasAttribute('hidden');
      if(hidden){
        drawer.hidden=false;
        backdrop.hidden=false;
        drawer.classList.add('open');
      }else{
        drawer.classList.remove('open');
        drawer.hidden=true;
        backdrop.hidden=true;
      }
      menuToggle.setAttribute('aria-expanded',String(hidden));
    });
    backdrop?.addEventListener('click',()=>{
      drawer.classList.remove('open');
      drawer.hidden=true;backdrop.hidden=true;
      menuToggle.setAttribute('aria-expanded','false');
    });
    document.addEventListener('keydown',e=>{
      if(e.key==='Escape'){
        drawer.classList.remove('open');
        drawer.hidden=true;backdrop.hidden=true;
        menuToggle.setAttribute('aria-expanded','false');
      }
    });
  </script>
  <script>
(() => {
  const $ = (s,c=document)=>c.querySelector(s);
  const portals = $('#month-portals') || (()=>{const d=document.createElement('div'); d.id='month-portals'; document.body.appendChild(d); return d;})();
  const lang = document.documentElement.lang === 'en' ? 'en' : 'no';
  const monthFmt = new Intl.DateTimeFormat(lang, { month:'short' });
  const yearNow = (new Date()).getFullYear();

  const state = {
    start: null, // 'YYYY-MM'
    end:   null, // 'YYYY-MM'
  };

  function isoYM(y,m){ return `${y}-${String(m+1).padStart(2,'0')}`; }

  function placePopover(pop, anchor){
    const r = anchor.getBoundingClientRect();
    pop.style.top  = `${window.scrollY + r.bottom + 8}px`;
    pop.style.left = `${window.scrollX + Math.min(r.left, window.innerWidth - pop.offsetWidth - 12)}px`;
  }

  function monthGrid(year, selectedYM){
    const wrap = document.createElement('div');
    wrap.className = 'mpo-grid';
    for(let i=0;i<12;i++){
      const btn = document.createElement('button');
      btn.type = 'button';
      const label = monthFmt.format(new Date(year, i, 1));
      btn.textContent = label.charAt(0).toUpperCase()+label.slice(1);
      const ym = isoYM(year,i);
      if(selectedYM && selectedYM === ym) btn.setAttribute('aria-pressed','true');
      btn.dataset.ym = ym;
      wrap.appendChild(btn);
    }
    return wrap;
  }

  function makePopover({ anchorBtn, current, onPick }){
    const pop = document.createElement('div');
    pop.className = 'month-popover';
    let year = yearNow;

    const head = document.createElement('div');
    head.className = 'mpo-head';
    const nav = document.createElement('div'); nav.className='mpo-nav';
    const prev = document.createElement('button'); prev.className='icon-btn'; prev.innerHTML='‹';
    const next = document.createElement('button'); next.className='icon-btn'; next.innerHTML='›';
    const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = String(year);
    nav.append(prev,next); head.append(title, nav);

    let grid = monthGrid(year, current); // initial
    const foot = document.createElement('div'); foot.className='mpo-foot';

    pop.append(head, grid, foot);
    portals.appendChild(pop);
    placePopover(pop, anchorBtn);

    function redraw(){
      const g2 = monthGrid(year, current);
      pop.replaceChild(g2, grid);
      grid = g2;
      title.textContent = String(year);
      wireGrid();
    }

    function wireGrid(){
      grid.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          current = btn.dataset.ym;
          onPick(current, (msg)=> foot.textContent = msg || '');
          grid.querySelectorAll('button[aria-pressed="true"]').forEach(b=>b.removeAttribute('aria-pressed'));
          btn.setAttribute('aria-pressed','true');
          if(!foot.textContent) close();
        });
      });
    }

    function close(){
      document.removeEventListener('keydown', onEsc, true);
      document.removeEventListener('click', onDoc, true);
      pop.remove();
    }

    function onEsc(e){ if(e.key==='Escape'){ e.stopPropagation(); close(); } }
    function onDoc(e){
      if(!pop.contains(e.target) && e.target !== anchorBtn){ close(); }
    }

    prev.addEventListener('click', ()=>{ year--; redraw(); });
    next.addEventListener('click', ()=>{ year++; redraw(); });

    document.addEventListener('keydown', onEsc, true);
    setTimeout(()=>document.addEventListener('click', onDoc, true), 0);
    wireGrid();
    return { close };
  }

  function label(btnBase, ym){
    if(!ym) return btnBase;
    const [y,m] = ym.split('-').map(Number);
    const mName = new Intl.DateTimeFormat(lang,{month:'short'}).format(new Date(y,m-1,1));
    return `${btnBase} · ${mName} ${y}`;
  }

  const startBtn = document.getElementById('monthStartBtn');
  const endBtn   = document.getElementById('monthEndBtn');

  startBtn?.addEventListener('click', ()=>{
    makePopover({
      anchorBtn:startBtn,
      current: state.start,
      onPick:(ym,setMsg)=>{
        setMsg('');
        state.start = ym;
        if(state.end && state.end < state.start){
          setMsg(lang==='en' ? 'End is before start' : 'Slutt er før start');
        } else {
          startBtn.textContent = label('Start', state.start);
        }
      }
    });
  });

  endBtn?.addEventListener('click', ()=>{
    makePopover({
      anchorBtn:endBtn,
      current: state.end,
      onPick:(ym,setMsg)=>{
        setMsg('');
        if(state.start && ym < state.start){
          setMsg(lang==='en' ? 'Choose a month after Start' : 'Velg en måned etter Start');
          return;
        }
        state.end = ym;
        endBtn.textContent = label('Slutt', state.end);
      }
    });
  });

  window.dashboard = window.dashboard || {};
  window.dashboard.monthRange = {
    get start(){ return state.start },
    get end(){ return state.end }
  };
})();
  </script>
</body>
</html>
