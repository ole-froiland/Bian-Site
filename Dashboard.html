<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Scope Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" />
  <script>
    (function(){
      if(!window.DASHBOARD_API_BASE){
        const explicit = document.documentElement?.getAttribute('data-api-base') || document.body?.getAttribute('data-api-base');
        if(explicit){
          window.DASHBOARD_API_BASE = explicit;
        }else{
          const host = (typeof window !== 'undefined' && window.location) ? window.location.hostname : '';
          const isLocal = ['localhost','127.0.0.1','0.0.0.0','::1'].includes(host);
          if(isLocal){
            window.DASHBOARD_API_BASE = 'http://localhost:8888';
          }else if (typeof window !== 'undefined' && window.location && window.location.origin){
            window.DASHBOARD_API_BASE = window.location.origin;
          }else{
            window.DASHBOARD_API_BASE = 'https://din-side.netlify.app';
          }
        }
      }
    })();
  </script>
  <style>
    *,*::before,*::after{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      line-height:1.55;
      letter-spacing:0.01em;
      transition:background 0.3s ease,color 0.3s ease;
      /* Calmer indigo/slate palette (less purple) */
      --bg:#0b1020;                /* deep navy‑indigo */
      --surface:#141a2a;           /* neutral slate surface */
      --surface-raised:#1b2337;    /* raised surface */
      --border:rgba(148,163,184,0.22); /* cool slate border */
      --text:#e8ecf5;              /* soft off‑white */
      --text-strong:#ffffff;       /* strong text */
      --muted:#9aa6bd;             /* muted slate */
      --accent:#7d79f9;            /* subtle lilac accent */
      --accent-strong:#6c63d9;     /* deeper accent */
      --accent-soft:rgba(125,121,249,0.12); /* lighter glow */
      --positive:#34d399;
      --neutral:#fbbf24;
      --attention:#f87171;
      --brand-outline:rgba(125,121,249,0.4);
      --ring:0 0 0 3px rgba(125,121,249,0.55);
      --track-light:#ffffff;
      --track-dark:#374151;
      --card-radius:18px;
      color:var(--text);
      background:linear-gradient(180deg,rgba(21,27,44,0.95) 0%,rgba(16,23,39,0.98) 120px,var(--bg) 280px);
      min-height:100vh;
      color-scheme:dark;
    }
    body[data-theme="light"]{
      background:linear-gradient(180deg,#ffffff 0%,#f9fafd 120px,#f3f5fb 280px);
      --bg:#f6f7fb;                /* cool neutral */
      --surface:#ffffff;
      --surface-raised:#eef2ff;    /* very light indigo */
      --border:rgba(148,163,184,0.20);
      --text:#121826;              /* neutral indigo */
      --text-strong:#121826;
      --muted:#6b7280;
      --accent:#7d79f9;
      --accent-strong:#6c63d9;
      --accent-soft:rgba(125,121,249,0.10);
      --brand-outline:rgba(125,121,249,0.5);
      color-scheme:light;
    }
    h1,h2,h3,h4{margin:0;font-weight:600;color:var(--text-strong);}
    p{margin:0;}
    button{font:inherit;color:inherit;background:none;border:none;cursor:pointer;}
    button:focus-visible{outline:2px solid var(--accent);outline-offset:2px;}
    .shell{width:100%;max-width:1120px;margin:0 auto;padding-inline:clamp(16px,6vw,56px);}
    body[data-theme="light"] .top-bar{background:var(--bg);border-bottom:none;box-shadow:none;}
    .top-bar{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:none;box-shadow:none;padding-top:env(safe-area-inset-top,0);transition:transform .24s ease,opacity .2s ease;}
    body[data-theme="dark"] .top-bar{background:var(--bg);border-bottom:none;box-shadow:none;} 
    .top-bar[data-hidden="1"]{transform:translateY(-110%);opacity:0;} 
    .top-bar__inner{display:flex;align-items:center;gap:clamp(10px,3vw,28px);min-height:64px;font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;padding-inline:clamp(16px,4vw,64px);}
    .brand{display:flex;align-items:center;font-weight:800;color:#756bff;font-size:clamp(1.35rem,3vw,1.8rem);letter-spacing:0.05em;font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;text-transform:capitalize;margin-right:auto;}
    body[data-theme="light"] .brand{color:#625aff;}
    .brand-title{flex:1;text-align:center;font-size:clamp(1rem,2.5vw,1.3rem);font-weight:600;color:var(--text-strong);}
    .nav-actions{display:flex;align-items:center;gap:10px;font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;margin-left:auto;}
    .mobile-toggle{display:none;border:1px solid var(--brand-outline);border-radius:20px;padding:0 16px;height:40px;font-weight:700;background:var(--surface);color:var(--text-strong);cursor:pointer;box-shadow:0 1px 2px rgba(2,6,23,.08);font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;align-items:center;gap:6px;}
    .mobile-toggle .dots{display:flex;flex-direction:column;gap:3px;margin-right:2px;}
    .mobile-toggle .dots span{width:14px;height:2px;border-radius:999px;background:currentColor;display:block;}
    .mobile-toggle:focus-visible{outline:none;box-shadow:var(--ring);} 
    .nav-controls{display:flex;align-items:center;gap:10px;}
    .chip{border:1px solid var(--brand-outline);border-radius:999px;padding:0 18px;height:40px;min-width:56px;font-weight:700;background:var(--surface);color:inherit;text-decoration:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:0.95rem;letter-spacing:.02em;box-shadow:0 1px 2px rgba(2,6,23,.06);transition:background-color .2s ease,border-color .2s ease,color .2s ease,transform .2s ease;will-change:background-color,border-color,color;backface-visibility:hidden;transform:translateZ(0);font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;}
    .chip:focus-visible{outline:none;box-shadow:var(--ring);}
    .chip:hover{transform:translateY(-1px);border-color:var(--accent);background:var(--accent-soft);} 
    body[data-theme="dark"] .chip{background:var(--surface-raised);color:var(--text);border-color:rgba(125,121,249,0.45);} 
    body[data-theme="dark"] .nav-actions .chip,
    body[data-theme="dark"] .nav-controls .chip{background:rgba(23,30,48,0.96);border-color:rgba(125,121,249,0.4);} 
    .nav-actions .chip{height:40px;padding:0 16px;border-radius:999px;min-width:56px;font-size:0.95rem;}
    .nav-actions .chip.user-menu__trigger{padding:0;min-width:42px;height:42px;}
    .nav-actions .chip:not(.user-menu__trigger){min-width:56px;}
    .user-menu{position:relative;}
    .user-menu__trigger{width:42px;height:42px;min-width:42px;padding:0;border-radius:20px;border:1px solid var(--brand-outline);background:var(--surface);display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(15,23,42,0.2);transition:background .22s ease,border-color .22s ease,transform .22s ease;}
    .user-menu__trigger:hover{transform:translateY(-1px);border-color:var(--accent);background:var(--accent-soft);}
    body[data-theme="light"] .user-menu__trigger{background:#ffffff;box-shadow:0 10px 18px rgba(31,41,55,0.08);} 
    body[data-theme="light"] .user-menu__trigger:hover{background:#f4f5ff;}
    .user-menu__icon{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;}
    .user-menu__icon span{display:block;width:18px;height:2px;border-radius:999px;background:var(--text);transition:background .22s ease;}
    .user-menu.open .user-menu__icon span{background:var(--accent-strong);}
    .user-menu__panel{position:absolute;top:calc(100% + 12px);right:0;min-width:220px;background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 40px rgba(12,18,32,0.24);padding:10px 0;opacity:0;visibility:hidden;transform:translateY(-6px);transition:opacity .18s ease,transform .18s ease,visibility .18s ease;z-index:30;}
    body[data-theme="dark"] .user-menu__panel{background:var(--surface-raised);}
    .user-menu.open .user-menu__panel{opacity:1;visibility:visible;transform:translateY(0);}
    .user-menu__section-title{font-size:12px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);padding:6px 18px 4px;}
    .user-menu__item{width:100%;padding:10px 18px;text-align:left;background:none;border:none;font:inherit;color:var(--text);display:flex;align-items:center;gap:10px;cursor:pointer;text-decoration:none;transition:background .18s ease,color .18s ease;}
    .user-menu__item:hover{background:var(--accent-soft);color:var(--accent-strong);}
    .user-menu__item:focus-visible{outline:none;background:var(--accent-soft);color:var(--accent-strong);}
    .user-menu__item--danger{color:var(--attention);}
    .user-menu__item--danger:hover,
    .user-menu__item--danger:focus-visible{background:rgba(248,113,113,0.12);color:var(--attention);}
    .user-menu__separator{height:1px;background:var(--border);margin:8px 0;}
    /* Landing-page style theme switch */
    .theme-switch{position:relative;display:inline-flex;width:54px;height:30px;}
    .theme-switch input{opacity:0;width:0;height:0;}
    .theme-switch .slider{position:relative;cursor:pointer;display:block;width:100%;height:100%;background:var(--track-light);transition:background-color .20s ease,border-color .20s ease,left .20s ease,transform .20s ease;border-radius:9999px;box-shadow:0 1px 2px rgba(0,0,0,.15);border:1px solid var(--brand-outline);padding:2px;backface-visibility:hidden;transform:translateZ(0);} 
    .theme-switch input:focus-visible + .slider{box-shadow:var(--ring);} 
    body[data-theme="dark"] .theme-switch .slider{background:var(--track-dark);box-shadow:0 1px 2px rgba(255,255,255,.18);} 
    .theme-switch .thumb{position:absolute;top:50%;left:2px;width:24px;height:24px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background-color .20s ease,border-color .20s ease,left .20s ease,transform .20s ease;border:1px solid var(--brand-outline);box-shadow:0 2px 4px rgba(0,0,0,.2);transform:translateY(-50%) translateZ(0);backface-visibility:hidden;} 
    .theme-switch .icon{width:16px;height:16px;stroke-width:2;} 
    .theme-switch .icon.sun{stroke:#FDB813;fill:none;} 
    .theme-switch .icon.moon{fill:#20354a;stroke:none;display:none;} 
    .theme-switch input:checked + .slider{background:var(--accent);} 
    .theme-switch input:checked + .slider .thumb{left:calc(100% - 2px);transform:translate(-100%,-50%) translateZ(0);} 
    .theme-switch input:checked + .slider .icon.sun{display:none;} 
    .theme-switch input:checked + .slider .icon.moon{display:block;} 
    .sub-nav{background:var(--bg);border-top:none;box-shadow:none;padding:0;}
    body[data-theme="light"] .sub-nav{background:var(--bg);}
    body[data-theme="dark"] .sub-nav{background:var(--bg);}
    .tablist{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;padding-inline:clamp(12px,4vw,48px);}
    .tab-button{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:var(--surface);font-size:0.95rem;font-weight:600;letter-spacing:0.02em;transition:background 0.25s ease,border-color 0.25s ease,box-shadow 0.25s ease,transform 0.25s ease;}
    .tab-button:hover{border-color:var(--accent);background:var(--surface-raised);transform:translateY(-1px);}
    .tab-button.active{background:var(--accent-soft);border-color:var(--accent);box-shadow:0 12px 24px rgba(125,121,249,0.18);} 
    main{width:100%;padding:clamp(24px,6vw,48px) 0 clamp(56px,10vw,96px);background:var(--bg);}
    .tab-panel{display:none;gap:clamp(18px,4vw,32px);}
    .tab-panel.active{display:grid;}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--card-radius);padding:clamp(18px,3vw,28px);box-shadow:0 24px 40px rgba(8,15,35,0.32);}
    .card header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:clamp(14px,2vw,20px);}
    .stats-grid{display:grid;gap:clamp(16px,3vw,24px);grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
    .stat-number{font-size:clamp(1.8rem,4vw,2.7rem);font-weight:700;color:var(--text-strong);margin-top:4px;}
    .stat-sub{margin-top:10px;font-size:0.95rem;color:var(--accent);}
    .table-scroll{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:0.95rem;min-width:280px;}
    thead th{text-align:left;font-size:0.75rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);padding-bottom:10px;}
    tbody tr{border-top:1px solid var(--border);transition:background 0.25s ease;}
    tbody tr:first-child{border-top:none;}
    tbody tr:hover{background:rgba(148,163,184,0.08);}
    td,th{padding:12px 0;}
    td:last-child,th:last-child{text-align:right;}
    .chart-card{position:relative;}
    .chart-card .bar-chart{position:relative;display:grid;grid-template-columns:repeat(auto-fit,minmax(46px,1fr));gap:14px;align-items:end;height:240px;margin-top:18px;padding-bottom:18px;}
    .chart-card .bar-chart[data-empty="1"]{display:flex;align-items:center;justify-content:center;height:auto;min-height:120px;flex-direction:column;gap:6px;}
    .bar-chart__empty{font-size:0.9rem;color:var(--muted);text-align:center;}
    .chart-card .bar-chart[data-demo="1"]::after{
      content:'Viser demo-data. Sett Lightspeed-nøkler i Netlify for ekte tall.';
      position:absolute;inset:auto 0 0;transform:translateY(18px);
      font-size:0.7rem;color:var(--muted);text-align:center;
    }
    .bar-chart .bar{display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:10px;text-align:center;color:var(--muted);height:100%;}
    .bar-chart .bar__column{width:100%;min-height:6px;border-radius:18px 18px 12px 12px;background:linear-gradient(180deg,var(--accent),var(--accent-strong));box-shadow:0 12px 30px rgba(14,165,233,0.25);transition:transform 0.25s ease;height:var(--height,6px);cursor:pointer;outline:none;}
    .bar-chart .bar__column:focus-visible{outline:2px solid var(--accent);outline-offset:2px;}
    .bar-chart .bar__column--zero{background:linear-gradient(180deg,rgba(148,163,184,0.4),rgba(99,102,241,0.35));box-shadow:none;opacity:0.6;}
    .bar-chart .bar__column:hover{transform:translateY(-4px);}
    .bar-chart .bar__label{display:flex;flex-direction:column;align-items:center;gap:2px;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;}
    .bar-chart .bar__label strong{font-weight:700;}
    .bar-chart .bar__label small{font-size:0.68rem;text-transform:none;letter-spacing:0.04em;color:var(--muted);}
    .chart-nav{display:flex;align-items:center;gap:8px;}
    .chart-nav__btn{width:32px;height:28px;border-radius:10px;border:1px solid var(--border);background:var(--surface-raised);color:inherit;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;transition:background 0.2s ease,border-color 0.2s ease,transform 0.2s ease;cursor:pointer;}
    .chart-nav__btn:hover:not(:disabled){background:var(--accent-soft);border-color:var(--accent);transform:translateY(-1px);}
    .chart-nav__btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
    .chart-tooltip{position:absolute;min-width:120px;max-width:220px;padding:8px 12px;border-radius:10px;background:rgba(28,35,56,0.92);color:#f8f9ff;font-size:0.75rem;font-weight:600;letter-spacing:0.01em;box-shadow:0 12px 32px rgba(15,23,42,0.45);pointer-events:none;opacity:0;transform:translate(-50%, -12px);transition:opacity 0.15s ease, transform 0.15s ease;z-index:3;}
    .chart-tooltip[data-visible="1"]{opacity:1;transform:translate(-50%, -16px);}
    .daily-summary-card{background:none;border:none;box-shadow:none;padding:0;border-radius:0;}
    .daily-summary-card header{margin-bottom:16px;}
    .daily-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px;align-items:stretch;}
    .daily-summary__controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .daily-summary__input{padding:8px 12px;border-radius:12px;border:1px solid rgba(148,163,184,0.28);background:rgba(17,24,39,0.65);color:inherit;font:inherit;box-shadow:inset 0 1px 2px rgba(15,23,42,0.25);}
    .daily-summary__input:focus-visible{outline:none;box-shadow:var(--ring);}
    body[data-theme="light"] .daily-summary__input{background:rgba(255,255,255,0.9);color:var(--text);border:1px solid rgba(148,163,184,0.34);box-shadow:inset 0 1px 2px rgba(148,163,184,0.18);}
    .daily-summary__status{grid-column:1/-1;font-size:0.85rem;color:var(--muted);margin-top:4px;}
    .summary-card{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--card-radius);padding:28px 32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;box-shadow:0 24px 40px rgba(8,15,35,0.28);position:relative;overflow:hidden;min-height:220px;text-align:center;color:inherit;}
    .summary-card::after{content:'';position:absolute;inset:0;border-radius:inherit;background:linear-gradient(145deg,rgba(125,121,249,0.12),rgba(99,102,241,0.08));opacity:0;transition:opacity 0.25s ease;z-index:-1;}
    .summary-card:hover::after{opacity:1;}
    .summary-card__label{text-transform:uppercase;font-size:1rem;letter-spacing:0.22em;color:rgba(203,213,225,0.9);font-weight:800;margin:0;}
    .summary-card__value{font-size:clamp(1.8rem,2.8vw,2.4rem);font-weight:700;margin:0;color:var(--text-strong);letter-spacing:-0.01em;}
    .summary-card__value.fade{color:rgba(203,213,225,0.6);}
    .summary-card__meta{font-size:0.9rem;color:rgba(203,213,225,0.78);}
    body[data-theme="light"] .summary-card{box-shadow:0 18px 32px rgba(148,163,184,0.26);}
    body[data-theme="light"] .summary-card__label{color:rgba(45,55,72,0.85);}
    body[data-theme="light"] .summary-card__value{color:var(--text-strong);}
    body[data-theme="light"] .summary-card__value.fade{color:rgba(100,116,139,0.55);}
    body[data-theme="light"] .summary-card__meta{color:rgba(71,85,105,0.74);}
    .summary-card__meta strong{color:#f8f9ff;font-weight:600;}
    .ai-insights-card header{align-items:flex-start;gap:12px;}
    .ai-insights__meta{margin-left:auto;font-size:0.9rem;color:var(--muted);display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .ai-insights__input{min-width:160px;}
    .ai-insights{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:22px;margin-top:18px;}
    .ai-insights__column h3{margin:0 0 12px;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.14em;color:rgba(203,213,225,0.75);font-weight:700;}
    .ai-insights__list{list-style:none;margin:0;padding:0;display:grid;gap:12px;}
    .ai-insights__item{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:14px 16px;border-radius:16px;background:var(--surface-raised);border:1px solid rgba(148,163,184,0.18);box-shadow:0 16px 28px rgba(15,23,42,0.22);}
    .ai-insights__product{font-weight:600;color:var(--text-strong);flex:1;min-width:0;word-break:break-word;}
    .ai-insights__metric{font-size:0.88rem;color:var(--muted);text-align:right;white-space:nowrap;}
    .ai-insights__status{margin-top:22px;font-size:0.9rem;color:var(--muted);}
    .ai-insights__status[data-tone="demo"]{color:var(--accent);}
    .ai-insights__status[data-tone="error"]{color:var(--attention);}
    body[data-theme="light"] .ai-insights__column h3{color:rgba(51,65,85,0.75);}
    body[data-theme="light"] .ai-insights__item{background:rgba(255,255,255,0.9);border-color:rgba(148,163,184,0.26);box-shadow:0 12px 26px rgba(148,163,184,0.28);}
    body[data-theme="light"] .ai-insights__metric{color:rgba(71,85,105,0.75);}
    .revenue-card{margin-top:24px;padding:24px;border-radius:20px;background:var(--surface-raised);border:1px solid rgba(148,163,184,0.16);box-shadow:0 16px 30px rgba(15,23,42,0.2);display:flex;flex-direction:column;gap:18px;}
    .revenue-card header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;}
    .revenue-card__title{margin:0;font-size:1.1rem;font-weight:600;color:var(--text-strong);}
    .revenue-card__meta{display:flex;gap:12px;font-size:0.9rem;color:var(--muted);flex-wrap:wrap;}
    .revenue-card__grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .revenue-card__stat{display:flex;flex-direction:column;gap:6px;padding:12px 14px;border-radius:16px;background:rgba(15,23,42,0.28);border:1px solid rgba(148,163,184,0.14);}
    .revenue-card__label{font-size:0.85rem;text-transform:uppercase;letter-spacing:0.14em;color:rgba(203,213,225,0.75);font-weight:600;}
    .revenue-card__value{font-size:1.2rem;font-weight:700;color:var(--text-strong);}
    .revenue-card__delta{font-size:0.92rem;color:var(--muted);}
    .revenue-card__delta[data-tone="up"]{color:#34d399;}
    .revenue-card__delta[data-tone="down"]{color:#f87171;}
    .revenue-card__delta[data-tone="flat"]{color:var(--muted);}
    .revenue-card__value[data-tone="up"]{color:#34d399;}
    .revenue-card__value[data-tone="down"]{color:#f87171;}
    .revenue-card__value[data-tone="flat"]{color:var(--text-strong);}
    .revenue-card__note{margin:0;font-size:0.92rem;color:var(--muted);}
    body[data-theme="light"] .revenue-card{background:rgba(255,255,255,0.95);border-color:rgba(148,163,184,0.24);box-shadow:0 14px 26px rgba(148,163,184,0.22);}
    body[data-theme="light"] .revenue-card__stat{background:rgba(99,102,241,0.06);border-color:rgba(148,163,184,0.18);}
    body[data-theme="light"] .revenue-card__label{color:rgba(71,85,105,0.68);}
    .product-change-card{margin-top:24px;padding:24px;border-radius:20px;background:var(--surface-raised);border:1px solid rgba(148,163,184,0.16);box-shadow:0 16px 30px rgba(15,23,42,0.2);display:flex;flex-direction:column;gap:18px;}
    .product-change-card header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;}
    .product-change-card__title{margin:0;font-size:1.1rem;font-weight:600;color:var(--text-strong);}
    .product-change-card__meta{display:flex;gap:12px;font-size:0.9rem;color:var(--muted);flex-wrap:wrap;}
    .product-change-card__columns{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .product-change-card__column h3{margin:0 0 10px;font-size:0.93rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(203,213,225,0.75);font-weight:700;}
    .product-change-card__list{list-style:none;margin:0;padding:0;display:grid;gap:10px;}
    .product-change-card__item{display:flex;justify-content:space-between;gap:12px;padding:14px 16px;border-radius:16px;background:rgba(15,23,42,0.28);border:1px solid rgba(148,163,184,0.14);}
    .product-change-card__name{font-weight:600;color:var(--text-strong);flex:1;min-width:0;word-break:break-word;}
    .product-change-card__metrics{font-size:0.9rem;text-align:right;color:var(--muted);white-space:nowrap;}
    .product-change-card__status{margin:0;font-size:0.92rem;color:var(--muted);}
    .product-change-card__item[data-tone="up"] .product-change-card__metrics{color:#34d399;}
    .product-change-card__item[data-tone="down"] .product-change-card__metrics{color:#f87171;}
    body[data-theme="light"] .product-change-card{background:rgba(255,255,255,0.95);border-color:rgba(148,163,184,0.24);box-shadow:0 14px 26px rgba(148,163,184,0.22);}
    body[data-theme="light"] .product-change-card__column h3{color:rgba(71,85,105,0.64);}
    body[data-theme="light"] .product-change-card__item{background:rgba(99,102,241,0.06);border-color:rgba(148,163,184,0.18);}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    @media (max-width:720px){
      .top-bar__inner{padding-inline:clamp(14px,7vw,24px);min-height:56px;gap:12px;justify-content:flex-start;}
      .brand{font-size:1.4rem;margin-right:auto;}
      .brand-title{display:none;}
      .nav-actions{gap:8px;align-items:center;margin-left:auto;}
      .mobile-toggle{display:inline-flex;order:2;height:36px;font-size:0.88rem;padding:0 14px;border-radius:18px;box-shadow:0 12px 24px rgba(45,55,72,0.16);background:#fff;color:#0b1220;}
      body[data-theme="dark"] .mobile-toggle{background:#0f172a;color:#f8fafc;border-color:rgba(148,163,184,0.45);}
      .mobile-toggle .dots span{width:16px;}
      .nav-controls{display:none;width:100%;flex-direction:column;align-items:stretch;gap:6px;margin-top:6px;background:var(--surface);padding:8px;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 20px rgba(2,6,23,0.1);}
      .nav-controls.open{display:flex;}
      .nav-controls .chip{width:100%;justify-content:center;height:32px;min-width:0;padding:0 10px;font-size:0.82rem;}
      .nav-actions .theme-switch{display:none;}
      .nav-controls .theme-switch{width:48px;height:30px;align-self:center;}
      .nav-controls .theme-switch .slider{padding:2px;}
      .nav-controls .theme-switch .thumb{width:20px;height:20px;left:2px;}
      .nav-controls .theme-switch input:checked + .slider .thumb{left:calc(100% - 2px);} 
    }
    @media (max-width:960px){
      .brand-title{font-size:1.15rem;}
      .tablist{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media (max-width:760px){
      .sub-nav{padding-top:18px;}
      .tablist{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
      .daily-summary{grid-template-columns:1fr;justify-content:stretch;}
      .summary-card{max-width:none;}
      .ai-insights{grid-template-columns:1fr;}
      .ai-insights__meta{justify-content:flex-start;align-items:stretch;}
      .ai-insights__input{width:100%;min-width:0;}
      .ai-insights__item{flex-direction:column;align-items:flex-start;gap:8px;padding:16px 18px;}
      .ai-insights__metric{width:100%;text-align:left;white-space:normal;}
      .revenue-card{padding:20px;}
    }
    @media (max-width:520px){
      .shell{padding-inline:16px;}
      .tablist{grid-template-columns:1fr;}
      .tab-button{text-align:center;}
    }
    @media (prefers-reduced-motion:reduce){
      *,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;scroll-behavior:auto!important;}
    }
  </style>
</head>
<body data-theme="dark">
  <header class="top-bar">
    <div class="shell top-bar__inner">
      <div class="brand">Scope</div>
      <div class="brand-title">Gressholmen Kro</div>
      <div class="nav-actions">
        <div class="user-menu" data-menu>
          <button type="button" id="user-menu-trigger" class="chip user-menu__trigger" aria-haspopup="true" aria-expanded="false" aria-controls="user-menu-panel" aria-label="Konto og innstillinger">
            <span class="sr-only">Din konto</span>
            <span class="user-menu__icon" aria-hidden="true">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </button>
          <div class="user-menu__panel" id="user-menu-panel" role="menu" aria-labelledby="user-menu-trigger" hidden>
            <div class="user-menu__section-title">Konto</div>
            <button type="button" class="user-menu__item" role="menuitem">Betaling &amp; faktura</button>
            <button type="button" class="user-menu__item" role="menuitem">Innstillinger</button>
            <div class="user-menu__separator" role="presentation"></div>
            <button type="button" class="user-menu__item user-menu__item--danger" role="menuitem">Logg ut</button>
          </div>
        </div>
        <button class="mobile-toggle" aria-expanded="false" aria-controls="dash-controls" data-i18n-attr="aria-label:mobile.menu_button">
          <span class="dots" aria-hidden="true"><span></span><span></span><span></span></span>
          <span data-i18n="mobile.menu_button">Meny</span>
        </button>
        <div class="nav-controls" id="dash-controls">
          <button type="button" class="chip" aria-label="Bytt til engelsk">EN</button>
          <label class="theme-switch mobile-theme-switch" aria-label="Bytt tema">
            <input type="checkbox" id="dash-theme-toggle" aria-label="Tema" />
            <span class="slider">
              <span class="thumb">
                <svg class="icon sun" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="5" />
                  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <svg class="icon moon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" />
                </svg>
              </span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </header>
  <nav class="sub-nav">
    <div class="shell tablist" role="tablist" aria-label="Dashboard faner">
      <button class="tab-button active" id="tab-kpi" type="button" role="tab" aria-selected="true" aria-controls="kpi" data-tab-target="kpi" tabindex="0">KPI-er</button>
      <button class="tab-button" id="tab-oversikt" type="button" role="tab" aria-selected="false" aria-controls="oversikt" data-tab-target="oversikt" tabindex="-1">Oversikt</button>
      <button class="tab-button" id="tab-ai" type="button" role="tab" aria-selected="false" aria-controls="ai-tips" data-tab-target="ai-tips" tabindex="-1">AI-tips</button>
    </div>
    
  </nav>
  <main class="shell">
    <section class="tab-panel active" id="kpi" role="tabpanel" aria-labelledby="tab-kpi" tabindex="0">
      <div class="stats-grid">
        <article class="card stat">
          <h2>Daglig omsetning</h2>
          <p class="stat-number">134&nbsp;560 kr</p>
          <p class="stat-sub">+12% siden i går</p>
        </article>
        <article class="card stat">
          <h2>Gjennomsnittlig besøk</h2>
          <p class="stat-number">286 gjester</p>
          <p class="stat-sub">+8% siste uke</p>
        </article>
        <article class="card stat">
          <h2>Snittordre</h2>
          <p class="stat-number">472 kr</p>
          <p class="stat-sub">+5% siste 14 dager</p>
        </article>
      </div>
      <article class="card table-card">
        <header>
          <h2>Topp 3 produkter</h2>
        </header>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Produkt</th>
                <th>Solgt</th>
                <th>Andel</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Grillet kveite</td>
                <td>184</td>
                <td>32%</td>
              </tr>
              <tr>
                <td>Fersk blåskjell</td>
                <td>156</td>
                <td>27%</td>
              </tr>
              <tr>
                <td>Bryggens burger</td>
                <td>142</td>
                <td>24%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </section>
    <section class="tab-panel" id="oversikt" role="tabpanel" aria-labelledby="tab-oversikt" tabindex="0" hidden>
      <article class="card chart-card">
        <header>
          <h2>Omsetning (14 dager)</h2>
          <div class="chart-nav">
            <button type="button" class="chart-nav__btn" data-chart-nav="prev" aria-label="Forrige 14 dager">‹</button>
            <button type="button" class="chart-nav__btn" data-chart-nav="next" aria-label="Neste 14 dager">›</button>
          </div>
        </header>
        <div class="bar-chart" data-daily-chart role="img" aria-live="polite" aria-label="Omsetning siste 14 dager"></div>
        <div class="chart-tooltip" data-chart-tooltip hidden></div>
      </article>
      <article class="card daily-summary-card">
        <header>
          <h2 data-day-heading>Dagens omsetning</h2>
          <div class="daily-summary__controls">
            <label for="sales-day-picker" class="sr-only">Velg dato</label>
            <input type="date" id="sales-day-picker" class="daily-summary__input" />
          </div>
        </header>
        <div class="daily-summary">
          <article class="summary-card">
            <span class="summary-card__label">Omsetning</span>
            <p class="summary-card__value" data-day-revenue>–</p>
          </article>
          <article class="summary-card">
            <span class="summary-card__label">Antall kvitteringer</span>
            <p class="summary-card__value" data-day-receipts>–</p>
          </article>
          <article class="summary-card">
            <span class="summary-card__label">Snitt per kjøp</span>
            <p class="summary-card__value" data-day-average>–</p>
          </article>
        </div>
      </article>
      <article class="card table-card">
        <header>
          <h2>Omsetning per dag</h2>
        </header>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Dato</th>
                <th>Omsetning</th>
                <th>Gjester</th>
              </tr>
            </thead>
            <tbody id="daily-sales-body">
              <tr class="demo-row">
                <td>12. mai</td>
                <td>128&nbsp;900 kr</td>
                <td>302</td>
              </tr>
              <tr class="demo-row">
                <td>11. mai</td>
                <td>142&nbsp;100 kr</td>
                <td>318</td>
              </tr>
              <tr class="demo-row">
                <td>10. mai</td>
                <td>119&nbsp;450 kr</td>
                <td>276</td>
              </tr>
              <tr class="demo-row">
                <td>9. mai</td>
                <td>105&nbsp;780 kr</td>
                <td>244</td>
              </tr>
              <tr class="demo-row">
                <td>8. mai</td>
                <td>131&nbsp;060 kr</td>
                <td>289</td>
              </tr>
              <tr class="demo-row">
                <td>7. mai</td>
                <td>138&nbsp;500 kr</td>
                <td>310</td>
              </tr>
              <tr class="demo-row">
                <td>6. mai</td>
                <td>114&nbsp;230 kr</td>
                <td>268</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </section>
    <section class="tab-panel" id="ai-tips" role="tabpanel" aria-labelledby="tab-ai" tabindex="0" hidden>
      <article class="card ai-insights-card">
        <header>
          <h2>AI-tips</h2>
          <div class="ai-insights__meta">
            <span data-ai-products-date>–</span>
            <label for="ai-products-picker" class="sr-only">Velg dato for AI-tips</label>
            <input type="date" id="ai-products-picker" class="daily-summary__input ai-insights__input" />
          </div>
        </header>
        <div class="ai-insights" data-ai-insights>
          <div class="ai-insights__column">
            <h3>Mest solgte produkter</h3>
            <ul class="ai-insights__list" data-ai-top-list></ul>
          </div>
          <div class="ai-insights__column">
            <h3>Minst solgte produkter</h3>
            <ul class="ai-insights__list" data-ai-bottom-list></ul>
          </div>
        </div>
        <p class="ai-insights__status" data-ai-products-status></p>
      </article>
      <article class="revenue-card" data-revenue-card>
        <header>
          <h2 class="revenue-card__title">Omsetningsanalyse</h2>
          <div class="revenue-card__meta">
            <span data-revenue-date>–</span>
            <span data-revenue-comparison>–</span>
          </div>
        </header>
        <div class="revenue-card__grid">
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Omsetning</span>
            <strong class="revenue-card__value" data-revenue-current>–</strong>
            <span class="revenue-card__delta" data-revenue-current-note></span>
          </div>
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Mot forrige uke</span>
            <strong class="revenue-card__value" data-revenue-week-delta>–</strong>
            <span class="revenue-card__delta" data-revenue-week-note></span>
          </div>
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Mot månedssnitt</span>
            <strong class="revenue-card__value" data-revenue-month-delta>–</strong>
            <span class="revenue-card__delta" data-revenue-month-note></span>
          </div>
        </div>
        <p class="revenue-card__note" data-revenue-status></p>
      </article>
      <article class="product-change-card" data-product-change-card>
        <header>
          <h2 class="product-change-card__title">Produktendringer</h2>
          <div class="product-change-card__meta">
            <span data-product-change-date>–</span>
            <span data-product-change-compare>–</span>
          </div>
        </header>
        <div class="product-change-card__columns">
          <div class="product-change-card__column">
            <h3>Størst vekst</h3>
            <ul class="product-change-card__list" data-product-change-up></ul>
          </div>
          <div class="product-change-card__column">
            <h3>Størst nedgang</h3>
            <ul class="product-change-card__list" data-product-change-down></ul>
          </div>
        </div>
        <p class="product-change-card__status" data-product-change-status></p>
      </article>
    </section>
  </main>
  <script>
    (function() {
      const buttons = Array.from(document.querySelectorAll('.tab-button'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));

      function activateTab(targetId) {
        buttons.forEach((btn) => {
          const isActive = btn.dataset.tabTarget === targetId;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
          btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });

        panels.forEach((panel) => {
          const isMatch = panel.id === targetId;
          panel.classList.toggle('active', isMatch);
          panel.toggleAttribute('hidden', !isMatch);
        });

      }

      // simple tab controller for switching dashboard sections
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
        btn.addEventListener('keydown', (event) => {
          const index = buttons.indexOf(btn);
          if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
            event.preventDefault();
            const direction = event.key === 'ArrowRight' ? 1 : -1;
            const nextIndex = (index + direction + buttons.length) % buttons.length;
            buttons[nextIndex].focus();
          } else if (event.key === 'Home') {
            event.preventDefault();
            buttons[0].focus();
          } else if (event.key === 'End') {
            event.preventDefault();
            buttons[buttons.length - 1].focus();
          }
        });
      });

      const defaultTab = buttons.find((btn) => btn.classList.contains('active'))?.dataset.tabTarget || buttons[0]?.dataset.tabTarget;
      if (defaultTab) {
        activateTab(defaultTab);
      }

      const moneyFmt = new Intl.NumberFormat('nb-NO', { style: 'currency', currency: 'NOK', maximumFractionDigits: 0 });
      const qtyFmt = new Intl.NumberFormat('nb-NO', { maximumFractionDigits: 0 });
      const percentFmt = new Intl.NumberFormat('nb-NO', { style: 'percent', maximumFractionDigits: 0 });
      const dateFmtShort = new Intl.DateTimeFormat('nb-NO', { day: 'numeric', month: 'short' });
      const dateFmtLong = new Intl.DateTimeFormat('nb-NO', { weekday: 'short', day: 'numeric', month: 'short' });

      const apiBase = window.DASHBOARD_API_BASE || (
        (window.location && window.location.origin) ? window.location.origin : 'http://localhost:8888'
      );

      const toISODate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const today = new Date();
      const todayISO = toISODate(today);

      const dayPicker = document.querySelector('#sales-day-picker');
      const dayHeadingEl = document.querySelector('[data-day-heading]');
      const dayRevenueEl = document.querySelector('[data-day-revenue]');
      const dayReceiptsEl = document.querySelector('[data-day-receipts]');
      const dayAverageEl = document.querySelector('[data-day-average]');
      const dayStatusEl = document.querySelector('[data-day-status]');
      const barChart = document.querySelector('[data-daily-chart]');
      const chartPrevBtn = document.querySelector('[data-chart-nav="prev"]');
      const chartNextBtn = document.querySelector('[data-chart-nav="next"]');
      const chartTooltip = document.querySelector('[data-chart-tooltip]');
      const chartCard = barChart ? barChart.closest('.chart-card') : null;
      const weekdayFmt = new Intl.DateTimeFormat('nb-NO', { weekday: 'short' });
      const chartDateFmt = new Intl.DateTimeFormat('nb-NO', { day: '2-digit', month: '2-digit' });
      const aiTopListEl = document.querySelector('[data-ai-top-list]');
      const aiBottomListEl = document.querySelector('[data-ai-bottom-list]');
      const aiProductsStatusEl = document.querySelector('[data-ai-products-status]');
      const aiProductsDateEl = document.querySelector('[data-ai-products-date]');
      const aiProductsPicker = document.querySelector('#ai-products-picker');
      const revenueCardEl = document.querySelector('[data-revenue-card]');
      const revenueDateEl = document.querySelector('[data-revenue-date]');
      const revenueComparisonEl = document.querySelector('[data-revenue-comparison]');
      const revenueCurrentEl = document.querySelector('[data-revenue-current]');
      const revenueCurrentNoteEl = document.querySelector('[data-revenue-current-note]');
      const revenueWeekDeltaEl = document.querySelector('[data-revenue-week-delta]');
      const revenueWeekNoteEl = document.querySelector('[data-revenue-week-note]');
      const revenueMonthDeltaEl = document.querySelector('[data-revenue-month-delta]');
      const revenueMonthNoteEl = document.querySelector('[data-revenue-month-note]');
      const revenueStatusEl = document.querySelector('[data-revenue-status]');
      let chartDataAll = [];
      let chartDataMap = new Map();
      let chartCursorDate = null;
      let chartLatestDate = todayISO;
      let chartOldestDate = todayISO;
      let chartIsDemo = false;
      let revenueAnalysisContext = { date: null, fallbackDaily: [], entry: null };
      const productChangeCardEl = document.querySelector('[data-product-change-card]');
      const productChangeDateEl = document.querySelector('[data-product-change-date]');
      const productChangeCompareEl = document.querySelector('[data-product-change-compare]');
      const productChangeUpEl = document.querySelector('[data-product-change-up]');
      const productChangeDownEl = document.querySelector('[data-product-change-down]');
      const productChangeStatusEl = document.querySelector('[data-product-change-status]');
      let productChangeContext = { date: null, items: [], options: {}, isDemo: false };

      const renderDayStatus = (message, tone = 'muted') => {
        if (!dayStatusEl) return;
        dayStatusEl.textContent = message || '';
        dayStatusEl.dataset.tone = tone;
      };

      const setAiProductsStatus = (message = '', tone = '') => {
        if (!aiProductsStatusEl) return;
        aiProductsStatusEl.textContent = message || '';
        if (tone) {
          aiProductsStatusEl.dataset.tone = tone;
        } else {
          aiProductsStatusEl.removeAttribute('data-tone');
        }
      };

      const buildProductListItem = ({ name, revenue, quantity }) => {
        const itemEl = document.createElement('li');
        itemEl.className = 'ai-insights__item';
        const nameEl = document.createElement('span');
        nameEl.className = 'ai-insights__product';
        nameEl.textContent = name;
        const metricEl = document.createElement('span');
        metricEl.className = 'ai-insights__metric';
        const parts = [];
        const safeRevenue = Number.isFinite(revenue) ? revenue : 0;
        parts.push(moneyFmt.format(safeRevenue));
        if (Number.isFinite(quantity) && quantity > 0) {
          parts.push(`${qtyFmt.format(quantity)} stk`);
        }
        metricEl.textContent = parts.join(' • ');
        itemEl.append(nameEl, metricEl);
        return itemEl;
      };

      const sanitizeIso = (iso) => {
        if (!iso) return null;
        const value = String(iso).trim();
        return /^\d{4}-\d{2}-\d{2}$/.test(value) ? value : null;
      };

      const parseIsoDate = (iso) => {
        const clean = sanitizeIso(iso);
        if (!clean) return null;
        const parsed = new Date(`${clean}T00:00:00`);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      };

      const formatFriendlyDate = (iso) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return '–';
        const formatted = dateFmtLong.format(parsed);
        return formatted.charAt(0).toUpperCase() + formatted.slice(1);
      };

      const shiftIsoDate = (iso, delta) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return null;
        const shifted = new Date(parsed);
        shifted.setDate(parsed.getDate() + delta);
        return toISODate(shifted);
      };

      const formatSignedCurrency = (value) => {
        if (!Number.isFinite(value)) return '–';
        if (value === 0) return moneyFmt.format(0);
        const abs = Math.abs(value);
        const formatted = moneyFmt.format(abs);
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const formatSignedPercent = (value) => {
        if (!Number.isFinite(value)) return null;
        if (value === 0) return '0 %';
        const formatted = percentFmt.format(Math.abs(value));
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const setDeltaTone = (el, value) => {
        if (!el) return;
        if (!Number.isFinite(value)) {
          el.dataset.tone = 'flat';
          return;
        }
        if (value === 0) {
          el.dataset.tone = 'flat';
        } else {
          el.dataset.tone = value > 0 ? 'up' : 'down';
        }
      };

      const formatSignedQuantity = (value) => {
        if (!Number.isFinite(value) || value === 0) return value === 0 ? '0' : null;
        const formatted = qtyFmt.format(Math.abs(value));
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const normalizeProductItems = (items = []) => {
        const map = new Map();
        items.forEach((entry) => {
          if (!entry) return;
          const name = String(entry?.name || '').trim();
          if (!name) return;
          const key = name.toLowerCase();
          const revenue = Number(entry?.revenue || 0);
          const quantity = Number(entry?.quantity ?? entry?.qty ?? 0);
          const existing = map.get(key) || { name, revenue: 0, quantity: 0 };
          existing.revenue += Number.isFinite(revenue) ? revenue : 0;
          existing.quantity += Number.isFinite(quantity) ? quantity : 0;
          map.set(key, existing);
        });
        return map;
      };

      const computeProductChanges = (currentItems = [], previousItems = []) => {
        const currMap = normalizeProductItems(currentItems);
        const prevMap = normalizeProductItems(previousItems);
        const changes = [];

        currMap.forEach((current, key) => {
          const previous = prevMap.get(key) || { name: current.name, revenue: 0, quantity: 0 };
          const revenueChange = Number(current.revenue || 0) - Number(previous.revenue || 0);
          const quantityChange = Number(current.quantity || 0) - Number(previous.quantity || 0);
          const pctChange = Number(previous.revenue || 0) > 0 ? revenueChange / Number(previous.revenue || 0) : null;
          changes.push({
            key,
            name: current.name,
            revenueCurrent: Number(current.revenue || 0),
            revenuePrevious: Number(previous.revenue || 0),
            revenueChange,
            quantityCurrent: Number(current.quantity || 0),
            quantityPrevious: Number(previous.quantity || 0),
            quantityChange,
            percentChange: pctChange,
          });
          prevMap.delete(key);
        });

        prevMap.forEach((previous, key) => {
          const revenueChange = -Number(previous.revenue || 0);
          const quantityChange = -Number(previous.quantity || 0);
          changes.push({
            key,
            name: previous.name,
            revenueCurrent: 0,
            revenuePrevious: Number(previous.revenue || 0),
            revenueChange,
            quantityCurrent: 0,
            quantityPrevious: Number(previous.quantity || 0),
            quantityChange,
            percentChange: previous.revenue > 0 ? -1 : null,
          });
        });

        const increases = changes
          .filter((entry) => entry.revenueChange > 0)
          .sort((a, b) => b.revenueChange - a.revenueChange);

        const decreases = changes
          .filter((entry) => entry.revenueChange < 0)
          .sort((a, b) => a.revenueChange - b.revenueChange);

        return { increases, decreases };
      };

      const buildProductChangeItem = (entry, { compareLabel } = {}) => {
        const li = document.createElement('li');
        li.className = 'product-change-card__item';
        const tone = entry.revenueChange > 0 ? 'up' : entry.revenueChange < 0 ? 'down' : 'flat';
        li.dataset.tone = tone;

        const nameEl = document.createElement('span');
        nameEl.className = 'product-change-card__name';
        nameEl.textContent = entry.name || 'Ukjent produkt';

        const metricsEl = document.createElement('span');
        metricsEl.className = 'product-change-card__metrics';
        const parts = [];
        const currencyLabel = formatSignedCurrency(entry.revenueChange);
        if (currencyLabel) parts.push(currencyLabel);
        const percentLabel = formatSignedPercent(entry.percentChange);
        if (percentLabel) {
          parts.push(percentLabel);
        } else if (!Number.isFinite(entry.percentChange)) {
          if (entry.revenuePrevious === 0 && entry.revenueCurrent > 0) parts.push('ny');
          if (entry.revenueCurrent === 0 && entry.revenuePrevious > 0) parts.push('ut');
        }
        const quantityLabel = formatSignedQuantity(entry.quantityChange);
        if (quantityLabel && entry.quantityChange !== 0) {
          parts.push(`${quantityLabel} stk`);
        }
        if (parts.length === 0) parts.push('–');
        metricsEl.textContent = parts.join(' • ');

        li.append(nameEl, metricsEl);
        return li;
      };

      const renderProductInsights = (items, { date, state = 'ready', message = '', isDemo = false } = {}) => {
        if (aiProductsDateEl) {
          const parsed = date ? new Date(`${date}T00:00:00`) : null;
          const formatted = parsed && !Number.isNaN(parsed.getTime()) ? dateFmtLong.format(parsed) : (date || '–');
          aiProductsDateEl.textContent = formatted ? `Tall for ${formatted}` : '–';
        }

        if (aiTopListEl) aiTopListEl.innerHTML = '';
        if (aiBottomListEl) aiBottomListEl.innerHTML = '';

        if (state === 'loading') {
          setAiProductsStatus('Henter produktinnsikt …');
          return;
        }

        if (state === 'error') {
          setAiProductsStatus(message || 'Kunne ikke hente produktinnsikt.', 'error');
          return;
        }

        const processed = Array.isArray(items) ? items.map((entry) => ({
          name: String(entry?.name || 'Ukjent produkt'),
          revenue: Number(entry?.revenue || 0),
          quantity: Number(entry?.quantity ?? entry?.qty ?? 0),
        })) : [];

        const meaningful = processed.filter((entry) => entry.revenue !== 0 || entry.quantity !== 0);

        if (!meaningful.length) {
          setAiProductsStatus(message || 'Ingen produktdata for denne datoen.');
          return;
        }

        setAiProductsStatus(isDemo ? 'Viser demo-data for produktsalget.' : '', isDemo ? 'demo' : '');

        const topItems = [...meaningful]
          .sort((a, b) => {
            if (b.revenue !== a.revenue) return b.revenue - a.revenue;
            return b.quantity - a.quantity;
          })
          .slice(0, 5);

        const bottomItems = [...meaningful]
          .sort((a, b) => {
            if (a.revenue !== b.revenue) return a.revenue - b.revenue;
            return a.quantity - b.quantity;
          })
          .slice(0, 5);

        if (aiTopListEl) {
          topItems.forEach((item) => aiTopListEl.appendChild(buildProductListItem(item)));
        }

        if (aiBottomListEl) {
          bottomItems.forEach((item) => aiBottomListEl.appendChild(buildProductListItem(item)));
        }
      };

      const getDailyEntry = (iso, fallback = []) => {
        if (!iso) return null;
        const fromChart = chartDataMap.get(iso);
        if (fromChart) return fromChart;
        return fallback.find((entry) => entry?.date === iso) || null;
      };

      const getMonthEntries = (iso, fallback = []) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return [];
        const year = parsed.getFullYear();
        const month = parsed.getMonth();
        const matches = (entry) => {
          const entryDate = parseIsoDate(entry?.date);
          return entryDate && entryDate.getFullYear() === year && entryDate.getMonth() === month && Number.isFinite(entry?.revenue);
        };
        const fromChart = chartDataAll.filter(matches);
        if (fromChart.length) return fromChart;
        return fallback.filter(matches);
      };

      const renderRevenueAnalysisState = (state, { message = '', date } = {}) => {
        if (!revenueCardEl) return;
        if (revenueDateEl) revenueDateEl.textContent = date ? formatFriendlyDate(date) : '–';
        if (state === 'loading' && revenueComparisonEl) revenueComparisonEl.textContent = '–';
        if (state === 'loading') {
          revenueCurrentEl && (revenueCurrentEl.textContent = '–');
          revenueWeekDeltaEl && (revenueWeekDeltaEl.textContent = '–');
          revenueMonthDeltaEl && (revenueMonthDeltaEl.textContent = '–');
          setDeltaTone(revenueWeekDeltaEl, NaN);
          setDeltaTone(revenueMonthDeltaEl, NaN);
          if (revenueCurrentNoteEl) revenueCurrentNoteEl.textContent = '';
          if (revenueWeekNoteEl) { revenueWeekNoteEl.textContent = 'Henter referanse …'; setDeltaTone(revenueWeekNoteEl, NaN); }
          if (revenueMonthNoteEl) { revenueMonthNoteEl.textContent = 'Henter månedsdata …'; setDeltaTone(revenueMonthNoteEl, NaN); }
          if (revenueStatusEl) revenueStatusEl.textContent = message || 'Analyserer omsetningen …';
          return;
        }
        if (state === 'error') {
          if (revenueComparisonEl) revenueComparisonEl.textContent = '–';
          if (revenueStatusEl) revenueStatusEl.textContent = message || 'Kunne ikke hente omsetningsanalyse.';
          return;
        }
        if (revenueStatusEl) revenueStatusEl.textContent = message || '';
      };

      const renderRevenueAnalysis = ({ date, fallbackDaily = [], entry = null } = {}) => {
        revenueAnalysisContext = { date, fallbackDaily, entry };
        if (!revenueCardEl) return;
        const iso = sanitizeIso(date);
        renderRevenueAnalysisState('ready', { date: iso });
        if (!iso) {
          if (revenueStatusEl) revenueStatusEl.textContent = 'Velg en dato for å se omsetningen.';
          return;
        }

        const currentEntry = entry || getDailyEntry(iso, fallbackDaily);
        if (!currentEntry) {
          renderRevenueAnalysisState('error', { date: iso, message: 'Ingen omsetning registrert for valgt dato.' });
          return;
        }

        const currentRevenue = Number(currentEntry.revenue || 0);
        const currentReceipts = Number(currentEntry.receipts || 0);
        if (revenueCurrentEl) revenueCurrentEl.textContent = moneyFmt.format(currentRevenue);
        if (revenueCurrentNoteEl) {
          revenueCurrentNoteEl.textContent = currentReceipts > 0 ? `${qtyFmt.format(currentReceipts)} kvitteringer` : '';
        }

        const prevIso = sanitizeIso(shiftIsoDate(iso, -7));
        if (revenueComparisonEl) {
          revenueComparisonEl.textContent = prevIso ? `Referanse: ${formatFriendlyDate(prevIso)}` : 'Ingen referanse 7 dager tidligere';
        }
        const prevEntry = prevIso ? getDailyEntry(prevIso, fallbackDaily) : null;
        if (prevEntry && Number.isFinite(prevEntry.revenue)) {
          const prevRevenue = Number(prevEntry.revenue || 0);
          const diff = currentRevenue - prevRevenue;
          const pct = prevRevenue > 0 ? diff / prevRevenue : null;
          if (revenueWeekDeltaEl) {
            revenueWeekDeltaEl.textContent = formatSignedPercent(pct) || formatSignedCurrency(diff);
            setDeltaTone(revenueWeekDeltaEl, diff);
          }
          if (revenueWeekNoteEl) {
            const parts = [moneyFmt.format(prevRevenue)];
            if (currentReceipts > 0 && Number.isFinite(prevEntry.receipts)) {
              parts.push(`${qtyFmt.format(prevEntry.receipts)} kvitt.`);
            }
            revenueWeekNoteEl.textContent = `Forrige uke: ${parts.join(' • ')}`;
            setDeltaTone(revenueWeekNoteEl, diff);
          }
        } else {
          if (revenueWeekDeltaEl) {
            revenueWeekDeltaEl.textContent = '–';
            setDeltaTone(revenueWeekDeltaEl, NaN);
          }
          if (revenueWeekNoteEl) {
            revenueWeekNoteEl.textContent = 'Ingen tall 7 dager tilbake.';
            setDeltaTone(revenueWeekNoteEl, NaN);
          }
        }

        const monthEntries = getMonthEntries(iso, fallbackDaily).filter((item) => Number.isFinite(item?.revenue));
        if (monthEntries.length) {
          const total = monthEntries.reduce((sum, item) => sum + Number(item.revenue || 0), 0);
          const monthAverage = monthEntries.length ? total / monthEntries.length : 0;
          const diffMonth = currentRevenue - monthAverage;
          const pctMonth = monthAverage > 0 ? diffMonth / monthAverage : null;
          if (revenueMonthDeltaEl) {
            revenueMonthDeltaEl.textContent = formatSignedPercent(pctMonth) || formatSignedCurrency(diffMonth);
            setDeltaTone(revenueMonthDeltaEl, diffMonth);
          }
          if (revenueMonthNoteEl) {
            revenueMonthNoteEl.textContent = `Månedssnitt: ${moneyFmt.format(monthAverage)} (${monthEntries.length} dager)`;
            setDeltaTone(revenueMonthNoteEl, diffMonth);
          }
        } else {
          if (revenueMonthDeltaEl) {
            revenueMonthDeltaEl.textContent = '–';
            setDeltaTone(revenueMonthDeltaEl, NaN);
          }
          if (revenueMonthNoteEl) {
            revenueMonthNoteEl.textContent = 'Manglende månedsdata for å beregne snitt.';
            setDeltaTone(revenueMonthNoteEl, NaN);
          }
        }

        if (revenueStatusEl) revenueStatusEl.textContent = '';
      };

      const renderProductChangesState = (state, { date, compareDate, message = '', isDemo = false } = {}) => {
        if (!productChangeCardEl) return;
        if (productChangeDateEl) productChangeDateEl.textContent = date ? formatFriendlyDate(date) : '–';
        if (productChangeCompareEl) productChangeCompareEl.textContent = compareDate ? `Mot ${formatFriendlyDate(compareDate)}` : '–';
        if (productChangeUpEl) productChangeUpEl.innerHTML = '';
        if (productChangeDownEl) productChangeDownEl.innerHTML = '';
        if (state === 'loading') {
          if (productChangeStatusEl) productChangeStatusEl.textContent = message || 'Analyserer salgsendringer …';
          return;
        }
        if (state === 'error') {
          if (productChangeStatusEl) productChangeStatusEl.textContent = message || 'Kunne ikke beregne endringer.';
          return;
        }
        if (productChangeStatusEl) {
          productChangeStatusEl.textContent = message || (isDemo ? 'Viser demo-data for produktendringer.' : '');
        }
      };

      const renderProductChanges = ({ date, compareDate, currentItems = [], previousItems = [], isDemo = false }) => {
        if (!productChangeCardEl) return;
        renderProductChangesState('ready', { date, compareDate, isDemo });
        const { increases, decreases } = computeProductChanges(currentItems, previousItems);
        const hasIncreases = increases.length > 0;
        const hasDecreases = decreases.length > 0;

        if (!hasIncreases && !hasDecreases) {
          renderProductChangesState('error', { date, compareDate, message: 'Ingen endringer i salg mot forrige uke.' });
          return;
        }

        if (productChangeUpEl) {
          const topUps = increases.slice(0, 5);
          if (topUps.length) {
            topUps.forEach((entry) => {
              productChangeUpEl.appendChild(buildProductChangeItem(entry, { compareLabel: compareDate }));
            });
          } else {
            const li = document.createElement('li');
            li.className = 'product-change-card__item';
            li.textContent = 'Ingen produkter økte salget vs forrige uke.';
            productChangeUpEl.appendChild(li);
          }
        }

        if (productChangeDownEl) {
          const topDowns = decreases.slice(0, 5);
          if (topDowns.length) {
            topDowns.forEach((entry) => {
              productChangeDownEl.appendChild(buildProductChangeItem(entry, { compareLabel: compareDate }));
            });
          } else {
            const li = document.createElement('li');
            li.className = 'product-change-card__item';
            li.textContent = 'Ingen produkter falt i salg vs forrige uke.';
            productChangeDownEl.appendChild(li);
          }
        }
      };

      const pickItemsFromResponse = (data) => {
        if (!data) return [];
        if (Array.isArray(data.items)) return data.items;
        if (Array.isArray(data.top)) return data.top;
        if (Array.isArray(data.records)) return data.records;
        return [];
      };

      const loadProductChanges = ({ date, items = [], options = {}, isDemo = false }) => {
        if (!productChangeCardEl) return;
        const iso = sanitizeIso(date);
        const compareIso = iso ? sanitizeIso(shiftIsoDate(iso, -7)) : null;
        renderProductChangesState('loading', { date: iso, compareDate: compareIso });
        productChangeContext = { date: iso, items, options, isDemo };

        if (!iso) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Velg en dato for å se endringer.' });
          return;
        }
        if (!Array.isArray(items) || !items.length) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Ingen produktsalg for datoen.' });
          return;
        }
        if (!compareIso) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Manglet referanse 7 dager tilbake.' });
          return;
        }

        const applyResult = (previousItems, compareIsDemo = false) => {
          if (productChangeContext.date !== iso) return;
          renderProductChanges({
            date: iso,
            compareDate: compareIso,
            currentItems: items,
            previousItems,
            isDemo: isDemo || compareIsDemo,
          });
        };

        const handleError = (error) => {
          if (productChangeContext.date !== iso) return;
          renderProductChangesState('error', {
            date: iso,
            compareDate: compareIso,
            message: error?.body?.message || error?.message || 'Kunne ikke hente referansesalget.',
          });
        };

        fetchDayTotals(compareIso, options)
          .then((data) => {
            const previousItems = pickItemsFromResponse(data);
            applyResult(previousItems, !!options.demo || data?.mode === 'demo');
          })
          .catch((error) => {
            const shouldDemo = !options.demo && error?.status === 400 &&
              (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL');
            if (shouldDemo) {
              fetchDayTotals(compareIso, { demo: true })
                .then((demoData) => {
                  const previousItems = pickItemsFromResponse(demoData);
                  applyResult(previousItems, true);
                })
                .catch(handleError);
              return;
            }
            handleError(error);
          });
      };

      const hideGlobalTooltip = () => {
        if (!chartTooltip) return;
        chartTooltip.dataset.visible = '0';
        chartTooltip.hidden = true;
      };

      const defaultDayHeading = 'Dagens omsetning';

      const renderDayTotals = ({ date, revenue, receipts }, { isDemo = false } = {}) => {
        if (!dayRevenueEl) return;
        const parsed = date ? new Date(`${date}T00:00:00`) : null;
        const friendly = parsed && !Number.isNaN(parsed.getTime()) ? dateFmtLong.format(parsed) : date || '–';
        const revenueValue = Number(revenue || 0);
        const receiptsValue = Number(receipts || 0);
        const averageSale = receiptsValue > 0 ? revenueValue / receiptsValue : null;
        dayRevenueEl.textContent = moneyFmt.format(revenueValue);
        dayReceiptsEl.textContent = qtyFmt.format(receiptsValue);
        if (dayAverageEl) {
          dayAverageEl.textContent = averageSale != null ? moneyFmt.format(averageSale) : '–';
        }
        if (dayHeadingEl) {
          const headingFriendly = friendly && friendly !== '–' ? friendly : todayISO;
          const headingDisplay = (typeof headingFriendly === 'string' && headingFriendly.length)
            ? headingFriendly.charAt(0).toUpperCase() + headingFriendly.slice(1)
            : headingFriendly;
          dayHeadingEl.textContent = `Tall hentet fra ${headingDisplay}`;
        }
        renderDayStatus(isDemo ? `Viser demo for ${friendly} (mangler Lightspeed-nøkler).` : '');
      };

      const fetchDayTotals = (date, { demo = false } = {}) => {
        const url = new URL('/.netlify/functions/lightspeed', apiBase);
        url.searchParams.set('date', date);
        url.searchParams.set('limit', '50');
        if (demo) url.searchParams.set('demo', '1');
        return fetch(url.toString(), { headers: { accept: 'application/json' } })
          .then(async (response) => {
            const payload = await response.json().catch(() => null);
            if (!response.ok) {
              const error = new Error(`HTTP ${response.status}`);
              error.status = response.status;
              error.body = payload;
              throw error;
            }
            return payload;
          });
      };

      const loadDayTotals = (date) => {
        if (!dayRevenueEl) return;
        if (aiProductsPicker && aiProductsPicker.value !== date) {
          aiProductsPicker.value = date;
        }
        dayRevenueEl.textContent = '–';
        dayReceiptsEl.textContent = '–';
        if (dayAverageEl) dayAverageEl.textContent = '–';
        if (dayHeadingEl) dayHeadingEl.textContent = defaultDayHeading;
        renderProductInsights(null, { date, state: 'loading' });
        renderRevenueAnalysisState('loading', { date });
        renderProductChangesState('loading', { date });
        revenueAnalysisContext = { date, fallbackDaily: [], entry: null };
        productChangeContext = { date, items: [], options: {}, isDemo: false };

        let attemptedDemo = false;

        const attempt = (options = {}) => {
          fetchDayTotals(date, options)
            .then((data) => {
              const isDemo = !!options.demo;
              const items = Array.isArray(data?.items) ? data.items : Array.isArray(data?.top) ? data.top : [];
              let selected = data?.dayTotal || null;
              const daily = Array.isArray(data?.daily) ? data.daily : [];
              if (!selected && daily.length) {
                selected = daily.find((d) => d.date === date) || daily[0];
              }
              if (selected) {
                renderDayTotals(selected, { isDemo });
              } else {
                renderDayStatus('Ingen omsetning funnet for valgt dato.');
              }
              renderProductInsights(items, { date, isDemo, message: 'Ingen produktdata for denne datoen.' });
              revenueAnalysisContext = { date, fallbackDaily: daily, entry: selected };
              renderRevenueAnalysis(revenueAnalysisContext);
              productChangeContext = { date, items, options, isDemo };
              loadProductChanges(productChangeContext);
            })
            .catch((error) => {
              console.error('Kunne ikke hente dagsomsetning:', error);
              const allowDemo = !attemptedDemo && error?.status === 400 &&
                (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL');
              if (allowDemo) {
                attemptedDemo = true;
                renderProductInsights(null, { date, state: 'loading' });
                renderRevenueAnalysisState('loading', { date });
                renderProductChangesState('loading', { date });
                attempt({ demo: true });
                return;
              }
              if (attemptedDemo && options.demo && error?.body?.dayTotal) {
                renderDayTotals(error.body.dayTotal, { isDemo: true });
                const items = Array.isArray(error?.body?.items) ? error.body.items : Array.isArray(error?.body?.top) ? error.body.top : [];
                renderProductInsights(items, { date, isDemo: true });
                revenueAnalysisContext = { date, fallbackDaily: Array.isArray(error?.body?.daily) ? error.body.daily : [], entry: error.body.dayTotal };
                renderRevenueAnalysis(revenueAnalysisContext);
                productChangeContext = { date, items, options, isDemo: true };
                loadProductChanges(productChangeContext);
                return;
              }
              renderDayStatus(error?.body?.message || error?.message || 'Feil ved henting av omsetning', 'error');
              renderProductInsights(null, {
                date,
                state: 'error',
                message: error?.body?.message || error?.message || 'Kunne ikke hente produktsalget. Prøv igjen senere.',
              });
              renderRevenueAnalysisState('error', { date, message: error?.body?.message || error?.message || 'Kunne ikke hente omsetningsanalyse.' });
              renderProductChangesState('error', { date, message: error?.body?.message || error?.message || 'Kunne ikke beregne endringer.' });
            });
        };

        attempt();
      };

      if (barChart) {
        barChart.addEventListener('mouseleave', hideGlobalTooltip);
      }

      if (dayPicker) {
        dayPicker.max = todayISO;
        if (!dayPicker.value) dayPicker.value = todayISO;
        loadDayTotals(dayPicker.value);
        dayPicker.addEventListener('change', () => {
          const date = dayPicker.value || todayISO;
          loadDayTotals(date);
        });
      }

      if (aiProductsPicker) {
        aiProductsPicker.max = todayISO;
        if (!aiProductsPicker.value) {
          aiProductsPicker.value = dayPicker?.value || todayISO;
        }
        aiProductsPicker.addEventListener('change', () => {
          const date = aiProductsPicker.value || todayISO;
          if (dayPicker && dayPicker.value !== date) {
            dayPicker.value = date;
          }
          loadDayTotals(date);
        });
      }

      const dailyTableBody = document.querySelector('#daily-sales-body');
      if (dailyTableBody && typeof fetch === 'function') {
        const fallbackHtml = dailyTableBody.innerHTML;

        const renderLoading = () => {
          const loadingRow = document.createElement('tr');
          loadingRow.innerHTML = '<td colspan="3">Henter omsetning …</td>';
          dailyTableBody.innerHTML = '';
          dailyTableBody.appendChild(loadingRow);
        };

      const renderChart = (days, { isDemo = false, message = '' } = {}) => {
        if (!barChart) return;
        barChart.innerHTML = '';
        if (chartTooltip) {
          chartTooltip.hidden = true;
          chartTooltip.dataset.visible = '0';
        }
        if (!Array.isArray(days) || !days.length) {
          barChart.dataset.empty = '1';
          barChart.removeAttribute('data-demo');
          barChart.innerHTML = `<div class="bar-chart__empty">${message || 'Ingen data'}</div>`;
          return;
          }

          const revenues = days.map(d => Math.max(0, Number(d.revenue || 0)));
          const maxRevenue = Math.max(...revenues, 0) || 1;
          const nonZeroRevenues = revenues.filter(n => n > 0);
          const minRevenue = nonZeroRevenues.length ? Math.min(...nonZeroRevenues) : 0;
          const stretchFactor = 0.6;
          const chartHeight = barChart.clientHeight || 240;
          const maxBarHeight = chartHeight * 0.9;
          const minBarHeight = Math.max(6, chartHeight * 0.05);

          barChart.removeAttribute('data-empty');
          if (isDemo) {
            barChart.dataset.demo = '1';
          } else {
            barChart.removeAttribute('data-demo');
          }

          const showTooltip = (barEl, friendly, revenue) => {
            if (!chartTooltip) return;
            const containerRect = chartCard?.getBoundingClientRect() || barChart.getBoundingClientRect();
            const barRect = barEl.getBoundingClientRect();
            const left = barRect.left + barRect.width / 2 - containerRect.left;
            const top = barRect.top - containerRect.top;
            chartTooltip.textContent = `${friendly}: ${moneyFmt.format(revenue)}`;
            chartTooltip.style.left = `${left}px`;
            chartTooltip.style.top = `${top}px`;
            chartTooltip.hidden = false;
            chartTooltip.dataset.visible = '1';
          };

          const hideTooltip = () => {
            if (!chartTooltip) return;
            chartTooltip.dataset.visible = '0';
            chartTooltip.hidden = true;
          };

          days.forEach((day) => {
            const revenue = Math.max(0, Number(day.revenue || 0));
            let ratio = 0;
            if (revenue > 0) {
              const scaled = (revenue - minRevenue) * stretchFactor;
              ratio = (minRevenue + scaled) / Math.max(maxRevenue, 1);
            }
            ratio = Math.max(0, Math.min(1, ratio));
            const column = document.createElement('div');
            column.className = 'bar__column';
            const columnHeight = Math.max(minBarHeight, ratio * maxBarHeight);
            column.style.setProperty('--height', `${columnHeight}px`);
            const bar = document.createElement('div');
            bar.className = 'bar';
            const dateObj = day.date ? new Date(`${day.date}T00:00:00`) : null;
            const dayNameRaw = dateObj && !Number.isNaN(dateObj.getTime()) ? weekdayFmt.format(dateObj) : '';
            const dayName = dayNameRaw ? dayNameRaw.replace('.', '').slice(0,3).toUpperCase() : '';
            const dateLabel = dateObj && !Number.isNaN(dateObj.getTime()) ? chartDateFmt.format(dateObj) : (day.date || '');
            const friendly = dateObj && !Number.isNaN(dateObj.getTime()) ? dateFmtLong.format(dateObj) : (day.date || '');
            bar.title = `${friendly}: ${moneyFmt.format(revenue)}`;
            if (!revenue) {
              column.classList.add('bar__column--zero');
            }
            const label = document.createElement('span');
            label.className = 'bar__label';
            label.innerHTML = `<strong>${dayName}</strong><small>${dateLabel}</small>`;
            bar.append(column, label);
            const eventTarget = column;
            const handleEnter = () => showTooltip(bar, friendly, revenue);
            const handleLeave = () => hideTooltip();
            eventTarget.addEventListener('mouseenter', handleEnter);
            eventTarget.addEventListener('mouseleave', handleLeave);
            eventTarget.addEventListener('focus', handleEnter);
            eventTarget.addEventListener('blur', handleLeave);
            eventTarget.tabIndex = 0;
            eventTarget.setAttribute('aria-label', `${friendly}: ${moneyFmt.format(revenue)}`);
            barChart.appendChild(bar);
          });
        };

        const renderRows = (days, { showDemoNotice = false } = {}) => {
          dailyTableBody.innerHTML = '';
          if (!Array.isArray(days) || !days.length) {
            renderError('Ingen data', { replace: true });
            return;
          }
          if (showDemoNotice) {
            const notice = document.createElement('tr');
            notice.innerHTML = '<td colspan="3">Viser demo-data. Sett Lightspeed-nøkler i Netlify for ekte tall.</td>';
            dailyTableBody.appendChild(notice);
          }
          days.slice(0, 7).forEach((entry) => {
            const dateStr = typeof entry?.date === 'string' ? entry.date : null;
            const displayDate = (() => {
              if (!dateStr) return '–';
              const parsed = new Date(`${dateStr}T00:00:00`);
              if (Number.isNaN(parsed.getTime())) return dateStr;
              return dateFmtShort.format(parsed);
            })();
            const revenue = Number(entry?.revenue || 0);
            const guests = Number(entry?.guests || entry?.guestCount || 0);
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${displayDate}</td>
              <td>${moneyFmt.format(revenue)}</td>
              <td>${guests > 0 ? qtyFmt.format(guests) : '–'}</td>
            `;
            dailyTableBody.appendChild(row);
          });
        };

        const renderError = (message, { replace = false } = {}) => {
          if (replace) dailyTableBody.innerHTML = '';
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="3">${message}</td>`;
          dailyTableBody.appendChild(row);
        };

      const chartWindowDays = 14;

        const addDaysISO = (iso, delta) => {
          const base = iso ? new Date(`${iso}T00:00:00`) : new Date(`${todayISO}T00:00:00`);
          if (Number.isNaN(base.getTime())) return toISODate(new Date(`${todayISO}T00:00:00`));
          base.setDate(base.getDate() + delta);
          return toISODate(base);
        };

        const clampCursorDate = (iso) => {
          const latest = chartDataAll.length ? chartDataAll[0].date : todayISO;
          const oldest = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : latest;
          const earliestEnd = chartDataAll.length >= chartWindowDays ? addDaysISO(oldest, chartWindowDays - 1) : latest;
          let target = iso || latest;
          if (target.localeCompare(latest) > 0) target = latest;
          if (target.localeCompare(earliestEnd) < 0) target = earliestEnd;
          return target;
        };

        const buildChartRange = (endIso) => {
          const cursor = clampCursorDate(endIso);
          const endDate = new Date(`${cursor}T00:00:00`);
          const startDate = new Date(endDate);
          startDate.setDate(startDate.getDate() - (chartWindowDays - 1));
          const range = [];
          for (let i = 0; i < chartWindowDays; i++) {
            const current = new Date(startDate);
            current.setDate(startDate.getDate() + i);
            const iso = toISODate(current);
            const entry = chartDataMap.get(iso) || { date: iso, revenue: 0, guests: 0, receipts: 0 };
            range.push(entry);
          }
          return { cursor, range };
        };

        const updateChartNavButtons = () => {
          if (!chartPrevBtn || !chartNextBtn) return;
          if (!chartDataAll.length) {
            chartPrevBtn.disabled = true;
            chartNextBtn.disabled = true;
            return;
          }
          const latest = chartDataAll[0]?.date || todayISO;
          const oldest = chartDataAll[chartDataAll.length - 1]?.date || latest;
          const earliestEnd = chartDataAll.length >= chartWindowDays ? addDaysISO(oldest, chartWindowDays - 1) : latest;
          chartPrevBtn.disabled = chartCursorDate ? chartCursorDate.localeCompare(earliestEnd) <= 0 : true;
          chartNextBtn.disabled = chartCursorDate ? chartCursorDate.localeCompare(latest) >= 0 : false;
        };

        const renderChartWindow = (endIso, { isDemo = false } = {}) => {
          const { cursor, range } = buildChartRange(endIso);
          chartCursorDate = cursor;
          renderChart(range, { isDemo });
          updateChartNavButtons();
        };

        const shiftChartWindow = (offsetDays) => {
          if (!chartCursorDate) return;
          hideGlobalTooltip();
          const target = addDaysISO(chartCursorDate, offsetDays);
          renderChartWindow(target, { isDemo: chartIsDemo });
        };

        const fromDate = new Date(today);
        fromDate.setDate(fromDate.getDate() - 60);
        const from = toISODate(fromDate);

        const fetchDaily = ({ demo = false } = {}) => {
          const url = new URL('/.netlify/functions/lightspeed', apiBase);
          url.searchParams.set('from', from);
          url.searchParams.set('to', todayISO);
          url.searchParams.set('group', 'daily');
          url.searchParams.set('limit', '90');
          url.searchParams.set('window', '90');
          if (demo) url.searchParams.set('demo', '1');

          return fetch(url.toString(), { headers: { accept: 'application/json' } })
            .then(async (response) => {
              const payload = await response.json().catch(() => null);
              if (!response.ok) {
                const error = new Error(`HTTP ${response.status}`);
                error.status = response.status;
                error.body = payload;
                throw error;
              }
              return payload;
            });
        };

        let attemptedDemoFallback = false;
        renderLoading();
        renderChart([], { message: 'Henter …' });
        updateChartNavButtons();

        const load = (options = {}) => {
          fetchDaily(options)
            .then((data) => {
              const days = Array.isArray(data?.daily) ? data.daily : [];
              const isDemo = !!options.demo || data?.mode === 'demo';
              const sortedDesc = [...days].sort((a, b) => b.date.localeCompare(a.date));
              renderRows(sortedDesc, { showDemoNotice: isDemo });
              chartDataAll = sortedDesc;
              chartDataMap = new Map(sortedDesc.map(entry => [entry.date, entry]));
              chartLatestDate = chartDataAll.length ? chartDataAll[0].date : todayISO;
              chartOldestDate = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : chartLatestDate;
              chartIsDemo = isDemo;
              renderChartWindow(chartLatestDate, { isDemo });
              if (revenueAnalysisContext?.date) {
                renderRevenueAnalysis(revenueAnalysisContext);
              }
            })
            .catch((error) => {
              console.error('Kunne ikke hente daglig omsetning:', error);
              const shouldTryDemo = !attemptedDemoFallback && (
                error?.status === 400 &&
                (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL')
              );
              if (shouldTryDemo) {
                attemptedDemoFallback = true;
                renderLoading();
                load({ demo: true });
                return;
              }
              if (attemptedDemoFallback && options.demo) {
                try {
                  const days = error?.body?.daily || [];
                  const sortedDesc = [...days].sort((a, b) => b.date.localeCompare(a.date));
                  renderRows(sortedDesc, { showDemoNotice: true });
                  chartDataAll = sortedDesc;
                  chartDataMap = new Map(sortedDesc.map(entry => [entry.date, entry]));
                  chartLatestDate = chartDataAll.length ? chartDataAll[0].date : todayISO;
                  chartOldestDate = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : chartLatestDate;
                  chartIsDemo = true;
                  renderChartWindow(chartLatestDate, { isDemo: true });
                  return;
                } catch (_) {
                  /* fall through */
                }
              }
              dailyTableBody.innerHTML = fallbackHtml;
              renderError(
                (error?.body?.message) ? `Kunne ikke hente daglig omsetning: ${error.body.message}`
                  : `Kunne ikke hente daglig omsetning. ${error?.message || ''}`,
                { replace: false }
              );
              chartDataAll = [];
              chartDataMap = new Map();
              chartCursorDate = null;
              chartLatestDate = todayISO;
              chartOldestDate = todayISO;
              chartIsDemo = false;
              renderChart([], { message: error?.body?.message || error?.message || 'Feil ved henting' });
              updateChartNavButtons();
            });
        };

        if (chartPrevBtn) {
          chartPrevBtn.addEventListener('click', () => shiftChartWindow(-chartWindowDays));
        }
        if (chartNextBtn) {
          chartNextBtn.addEventListener('click', () => shiftChartWindow(chartWindowDays));
        }

        load();
      }

      const navMobileToggle = document.querySelector('.nav-actions .mobile-toggle');
      const navControls = document.querySelector('.nav-controls');
      const topBar = document.querySelector('.top-bar');
      const mobileThemeSwitch = document.querySelector('.mobile-theme-switch');
      if (navMobileToggle && navControls) {
        navMobileToggle.addEventListener('click', () => {
          const open = !navControls.classList.contains('open');
          navControls.classList.toggle('open', open);
          navMobileToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (mobileThemeSwitch && dashMq.matches) mobileThemeSwitch.hidden = !open;
        });
        const dashMq = window.matchMedia('(max-width: 720px)');
        const resetDash = () => {
          if (!dashMq.matches) {
            navControls.classList.remove('open');
            navMobileToggle.setAttribute('aria-expanded', 'false');
            if (mobileThemeSwitch) mobileThemeSwitch.hidden = false;
          } else {
            if (mobileThemeSwitch) mobileThemeSwitch.hidden = !navControls.classList.contains('open');
          }
        };
        dashMq.addEventListener ? dashMq.addEventListener('change', resetDash) : dashMq.addListener(resetDash);
        resetDash();
      }

      const themeToggleInput = document.querySelector('#dash-theme-toggle');
      if (themeToggleInput) {
        const isDark = document.body.getAttribute('data-theme') !== 'light';
        themeToggleInput.checked = isDark;
        themeToggleInput.addEventListener('change', () => {
          const toDark = themeToggleInput.checked;
          document.body.setAttribute('data-theme', toDark ? 'dark' : 'light');
          if (mobileThemeSwitch) {
            const mobileInput = mobileThemeSwitch.querySelector('input');
            if (mobileInput) mobileInput.checked = toDark;
          }
        });
      }

      if (mobileThemeSwitch) {
        const mobileInput = mobileThemeSwitch.querySelector('input');
        if (mobileInput && themeToggleInput) {
          const syncMobileState = () => {
            mobileInput.checked = themeToggleInput.checked;
          };
          syncMobileState();
          mobileInput.addEventListener('change', () => {
            const toDark = mobileInput.checked;
            document.body.setAttribute('data-theme', toDark ? 'dark' : 'light');
            themeToggleInput.checked = toDark;
          });
          themeToggleInput.addEventListener('change', syncMobileState);
        }
      }

      if (topBar) {
        let lastScrollY = window.scrollY;
        let ticking = false;
        const threshold = 10;
        const handleScroll = () => {
          const currentY = window.scrollY;
          const delta = currentY - lastScrollY;
          if (Math.abs(delta) > threshold) {
            const shouldHide = currentY > lastScrollY && currentY > 48;
            topBar.dataset.hidden = shouldHide ? '1' : '0';
            lastScrollY = currentY;
          }
          ticking = false;
        };
        window.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(handleScroll);
            ticking = true;
          }
        }, { passive: true });
      }

      const userMenu = document.querySelector('[data-menu]');
      if (userMenu) {
        const trigger = userMenu.querySelector('.user-menu__trigger');
        const panel = userMenu.querySelector('.user-menu__panel');
        const items = Array.from(userMenu.querySelectorAll('.user-menu__item'));

        const setOpen = (open) => {
          userMenu.classList.toggle('open', open);
          trigger.setAttribute('aria-expanded', String(open));
          panel.toggleAttribute('hidden', !open);
          if (open) {
            requestAnimationFrame(() => items[0]?.focus());
          }
        };

        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          const open = !userMenu.classList.contains('open');
          setOpen(open);
        });

        trigger.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            if (!userMenu.classList.contains('open')) {
              setOpen(true);
            } else {
              items[0]?.focus();
            }
          } else if (event.key === 'Escape') {
            setOpen(false);
            trigger.focus();
          }
        });

        items.forEach((item, index) => {
          item.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
              event.preventDefault();
              const direction = event.key === 'ArrowDown' ? 1 : -1;
              const nextIndex = (index + direction + items.length) % items.length;
              items[nextIndex].focus();
            } else if (event.key === 'Escape') {
              setOpen(false);
              trigger.focus();
            }
          });

          item.addEventListener('click', () => {
            setOpen(false);
            trigger.focus();
          });
        });

        document.addEventListener('click', (event) => {
          if (!userMenu.contains(event.target)) {
            setOpen(false);
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && userMenu.classList.contains('open')) {
            setOpen(false);
            trigger.focus();
          }
        });
      }
    })();
  </script>
</body>
</html>
