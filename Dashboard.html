<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tripletex kontoposter — Bian Analytics</title>
  <style>
    :root{
      --brand-600:#1f4fcc; --brand-700:#1e3a8a;
      --ink-900:#0b1220; --ink-700:#374151; --border:#e5e7eb;
      --surface:#fff; --shadow:0 10px 28px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;color:var(--ink-900);background:#fff}
    a{color:inherit}
    .container{max-width:1200px;margin-inline:auto;padding-inline:clamp(20px,6vw,100px)}

    header{position:sticky;top:0;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);box-shadow:0 8px 18px rgba(2,6,23,.04);z-index:50}
    .nav{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;padding-block:12px}
    .brand{display:flex;gap:.6rem;align-items:center;text-decoration:none;font-weight:800}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(180deg,var(--brand-600),var(--brand-700));color:#fff;display:grid;place-items:center;box-shadow:var(--shadow)}
    .org{font-weight:800}
    .nav-right{display:flex;align-items:center;gap:10px}
    .chip{border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-weight:700;background:#fff}
    .btn{appearance:none;border:1px solid var(--border);border-radius:999px;padding:9px 14px;background:#fff;font-weight:700;cursor:pointer;box-shadow:0 1px 2px rgba(2,6,23,.06)}

    main{padding-block:28px}
    .grid{display:grid;grid-template-columns:1fr;gap:20px}

    .card{border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:var(--shadow);background:#fff}
    h1{margin:0 0 14px;font-size:20px;letter-spacing:-.01em}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-weight:600;font-size:.92rem;margin-bottom:6px}
    input[type="date"], input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
    button{appearance:none;border:1px solid var(--border);border-radius:12px;padding:10px 16px;background:#111827;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    small{display:block;color:#6b7280;margin-top:6px}

    .presets{display:flex;gap:8px;justify-content:flex-end;margin-bottom:12px}
    .chipbtn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    .chipbtn.active{background:var(--brand-600);color:#fff;border-color:transparent}

    .status{font-weight:700}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow)}
    thead th{position:sticky;top:0;background:#f8fafc;text-align:left;font-weight:700;border-bottom:1px solid var(--border);padding:10px 12px}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric:tabular-nums}
    .right{text-align:right}
    .muted{color:#6b7280}

    .totals{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;font-weight:700}
  </style>

  <script>
    // Enkel auth-guard — fjern hvis du ikke vil ha innlogging.
    (function(){
      try{
        const authed = localStorage.getItem('bian.authed') === '1';
        const user = (localStorage.getItem('bian.user')||'').toLowerCase();
        if(!authed || user!=='test@gressholmen.no'){
          window.location.replace('login.html');
        }
      }catch(e){ window.location.replace('login.html'); }
    })();
  </script>
</head>
<body>
  <a class="skip-link" href="#main" style="position:absolute;left:12px;top:8px;padding:10px 14px;border-radius:12px;background:#0b1220;color:#fff;text-decoration:none;box-shadow:var(--shadow);transform:translateY(-160%);transition:transform .12s ease;z-index:1000">Hopp til innhold</a>

  <header>
    <div class="container nav">
      <a class="brand" href="index.html" title="Til forsiden">
        <div class="logo">B</div><span>Bian Analytics</span>
      </a>
      <div style="justify-self:center;text-align:center">
        <div class="org">Gressholmen Kro AS</div>
        <div class="sub" id="subtitle" style="color:#374151"></div>
      </div>
      <div class="nav-right">
        <span id="who" class="chip" title="Innlogget bruker">…</span>
        <button id="logout" class="btn">Logg ut</button>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="container grid">
      <section class="card" aria-label="Velg konto og periode">
        <h1>Kontoposter fra Tripletex</h1>

        <div class="presets" role="group" aria-label="Hurtigvalg for periode">
          <button class="chipbtn" data-preset="day">I dag</button>
          <button class="chipbtn" data-preset="7">Siste 7</button>
          <button class="chipbtn" data-preset="30">Siste 30</button>
        </div>

        <div class="row" style="margin-bottom:12px">
          <div>
            <label for="accountNo">Konto‑nr (f.eks. 1920)</label>
            <input id="accountNo" type="text" inputmode="numeric" autocomplete="off" placeholder="1920" value="1920" />
            <small class="muted">Vi slår opp konto‑ID via <code>/v2/ledger/account?number=</code>.</small>
          </div>
          <div></div>
        </div>

        <div class="row">
          <div>
            <label for="from">Start</label>
            <input id="from" type="date" autocomplete="off">
          </div>
          <div>
            <label for="to">Slutt</label>
            <input id="to" type="date" autocomplete="off">
            <small class="muted">Merk: Tripletex sine <code>dateTo</code>-parametre er «til og <em>eksklusiv</em>», så vi legger automatisk på +1 dag i API‑kallet.</small>
          </div>
        </div>

        <div class="actions">
          <button id="fetchBtn">Hent transaksjoner</button>
        </div>
        <small id="hint" class="status"></small>
      </section>

      <section class="card" aria-label="Resultater">
        <div class="totals" id="totals" hidden>
          <span class="pill" id="pillCount"></span>
          <span class="pill" id="pillSum"></span>
        </div>
        <div style="overflow:auto">
          <table aria-describedby="hint">
            <thead>
              <tr>
                <th style="width:140px">Dato</th>
                <th>Tekst</th>
                <th class="right">Beløp</th>
                <th style="width:110px">Bunt/Voucher</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="4" class="muted">Ingen data ennå. Velg konto og periode, og trykk «Hent transaksjoner».</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
    // Header-info
    const user = (localStorage.getItem('bian.user')||'');
    const who = document.getElementById('who'); if (who) who.textContent = user || 'Innlogget';
    const d = new Date();
    const subtitle = document.getElementById('subtitle');
    if (subtitle) subtitle.textContent = d.toLocaleDateString('no-NO',{weekday:'long', day:'2-digit', month:'long', year:'numeric'});
    const logoutBtn = document.getElementById('logout');
    if (logoutBtn) logoutBtn.addEventListener('click',()=>{ try{ localStorage.removeItem('bian.authed'); localStorage.removeItem('bian.user'); }catch(e){} window.location.href='login.html'; });

    // === Små utils ===
    const toISO = dt => new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const addDays = (iso, n) => { const t = new Date(iso+'T00:00:00'); t.setDate(t.getDate()+n); return toISO(t); };

    // === API Service (kun Tripletex) ===
    const API = (() => {
      // KUN via proxy på samme origin (f.eks. Cloudflare Worker / Vercel Function)
      // Ingen hemmeligheter i nettleseren.
      async function getAccountIdByNumber(number){
        const url = new URL('/api/ledger/account', location.origin);
        url.searchParams.set('number', String(number));
        url.searchParams.set('count', '1');
        const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
        if (!resp.ok) throw new Error('Account ' + resp.status);
        const data = await resp.json();
        const values = Array.isArray(data?.values) ? data.values : [];
        if (!values.length) throw new Error('Finner ikke konto '+number);
        return values[0].id;
      }

      async function fetchPostingsByAccountNumber(accountNumber, fromISO, toISOExclusive){
        const accountId = await getAccountIdByNumber(accountNumber);
        let page = 0; const count = 1000; const all = [];
        while(true){
          const url = new URL('/api/ledger/posting', location.origin);
          url.searchParams.set('dateFrom', fromISO);
          url.searchParams.set('dateTo', toISOExclusive); // Tripletex: eksklusiv
          url.searchParams.set('accountId', String(accountId));
          url.searchParams.set('page', String(page));
          url.searchParams.set('count', String(count));
          const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
          if (!resp.ok) throw new Error('Posting ' + resp.status);
          const json = await resp.json();
          const vals = Array.isArray(json?.values) ? json.values : [];
          all.push(...vals);
          if (vals.length < count) break;
          page += 1;
        }
        return all;
      }

      return { fetchPostingsByAccountNumber };
    })();

    // === UI wiring ===
    const fromEl = document.getElementById('from');
    const toEl   = document.getElementById('to');
    const acctEl = document.getElementById('accountNo');
    const btn    = document.getElementById('fetchBtn');
    const hint   = document.getElementById('hint');
    const rowsEl = document.getElementById('rows');
    const totalsWrap = document.getElementById('totals');
    const pillCount = document.getElementById('pillCount');
    const pillSum = document.getElementById('pillSum');

    function setDefaults(){
      // Default: siste 30 dager
      const now = new Date();
      const from = new Date(now); from.setDate(from.getDate()-29);
      fromEl.value = toISO(from);
      toEl.value   = toISO(now);
      acctEl.focus();
      updateSubtitle();
    }

    function updateSubtitle(){
      // oppdater aktivt hurtigvalg (visuelt)
      const presetBtns = Array.from(document.querySelectorAll('.chipbtn'));
      const f = new Date(fromEl.value), t = new Date(toEl.value);
      const now = new Date();
      const sameDay = f.toDateString()===t.toDateString() && t.toDateString()===now.toDateString();
      const diffDays=Math.round((t-f)/86400000)+1; // inklusiv
      const toISO_ = d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      let key=null;
      if(sameDay) key='day'; else if(diffDays===7 && toISO_(t)===toISO_(now)) key='7'; else if(diffDays===30 && toISO_(t)===toISO_(now)) key='30';
      presetBtns.forEach(b=>b.classList.toggle('active', b.dataset.preset===key));
    }

    function renderRows(list){
      rowsEl.innerHTML = '';
      if (!list.length){
        rowsEl.innerHTML = '<tr><td colspan="4" class="muted">Ingen posteringer funnet for valgt periode/konto.</td></tr>';
        totalsWrap.hidden = true; return;
      }
      // sortér etter dato stigende
      list.sort((a,b)=>a.date.localeCompare(b.date));
      let sum = 0;
      const fmt = new Intl.NumberFormat('nb-NO', { minimumFractionDigits:2, maximumFractionDigits:2 });
      const esc = s => String(s??'').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
      const tr = (p)=>{
        sum += Number(p.amount||0);
        const text = p.text || p.description || (p.voucher && p.voucher.description) || '';
        const voucher = p.voucher?.id || p.voucherId || '';
        return `<tr>
          <td class="mono">${esc(p.date||'')}</td>
          <td>${esc(text)}</td>
          <td class="right mono">${fmt.format(Number(p.amount||0))}</td>
          <td class="mono">${voucher}</td>
        </tr>`;
      };
      rowsEl.innerHTML = list.map(tr).join('');
      pillCount.textContent = `${list.length} posteringer`;
      pillSum.textContent = `Sum: ${fmt.format(sum)}`;
      totalsWrap.hidden = false;
    }

    async function fetchNow(){
      const acct = (acctEl.value||'').trim();
      const f = fromEl.value, t = toEl.value;
      if (!acct || !f || !t){ hint.textContent = '❌ Fyll ut konto og datoer'; return; }
      btn.disabled = true; hint.textContent = '🌐 Henter fra Tripletex… (kan ta litt tid ved mange posteringer)';
      try{
        // dateTo er eksklusiv i Tripletex, så vi plusser på én dag for å inkludere valgt dato i UI‑et
        const toExclusive = addDays(t, 1);
        const postings = await API.fetchPostingsByAccountNumber(acct, f, toExclusive);
        // lagre lokalt om du vil bruke på andre sider
        try{
          localStorage.setItem('bian.ledger', JSON.stringify({ from:f, to:t, account:acct, values: postings }));
        }catch(e){}
        hint.textContent = `✅ Fant ${postings.length} posteringer på konto ${acct}`;
        renderRows(postings);
      }catch(e){
        console.error(e);
        hint.textContent = '❌ ' + (e?.message || 'Feil ved henting') + ' — sjekk CORS hvis dette kjøres direkte i nettleser.';
        rowsEl.innerHTML = '<tr><td colspan="4" class="muted">Ingen data</td></tr>';
        totalsWrap.hidden = true;
      }finally{
        btn.disabled = false;
      }
    }

    // Hurtigvalg (I dag / 7 / 30)
    const presetBtns = Array.from(document.querySelectorAll('.chipbtn'));
    function toISOdate(d){return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10)}
    function applyPreset(key){
      const now = new Date();
      let from = new Date(now);
      if(key==='day'){ /* samme dag */ }
      else if(key==='7'){ from.setDate(from.getDate()-6); }
      else if(key==='30'){ from.setDate(from.getDate()-29); }
      fromEl.value = toISOdate(from);
      toEl.value   = toISOdate(now);
      updateSubtitle();
    }
    presetBtns.forEach(b=>b.addEventListener('click',()=>applyPreset(b.dataset.preset)));

    // Init
    document.getElementById('fetchBtn').addEventListener('click', fetchNow);
    document.getElementById('accountNo').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); fetchNow(); }});
    fromEl.addEventListener('change', updateSubtitle);
    toEl.addEventListener('change', updateSubtitle);
    setDefaults();
  </script>

  <!--
  =============================================================
  BACKEND-PROXY (Cloudflare Worker) — legg i egen fil (f.eks. worker.mjs)
  Deploy: 1) npm i -g wrangler  2) wrangler init  3) wrangler secret put CONSUMER_TOKEN
          4) wrangler secret put EMPLOYEE_TOKEN  5) wrangler deploy
  Deretter servér denne HTML-filen fra samme domenet som Workeren.
  =============================================================

  let CACHED_TOKEN = null; let TOKEN_EXP = 0;
  async function getSessionToken(env){
    const now = Date.now();
    if (CACHED_TOKEN && now < TOKEN_EXP) return CACHED_TOKEN;
    const u = new URL('https://api-test.tripletex.tech/v2/token/session/:create');
    u.searchParams.set('consumerToken', env.CONSUMER_TOKEN);
    u.searchParams.set('employeeToken', env.EMPLOYEE_TOKEN);
    u.searchParams.set('expirationDate', new Date(now + 3600_000).toISOString());
    const r = await fetch(u, { method:'PUT', headers:{ 'Accept':'application/json' } });
    if(!r.ok) throw new Error('Token '+r.status);
    const j = await r.json();
    const t = j?.value?.token; if(!t) throw new Error('Ugyldig token');
    CACHED_TOKEN = t; TOKEN_EXP = now + 55*60*1000; // 55 min cache
    return t;
  }

  function cors(request){
    const origin = request.headers.get('Origin') || '*';
    return {
      'Access-Control-Allow-Origin': origin,
      'Vary': 'Origin',
      'Access-Control-Allow-Methods': 'GET,OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type,Authorization',
      'Access-Control-Max-Age': '86400'
    };
  }

  async function forward(request, env, path){
    const incoming = new URL(request.url);
    const target = new URL('https://api-test.tripletex.tech'+path);
    incoming.searchParams.forEach((v,k)=>target.searchParams.set(k,v));
    const tok = await getSessionToken(env);
    const auth = 'Basic ' + btoa('0:'+tok);
    const resp = await fetch(target.toString(), { headers: { 'Authorization': auth, 'Accept':'application/json' } });
    const body = await resp.text();
    return new Response(body, { status: resp.status, headers: { 'Content-Type':'application/json', ...cors(request) } });
  }

  export default {
    async fetch(request, env){
      const url = new URL(request.url);
      if (request.method === 'OPTIONS') return new Response(null, { headers: cors(request) });
      if (url.pathname === '/api/ledger/account') return forward(request, env, '/v2/ledger/account');
      if (url.pathname === '/api/ledger/posting') return forward(request, env, '/v2/ledger/posting');
      return new Response('Not found', { status:404, headers: cors(request) });
    }
  };
  -->

</body>
</html>
