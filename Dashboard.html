<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Scope Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" />
  <script>
    (function(){
      if(!window.DASHBOARD_API_BASE){
        const explicit = document.documentElement?.getAttribute('data-api-base') || document.body?.getAttribute('data-api-base');
        if(explicit){
          window.DASHBOARD_API_BASE = explicit;
        }else{
          const host = (typeof window !== 'undefined' && window.location) ? window.location.hostname : '';
          const isLocal = ['localhost','127.0.0.1','0.0.0.0','::1'].includes(host);
          if(isLocal){
            window.DASHBOARD_API_BASE = 'http://localhost:8888';
          }else if (typeof window !== 'undefined' && window.location && window.location.origin){
            window.DASHBOARD_API_BASE = window.location.origin;
          }else{
            window.DASHBOARD_API_BASE = 'https://din-side.netlify.app';
          }
        }
      }
    })();
  </script>
  <style>
    :root{
      color-scheme:light;
      --bg-from:#f7f8fc;
      --bg-to:#eef1f7;
      --surface:#ffffff;
      --surface-muted:rgba(255,255,255,0.72);
      --surface-elevated:#ffffff;
      --surface-glass:rgba(255,255,255,0.82);
      --surface-ghost:rgba(255,255,255,0.6);
      --primary:#6C63FF;
      --primary-hover:#5A53E6;
      --primary-pressed:#4D47CC;
      --primary-border:rgba(108,99,255,0.35);
      --text:#0F172A;
      --text-strong:#0F172A;
      --text-muted:#475569;
      --text-subtle:#64748B;
      --text-inverse:#F8FAFC;
      --border:#E2E8F0;
      --border-subtle:rgba(148,163,184,0.4);
      --shadow-xs:0 8px 20px rgba(15,23,42,0.08);
      --shadow-sm:0 12px 28px rgba(15,23,42,0.12);
      --shadow-md:0 18px 42px rgba(15,23,42,0.12);
      --shadow-lg:0 28px 64px rgba(15,23,42,0.16);
      --ring:0 0 0 3px rgba(108,99,255,0.38);
      --ring-offset:0 0 0 5px rgba(255,255,255,0.85);
      --radius-sm:0.75rem;
      --radius-md:1rem;
      --radius-lg:1.5rem;
      --radius-pill:999px;
      --space-1:0.5rem;
      --space-2:0.75rem;
      --space-3:1rem;
      --space-4:1.5rem;
      --space-5:2rem;
      --transition:180ms ease;
    }
    body[data-theme="dark"]{
      color-scheme:dark;
      --bg-from:#0b1020;
      --bg-to:#0b1222;
      --surface:#0f172a;
      --surface-muted:rgba(15,23,42,0.7);
      --surface-elevated:#111c32;
      --surface-glass:rgba(15,23,42,0.8);
      --surface-ghost:rgba(15,23,42,0.62);
      --text:#E2E8F0;
      --text-strong:#F8FAFC;
      --text-muted:#94A3B8;
      --text-subtle:#7C8FAC;
      --text-inverse:#0F172A;
      --border:#1f2937;
      --border-subtle:rgba(30,41,59,0.68);
      --shadow-xs:0 10px 26px rgba(2,6,23,0.42);
      --shadow-sm:0 18px 36px rgba(2,6,23,0.48);
      --shadow-md:0 24px 54px rgba(2,6,23,0.6);
      --shadow-lg:0 32px 80px rgba(2,6,23,0.66);
      --ring-offset:0 0 0 4px rgba(15,23,42,0.85);
    }
    *,*::before,*::after{box-sizing:border-box;}
    html{background:var(--bg-from);}
    body{
      margin:0;
      min-height:100vh;
      font-family:"Inter","SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      line-height:1.6;
      letter-spacing:0.01em;
      color:var(--text);
      background:var(--bg-from);
      position:relative;
      transition:color var(--transition),background var(--transition);
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        radial-gradient(900px 900px at 0% -5%,rgba(108,99,255,0.16),transparent 60%),
        radial-gradient(720px 720px at 95% -10%,rgba(90,83,230,0.14),transparent 65%),
        linear-gradient(180deg,var(--bg-from) 0%,var(--bg-to) 100%);
    }
    body[data-theme="dark"]::before{
      background:
        radial-gradient(880px 880px at 0% -10%,rgba(108,99,255,0.24),transparent 65%),
        radial-gradient(680px 680px at 95% -10%,rgba(76,72,180,0.2),transparent 70%),
        linear-gradient(180deg,var(--bg-from) 0%,var(--bg-to) 100%);
    }
    @media (prefers-reduced-motion:reduce){
      *,*::before,*::after{transition:none!important;animation:none!important;}
    }
    ::selection{background:rgba(108,99,255,0.25);}
    a{color:inherit;text-decoration:none;}
    a:hover{color:var(--primary);}
    img{max-width:100%;display:block;}
    h1,h2,h3,h4{margin:0;color:var(--text-strong);font-weight:600;}
    p{margin:0;color:var(--text);}
    p.muted{color:var(--text-muted);}
    ul{margin:0;padding:0;list-style:none;}
    table{border-collapse:separate;border-spacing:0;width:100%;}
    thead th{font-weight:600;color:var(--text-muted);font-size:0.85rem;text-transform:uppercase;letter-spacing:0.08em;padding-bottom:var(--space-2);}
    tbody td{padding:0.5rem 0;color:var(--text);font-size:0.95rem;border-top:1px solid var(--border);}
    tbody tr:first-child td{border-top:none;}
    button,input,select,label{font:inherit;color:inherit;}
    button{background:none;border:none;padding:0;cursor:pointer;}
    button:disabled{cursor:not-allowed;opacity:0.6;}
    button:focus-visible,[role="button"]:focus-visible,input:focus-visible,select:focus-visible{outline:none;box-shadow:var(--ring);}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .shell{width:100%;max-width:1160px;margin:0 auto;padding-inline:clamp(16px,4vw,56px);}
    main.shell{padding-block:clamp(32px,5vw,64px);}
    .top-bar{
      position:sticky;
      top:0;
      z-index:30;
      background:var(--surface-glass);
      backdrop-filter:saturate(160%) blur(14px);
      border-bottom:1px solid var(--border-subtle);
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
      transition:transform var(--transition),opacity var(--transition),background var(--transition);
    }
    body[data-theme="dark"] .top-bar{
      background:var(--surface-glass);
      box-shadow:0 14px 36px rgba(2,6,23,0.5);
    }
    .top-bar[data-hidden="1"]{transform:translateY(-110%);opacity:0;}
    .top-bar__inner{
      display:flex;
      align-items:center;
      gap:var(--space-3);
      min-height:4.25rem;
      font-family:"Inter","SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .brand{
      display:inline-flex;
      align-items:center;
      justify-content:flex-start;
      font-weight:700;
      font-size:clamp(1.25rem,3vw,1.65rem);
      letter-spacing:0.04em;
      color:var(--primary);
      text-transform:capitalize;
    }
    .brand-title{
      flex:1;
      text-align:center;
      font-size:clamp(1rem,2.2vw,1.25rem);
      font-weight:600;
      color:var(--text-strong);
    }
    .nav-actions{
      display:flex;
      align-items:center;
      gap:var(--space-2);
      margin-left:auto;
      position:relative;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.35rem;
      padding:0.35rem 0.95rem;
      min-height:2.5rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      font-size:0.92rem;
      font-weight:600;
      letter-spacing:0.01em;
      box-shadow:var(--shadow-xs);
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition),transform var(--transition);
    }
    .chip:hover{background:color-mix(in srgb,var(--surface) 82%,var(--primary) 18%);color:var(--text-strong);border-color:var(--primary);transform:translateY(-1px);}
    .chip[aria-pressed="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--text-inverse);
      box-shadow:0 16px 34px rgba(108,99,255,0.26);
    }
    .chip[aria-pressed="true"]:hover{background:var(--primary-hover);}
    .chip:active{background:var(--primary-pressed);color:var(--text-inverse);}
    .chip:focus-visible{box-shadow:var(--ring);}
    .user-menu{position:relative;}
    .user-menu__trigger{
      width:2.75rem;
      height:2.75rem;
      padding:0;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:var(--shadow-xs);
    }
    .user-menu__trigger:hover{background:color-mix(in srgb,var(--surface) 88%,var(--primary) 12%);}
    .user-menu__icon{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;}
    .user-menu__icon span{display:block;width:18px;height:2px;border-radius:999px;background:var(--text);transition:background var(--transition);}
    .user-menu.open .user-menu__icon span{background:var(--primary);}
    .user-menu__panel{
      position:absolute;
      top:calc(100% + 12px);
      right:0;
      min-width:220px;
      background:var(--surface-elevated);
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      box-shadow:var(--shadow-lg);
      padding:var(--space-1) 0;
      opacity:0;
      visibility:hidden;
      transform:translateY(-8px);
      transition:opacity var(--transition),transform var(--transition),visibility var(--transition);
      z-index:40;
    }
    .user-menu.open .user-menu__panel{opacity:1;visibility:visible;transform:translateY(0);}
    .user-menu__section-title{
      font-size:0.72rem;
      font-weight:600;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-muted);
      padding:0 var(--space-3);
      margin-bottom:0.25rem;
    }
    .user-menu__item{
      width:100%;
      padding:0.65rem var(--space-3);
      display:flex;
      align-items:center;
      gap:0.6rem;
      font-size:0.92rem;
      background:none;
      border:none;
      color:var(--text);
      text-align:left;
      transition:background var(--transition),color var(--transition);
    }
    .user-menu__item:hover,
    .user-menu__item:focus-visible{background:color-mix(in srgb,var(--surface) 86%,var(--primary) 14%);color:var(--text-strong);outline:none;}
    .user-menu__item--danger{color:#f87171;}
    .user-menu__separator{height:1px;background:var(--border);margin:0.75rem 0;}
    .mobile-toggle{
      display:none;
      align-items:center;
      gap:0.45rem;
      padding:0.4rem 0.95rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text-strong);
      font-weight:600;
      font-size:0.9rem;
      box-shadow:var(--shadow-xs);
      transition:background var(--transition),border-color var(--transition),color var(--transition);
    }
    .mobile-toggle .dots{display:flex;flex-direction:column;gap:3px;}
    .mobile-toggle .dots span{width:16px;height:2px;border-radius:999px;background:currentColor;}
    .mobile-toggle:hover{background:color-mix(in srgb,var(--surface) 86%,var(--primary) 14%);color:var(--text-strong);border-color:var(--primary);}
    .nav-controls{
      display:inline-flex;
      align-items:center;
      gap:var(--space-2);
      padding:0.35rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface-muted);
      box-shadow:var(--shadow-xs);
    }
    .nav-controls.open{display:flex;}
    .segmented-control{
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      padding:0.25rem;
      border-radius:var(--radius-pill);
      background:var(--surface);
      border:1px solid var(--border);
      box-shadow:var(--shadow-xs);
    }
    .segmented-control__option{
      min-height:2.1rem;
      padding:0.25rem 0.9rem;
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      background:transparent;
      color:var(--text-muted);
      font-size:0.85rem;
      font-weight:600;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .segmented-control__option[aria-pressed="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--text-inverse);
      box-shadow:0 10px 24px rgba(108,99,255,0.28);
    }
    .segmented-control__option:hover{color:var(--text-strong);}
    .segmented-control__option:focus-visible{box-shadow:var(--ring);}
    .theme-switch{
      position:relative;
      display:inline-flex;
      width:54px;
      height:30px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:var(--shadow-xs);
    }
    .theme-switch input{opacity:0;width:0;height:0;position:absolute;}
    .theme-switch .slider{
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:linear-gradient(120deg,rgba(108,99,255,0.16),rgba(108,99,255,0.05));
      transition:background var(--transition),border-color var(--transition);
      padding:4px;
      display:block;
    }
    .theme-switch .thumb{
      position:absolute;
      top:50%;
      left:4px;
      width:22px;
      height:22px;
      border-radius:50%;
      background:var(--surface);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      transform:translateY(-50%);
      transition:transform var(--transition),background var(--transition),border-color var(--transition),color var(--transition);
      box-shadow:var(--shadow-xs);
      color:#FDB813;
    }
    .theme-switch .icon{width:16px;height:16px;}
    .theme-switch .icon.moon{display:none;color:#f8fafc;}
    .theme-switch input:checked + .slider .thumb{
      left:calc(100% - 26px);
      color:#f1f5f9;
      border-color:var(--primary-border);
      background:var(--primary);
    }
    .theme-switch input:checked + .slider{background:linear-gradient(120deg,rgba(93,84,230,0.32),rgba(76,71,204,0.18));}
    .theme-switch input:checked + .slider .icon.sun{display:none;}
    .theme-switch input:checked + .slider .icon.moon{display:block;}
    .theme-switch input:focus-visible + .slider,
    .theme-switch .thumb:focus-visible{box-shadow:var(--ring);}
    nav.sub-nav{
      padding-block:clamp(16px,3vw,24px);
      border-bottom:1px solid transparent;
      background:transparent;
    }
    .tablist{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0.4rem;
      padding:0.4rem;
      border:1px solid var(--border);
      border-radius:calc(var(--radius-pill) + 8px);
      background:color-mix(in srgb,var(--surface) 78%,transparent);
      box-shadow:var(--shadow-xs);
      width:fit-content;
      max-width:100%;
      margin-inline:auto;
      overflow-x:auto;
    }
    .tab-button{
      min-height:2.6rem;
      padding:0.5rem 1.3rem;
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      background:transparent;
      color:var(--text-muted);
      font-size:0.95rem;
      font-weight:600;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition),transform var(--transition);
    }
    .tab-button:hover{color:var(--text-strong);}
    .tab-button.active,
    .tab-button[aria-selected="true"]{
      background:var(--primary);
      color:var(--text-inverse);
      border-color:var(--primary);
      box-shadow:0 16px 32px rgba(108,99,255,0.28);
    }
    .tab-button:focus-visible{box-shadow:var(--ring);}
    .tab-panel{
      display:grid;
      gap:clamp(20px,3vw,32px);
    }
    .tab-panel[hidden]{display:none;}
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      padding:clamp(1.5rem,2.8vw,2rem);
      transition:box-shadow var(--transition),transform var(--transition),background var(--transition);
    }
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}
    .card header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:var(--space-2);
      margin-bottom:var(--space-3);
    }
    .card header h2{
      font-size:1.1rem;
      font-weight:600;
      color:var(--text-strong);
    }
    .card header .subtle{
      font-size:0.9rem;
      color:var(--text-muted);
    }
    .stats-grid{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    }
    .stat{padding:var(--space-4);}
    .stat h2{font-size:1rem;color:var(--text-muted);font-weight:600;}
    .stat-number{
      font-size:2rem;
      font-weight:700;
      color:var(--text-strong);
      margin-top:0.35rem;
      letter-spacing:-0.01em;
    }
    .stat-sub{
      color:var(--text-muted);
      margin-top:0.35rem;
      font-size:0.95rem;
    }
    .table-card table{font-size:0.95rem;}
    .table-scroll{overflow:auto;max-height:360px;padding-bottom:0.5rem;}
    .table-scroll::-webkit-scrollbar{height:8px;width:8px;}
    .table-scroll::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.4);border-radius:999px;}
    .chart-card .bar-chart{
      position:relative;
      min-height:240px;
      border-radius:var(--radius-md);
      border:1px dashed var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 85%,transparent);
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
      gap:1rem;
      overflow-x:auto;
      padding:var(--space-3);
    }
    .chart-card .bar-chart[data-empty="1"]{
      align-items:center;
      justify-content:center;
      gap:0;
    }
    .chart-card .bar-chart::-webkit-scrollbar{height:8px;}
    .chart-card .bar-chart::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.35);border-radius:999px;}
    .bar{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:0.5rem;
      min-width:2.75rem;
    }
    .bar__column{
      position:relative;
      width:100%;
      height:var(--track-height,180px);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:6px;
      border-radius:20px;
      border:1px solid color-mix(in srgb,var(--primary) 18%,transparent);
      background:linear-gradient(180deg,rgba(108,99,255,0.12) 0%,rgba(108,99,255,0.02) 100%);
      box-shadow:0 12px 30px rgba(15,23,42,0.18);
      transition:box-shadow var(--transition),transform var(--transition);
      cursor:pointer;
      overflow:hidden;
    }
    .bar__column::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:radial-gradient(120% 120% at 50% 100%,rgba(108,99,255,0.15) 0%,transparent 65%);
      opacity:0.6;
      pointer-events:none;
    }
    .bar__column::after{
      content:"";
      position:relative;
      display:block;
      width:calc(100% - 12px);
      height:var(--fill-height,12px);
      border-radius:14px;
      background:linear-gradient(180deg,var(--primary) 0%,var(--primary-hover) 100%);
      box-shadow:0 18px 32px rgba(108,99,255,0.28);
      transition:height 200ms ease,transform 200ms ease,box-shadow 200ms ease;
    }
    .bar__column[data-zero="1"]::after{
      background:linear-gradient(180deg,rgba(148,163,184,0.4) 0%,rgba(148,163,184,0.18) 100%);
      box-shadow:none;
      height:10px;
      opacity:0.7;
    }
    .bar__column:hover,
    .bar__column:focus-visible{
      transform:translateY(-3px);
      box-shadow:0 18px 36px rgba(108,99,255,0.32);
      outline:none;
    }
    .bar__column:hover::after,
    .bar__column:focus-visible::after{
      transform:translateY(-4px);
    }
    .bar__label{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:0.15rem;
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--text-muted);
    }
    .bar__label strong{font-size:0.78rem;color:var(--text-strong);}
    .bar__label small{font-size:0.7rem;color:var(--text-muted);}
    .tripletex-grid{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    }
    .tripletex-card h2{font-size:1.05rem;}
    .tripletex-status{font-size:0.85rem;color:var(--text-muted);margin:0;}
    .tripletex-status[data-tone="error"]{color:#dc2626;}
    .tripletex-status[data-tone="muted"]{color:var(--text-muted);}
    .tripletex-table{width:100%;border-collapse:separate;border-spacing:0;font-size:0.9rem;font-variant-numeric:tabular-nums;}
    .tripletex-table thead th{padding-bottom:0.6rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;font-size:0.78rem;letter-spacing:0.08em;border-bottom:1px solid var(--border);text-align:left;}
    .tripletex-table tbody td{padding:0.7rem 0;border-bottom:1px solid var(--border-subtle);}
    .tripletex-table tbody tr:last-child td{border-bottom:none;}
    .tripletex-table .numeric{text-align:right;}
    .tripletex-table .trend-positive{color:#16a34a;}
    .tripletex-table .trend-negative{color:#dc2626;}
    .tripletex-table .muted{color:var(--text-muted);}
    .chart-nav{
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .chart-nav__btn{
      width:2.4rem;
      height:2.4rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      box-shadow:var(--shadow-xs);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .chart-nav__btn:hover{background:color-mix(in srgb,var(--surface) 85%,var(--primary) 15%);border-color:var(--primary);}
    .chart-tooltip{
      position:absolute;
      inset:auto auto 10px 50%;
      transform:translateX(-50%);
      background:var(--surface);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:0.6rem 0.85rem;
      box-shadow:var(--shadow-sm);
      font-size:0.85rem;
      pointer-events:none;
    }
    .daily-summary-card .daily-summary{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    }
    .daily-summary__controls{display:flex;align-items:center;gap:0.5rem;}
    .daily-summary__input{
      appearance:none;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:0.45rem 0.75rem;
      font-size:0.95rem;
      color:var(--text);
      box-shadow:var(--shadow-xs);
      transition:border-color var(--transition),box-shadow var(--transition);
    }
    .daily-summary__input:focus-visible{border-color:var(--primary);box-shadow:var(--ring);}
    .summary-card{
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.06));
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      padding:var(--space-3);
      box-shadow:var(--shadow-xs);
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }
    .summary-card__label{color:var(--text-muted);font-size:0.9rem;font-weight:500;}
    .summary-card__value{font-size:1.4rem;font-weight:700;color:var(--text-strong);}
    .summary-card__value.fade{color:var(--text-muted);}
    .summary-card__meta{font-size:0.85rem;color:var(--text-muted);}
    .ai-insights-card .ai-insights{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }
    .ai-insights__column h3{font-size:0.95rem;font-weight:600;color:var(--text-muted);}
    .ai-insights__list{
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      margin-top:var(--space-2);
    }
    .ai-insights__list:empty{
      border:1px dashed var(--border);
      border-radius:var(--radius-md);
      padding:1rem;
      align-items:center;
      justify-content:center;
      min-height:4.5rem;
      display:flex;
    }
    .ai-insights__list:empty::before{
      content:"Ingen data for valgt dato.";
      color:var(--text-muted);
      font-size:0.9rem;
    }
    .ai-insights__item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:0.75rem;
      padding:0.7rem 0.9rem;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.05));
      box-shadow:var(--shadow-xs);
      font-size:0.92rem;
    }
    .ai-insights__product{font-weight:600;color:var(--text-strong);}
    .ai-insights__metric{color:var(--text-muted);font-size:0.9rem;}
    .ai-insights__status{
      margin-top:var(--space-3);
      font-size:0.92rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .ai-insights__status::before{
      content:"";
      width:0.75rem;
      height:0.75rem;
      border-radius:50%;
      background:var(--border);
      flex-shrink:0;
    }
    .ai-insights__status[data-tone="error"]{color:#f87171;}
    .ai-insights__status[data-tone="info"]{color:var(--primary);}
    .ai-insights__status[data-tone="demo"]{color:var(--primary);}
    .ai-insights__status:empty{display:none;}
    .ai-insights__status[data-tone="error"]::before{background:#f87171;}
    .ai-insights__status[data-tone="info"]::before{background:var(--primary);}
    .ai-insights__status[data-tone="demo"]::before{background:var(--primary);}
    .revenue-card,.product-change-card{
      display:flex;
      flex-direction:column;
      gap:var(--space-3);
    }
    .revenue-card__grid{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .revenue-card__stat{
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      padding:var(--space-3);
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.05));
      box-shadow:var(--shadow-xs);
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }
    .revenue-card__label{font-size:0.85rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;}
    .revenue-card__value{font-size:1.35rem;font-weight:700;color:var(--text-strong);}
    .revenue-card__delta{font-size:0.9rem;color:var(--text-muted);}
    .revenue-card__delta[data-tone="up"]{color:#22c55e;}
    .revenue-card__delta[data-tone="down"]{color:#f87171;}
    .revenue-card__note{
      font-size:0.92rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .revenue-card__note:empty{display:none;}
    .revenue-card__note::before,
    .product-change-card__status::before,
    .day-status::before{
      content:"";
      width:0.65rem;
      height:0.65rem;
      border-radius:50%;
      background:var(--border);
      flex-shrink:0;
    }
    .revenue-card__note[data-tone="error"]::before,
    .product-change-card__status[data-tone="error"]::before,
    .day-status[data-tone="error"]::before{background:#f87171;}
    .revenue-card__note[data-tone="positive"]::before,
    .product-change-card__status[data-tone="positive"]::before,
    .day-status[data-tone="positive"]::before{background:#22c55e;}
    .revenue-card__note[data-tone="warning"]::before,
    .product-change-card__status[data-tone="warning"]::before,
    .day-status[data-tone="warning"]::before{background:#fbbf24;}
    .product-change-card__columns{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }
    .product-change-card__column h3{font-size:0.95rem;font-weight:600;color:var(--text-muted);}
    .product-change-card__list{
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      margin-top:var(--space-2);
    }
    .product-change-card__list:empty{
      border:1px dashed var(--border);
      border-radius:var(--radius-md);
      padding:1rem;
      align-items:center;
      justify-content:center;
      min-height:4.5rem;
      display:flex;
    }
    .product-change-card__list:empty::before{
      content:"Ingen data for valgt dato.";
      color:var(--text-muted);
      font-size:0.9rem;
    }
    .product-change-card__item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:0.75rem;
      padding:0.7rem 0.9rem;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.05));
      box-shadow:var(--shadow-xs);
      font-size:0.92rem;
    }
    .product-change-card__name{
      font-weight:600;
      color:var(--text-strong);
      flex:1;
      min-width:0;
    }
    .product-change-card__metrics{
      font-size:0.9rem;
      color:var(--text-muted);
      text-align:right;
      white-space:nowrap;
    }
    .product-change-card__item[data-tone="up"] .product-change-card__metrics{color:#22c55e;}
    .product-change-card__item[data-tone="down"] .product-change-card__metrics{color:#f87171;}
    .product-change-card__status{
      font-size:0.92rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .product-change-card__status:empty{display:none;}
    .day-status{
      margin-top:var(--space-2);
      font-size:0.9rem;
      color:var(--text-muted);
    }
    .day-status:empty{display:none;}
    .day-status[data-tone="muted"]{color:var(--text-muted);}
    .day-status[data-tone="warning"]{color:#fbbf24;}
    .day-status[data-tone="error"]{color:#f87171;}
    .day-status[data-tone="positive"]{color:#22c55e;}
    .bar-chart__empty{
      font-size:0.95rem;
      color:var(--text-muted);
    }
    @media (max-width:900px){
      .brand-title{text-align:left;}
      .nav-actions{gap:var(--space-1);}
    }
    @media (max-width:720px){
      .top-bar__inner{flex-wrap:wrap;justify-content:space-between;}
      .brand-title{order:3;width:100%;text-align:left;}
      .nav-actions{width:100%;justify-content:space-between;}
      .mobile-toggle{display:inline-flex;}
      .nav-controls{
        position:absolute;
        top:calc(100% + 12px);
        right:clamp(16px,6vw,40px);
        flex-direction:column;
        align-items:stretch;
        gap:var(--space-2);
        padding:var(--space-3);
        border-radius:var(--radius-lg);
        background:var(--surface-elevated);
        box-shadow:var(--shadow-lg);
        min-width:220px;
        display:none;
        z-index:40;
      }
      .nav-controls.open{display:flex;}
      .segmented-control{width:100%;justify-content:space-between;}
      .theme-switch{align-self:flex-start;}
    }
    @media (min-width:1024px){
      .tab-panel{
        grid-template-columns:repeat(2,1fr);
      }
      .tab-panel > *{
        min-width:0;
      }
      .tab-panel > .stats-grid{
        grid-column:1 / -1;
      }
      .ai-insights-card,
      .chart-card,
      .daily-summary-card{
        grid-column:1 / -1;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <header class="top-bar">
    <div class="shell top-bar__inner">
      <div class="brand">Scope</div>
      <div class="brand-title">Gressholmen Kro</div>
      <div class="nav-actions">
        <div class="user-menu" data-menu>
          <button type="button" id="user-menu-trigger" class="chip user-menu__trigger" aria-haspopup="true" aria-expanded="false" aria-controls="user-menu-panel" aria-label="Konto og innstillinger">
            <span class="sr-only">Din konto</span>
            <span class="user-menu__icon" aria-hidden="true">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </button>
          <div class="user-menu__panel" id="user-menu-panel" role="menu" aria-labelledby="user-menu-trigger" hidden>
            <div class="user-menu__section-title">Konto</div>
            <button type="button" class="user-menu__item" role="menuitem">Betaling &amp; faktura</button>
            <button type="button" class="user-menu__item" role="menuitem">Innstillinger</button>
            <div class="user-menu__separator" role="presentation"></div>
            <button type="button" class="user-menu__item user-menu__item--danger" role="menuitem">Logg ut</button>
          </div>
        </div>
        <button class="mobile-toggle" aria-expanded="false" aria-controls="dash-controls" data-i18n-attr="aria-label:mobile.menu_button">
          <span class="dots" aria-hidden="true"><span></span><span></span><span></span></span>
          <span data-i18n="mobile.menu_button">Meny</span>
        </button>
        <div class="nav-controls" id="dash-controls">
          <div class="segmented-control nav-language" role="group" aria-label="Språk" data-language-toggle>
            <button type="button" class="segmented-control__option" aria-pressed="true" data-lang="no">NO</button>
            <button type="button" class="segmented-control__option" aria-pressed="false" data-lang="en">EN</button>
          </div>
          <label class="theme-switch mobile-theme-switch" aria-label="Bytt tema">
            <input type="checkbox" id="dash-theme-toggle" aria-label="Tema" />
            <span class="slider">
              <span class="thumb">
                <svg class="icon sun" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="5" />
                  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <svg class="icon moon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" />
                </svg>
              </span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </header>
  <nav class="sub-nav">
    <div class="shell">
      <div class="tablist" role="tablist" aria-label="Dashboard faner">
        <button class="tab-button active" id="tab-kpi" type="button" role="tab" aria-selected="true" aria-controls="kpi" data-tab-target="kpi" tabindex="0">KPI-er</button>
        <button class="tab-button" id="tab-oversikt" type="button" role="tab" aria-selected="false" aria-controls="oversikt" data-tab-target="oversikt" tabindex="-1">Oversikt</button>
        <button class="tab-button" id="tab-ai" type="button" role="tab" aria-selected="false" aria-controls="ai-tips" data-tab-target="ai-tips" tabindex="-1">AI-tips</button>
      </div>
    </div>
  </nav>
  <main class="shell">
    <section class="tab-panel active" id="kpi" role="tabpanel" aria-labelledby="tab-kpi" tabindex="0" data-tripletex-config='{"beer":{"label":"Øl","accounts":{"revenue":"id-289896744","cost":"id-289896742"}},"wine":{"label":"Vin","accounts":{"revenue":"id-289896745","cost":"id-289896743"}}}'>
      <div class="tripletex-grid">
        <article class="card tripletex-card" data-tripletex-product="beer">
          <header>
            <h2 data-tripletex-label>Tripletex · Øl</h2>
            <p class="tripletex-status" data-tripletex-status>Henter …</p>
          </header>
          <table class="tripletex-table">
            <thead>
              <tr>
                <th>Måned</th>
                <th>Salgsinntekt</th>
                <th>Varekost</th>
                <th>Dekningsgrad</th>
              </tr>
            </thead>
            <tbody data-tripletex-table>
              <tr><td colspan="4" class="muted">Henter …</td></tr>
            </tbody>
          </table>
        </article>
        <article class="card tripletex-card" data-tripletex-product="wine">
          <header>
            <h2 data-tripletex-label>Tripletex · Vin</h2>
            <p class="tripletex-status" data-tripletex-status>Henter …</p>
          </header>
          <table class="tripletex-table">
            <thead>
              <tr>
                <th>Måned</th>
                <th>Salgsinntekt</th>
                <th>Varekost</th>
                <th>Dekningsgrad</th>
              </tr>
            </thead>
            <tbody data-tripletex-table>
              <tr><td colspan="4" class="muted">Henter …</td></tr>
            </tbody>
          </table>
        </article>
      </div>
    </section>
    <section class="tab-panel" id="oversikt" role="tabpanel" aria-labelledby="tab-oversikt" tabindex="0" hidden>
      <article class="card chart-card">
        <header>
          <h2>Omsetning (14 dager)</h2>
          <div class="chart-nav">
            <button type="button" class="chart-nav__btn" data-chart-nav="prev" aria-label="Forrige 14 dager">‹</button>
            <button type="button" class="chart-nav__btn" data-chart-nav="next" aria-label="Neste 14 dager">›</button>
          </div>
        </header>
        <div class="bar-chart" data-daily-chart role="img" aria-live="polite" aria-label="Omsetning siste 14 dager"></div>
        <div class="chart-tooltip" data-chart-tooltip hidden></div>
      </article>
      <article class="card daily-summary-card">
        <header>
          <h2 data-day-heading>Dagens omsetning</h2>
          <div class="daily-summary__controls">
            <label for="sales-day-picker" class="sr-only">Velg dato</label>
            <input type="date" id="sales-day-picker" class="daily-summary__input" />
          </div>
        </header>
        <div class="daily-summary">
          <article class="summary-card">
            <span class="summary-card__label">Omsetning</span>
            <p class="summary-card__value" data-day-revenue>–</p>
          </article>
          <article class="summary-card">
            <span class="summary-card__label">Antall kvitteringer</span>
            <p class="summary-card__value" data-day-receipts>–</p>
          </article>
          <article class="summary-card">
            <span class="summary-card__label">Snitt per kjøp</span>
            <p class="summary-card__value" data-day-average>–</p>
          </article>
        </div>
        <p class="day-status" data-day-status></p>
      </article>
      <article class="card table-card">
        <header>
          <h2>Omsetning per dag</h2>
        </header>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Dato</th>
                <th>Omsetning</th>
                <th>Gjester</th>
              </tr>
            </thead>
            <tbody id="daily-sales-body">
              <tr class="demo-row">
                <td>12. mai</td>
                <td>128&nbsp;900 kr</td>
                <td>302</td>
              </tr>
              <tr class="demo-row">
                <td>11. mai</td>
                <td>142&nbsp;100 kr</td>
                <td>318</td>
              </tr>
              <tr class="demo-row">
                <td>10. mai</td>
                <td>119&nbsp;450 kr</td>
                <td>276</td>
              </tr>
              <tr class="demo-row">
                <td>9. mai</td>
                <td>105&nbsp;780 kr</td>
                <td>244</td>
              </tr>
              <tr class="demo-row">
                <td>8. mai</td>
                <td>131&nbsp;060 kr</td>
                <td>289</td>
              </tr>
              <tr class="demo-row">
                <td>7. mai</td>
                <td>138&nbsp;500 kr</td>
                <td>310</td>
              </tr>
              <tr class="demo-row">
                <td>6. mai</td>
                <td>114&nbsp;230 kr</td>
                <td>268</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </section>
    <section class="tab-panel" id="ai-tips" role="tabpanel" aria-labelledby="tab-ai" tabindex="0" hidden>
      <article class="card ai-insights-card">
        <header>
          <h2>AI-tips</h2>
          <div class="ai-insights__meta">
            <span data-ai-products-date>–</span>
            <label for="ai-products-picker" class="sr-only">Velg dato for AI-tips</label>
            <input type="date" id="ai-products-picker" class="daily-summary__input ai-insights__input" />
          </div>
        </header>
        <div class="ai-insights" data-ai-insights>
          <div class="ai-insights__column">
            <h3>Mest solgte produkter</h3>
            <ul class="ai-insights__list" data-ai-top-list></ul>
          </div>
          <div class="ai-insights__column">
            <h3>Minst solgte produkter</h3>
            <ul class="ai-insights__list" data-ai-bottom-list></ul>
          </div>
        </div>
        <p class="ai-insights__status" data-ai-products-status></p>
      </article>
      <article class="revenue-card" data-revenue-card>
        <header>
          <h2 class="revenue-card__title">Omsetningsanalyse</h2>
          <div class="revenue-card__meta">
            <span data-revenue-date>–</span>
            <span data-revenue-comparison>–</span>
          </div>
        </header>
        <div class="revenue-card__grid">
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Omsetning</span>
            <strong class="revenue-card__value" data-revenue-current>–</strong>
            <span class="revenue-card__delta" data-revenue-current-note></span>
          </div>
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Mot forrige uke</span>
            <strong class="revenue-card__value" data-revenue-week-delta>–</strong>
            <span class="revenue-card__delta" data-revenue-week-note></span>
          </div>
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Mot månedssnitt</span>
            <strong class="revenue-card__value" data-revenue-month-delta>–</strong>
            <span class="revenue-card__delta" data-revenue-month-note></span>
          </div>
        </div>
        <p class="revenue-card__note" data-revenue-status></p>
      </article>
      <article class="product-change-card" data-product-change-card>
        <header>
          <h2 class="product-change-card__title">Produktendringer</h2>
          <div class="product-change-card__meta">
            <span data-product-change-date>–</span>
            <span data-product-change-compare>–</span>
          </div>
        </header>
        <div class="product-change-card__columns">
          <div class="product-change-card__column">
            <h3>Størst vekst</h3>
            <ul class="product-change-card__list" data-product-change-up></ul>
          </div>
          <div class="product-change-card__column">
            <h3>Størst nedgang</h3>
            <ul class="product-change-card__list" data-product-change-down></ul>
          </div>
        </div>
        <p class="product-change-card__status" data-product-change-status></p>
      </article>
    </section>
  </main>
  <script>
    (function() {
      const buttons = Array.from(document.querySelectorAll('.tab-button'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));

      function activateTab(targetId) {
        buttons.forEach((btn) => {
          const isActive = btn.dataset.tabTarget === targetId;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
          btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });

        panels.forEach((panel) => {
          const isMatch = panel.id === targetId;
          panel.classList.toggle('active', isMatch);
          panel.toggleAttribute('hidden', !isMatch);
        });

      }

      // simple tab controller for switching dashboard sections
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
        btn.addEventListener('keydown', (event) => {
          const index = buttons.indexOf(btn);
          if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
            event.preventDefault();
            const direction = event.key === 'ArrowRight' ? 1 : -1;
            const nextIndex = (index + direction + buttons.length) % buttons.length;
            buttons[nextIndex].focus();
          } else if (event.key === 'Home') {
            event.preventDefault();
            buttons[0].focus();
          } else if (event.key === 'End') {
            event.preventDefault();
            buttons[buttons.length - 1].focus();
          }
        });
      });

      const defaultTab = buttons.find((btn) => btn.classList.contains('active'))?.dataset.tabTarget || buttons[0]?.dataset.tabTarget;
      if (defaultTab) {
        activateTab(defaultTab);
      }

      const moneyFmt = new Intl.NumberFormat('nb-NO', { style: 'currency', currency: 'NOK', maximumFractionDigits: 0 });
      const qtyFmt = new Intl.NumberFormat('nb-NO', { maximumFractionDigits: 0 });
      const percentFmt = new Intl.NumberFormat('nb-NO', { style: 'percent', maximumFractionDigits: 0 });
      const dateFmtShort = new Intl.DateTimeFormat('nb-NO', { day: 'numeric', month: 'short' });
      const dateFmtLong = new Intl.DateTimeFormat('nb-NO', { weekday: 'short', day: 'numeric', month: 'short' });

      const apiBase = window.DASHBOARD_API_BASE || (
        (window.location && window.location.origin) ? window.location.origin : 'http://localhost:8888'
      );

      const toISODate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const today = new Date();
      const todayISO = toISODate(today);

      const dayPicker = document.querySelector('#sales-day-picker');
      const dayHeadingEl = document.querySelector('[data-day-heading]');
      const dayRevenueEl = document.querySelector('[data-day-revenue]');
      const dayReceiptsEl = document.querySelector('[data-day-receipts]');
      const dayAverageEl = document.querySelector('[data-day-average]');
      const dayStatusEl = document.querySelector('[data-day-status]');
      const barChart = document.querySelector('[data-daily-chart]');
      const chartPrevBtn = document.querySelector('[data-chart-nav="prev"]');
      const chartNextBtn = document.querySelector('[data-chart-nav="next"]');
      const chartTooltip = document.querySelector('[data-chart-tooltip]');
      const chartCard = barChart ? barChart.closest('.chart-card') : null;
      const weekdayFmt = new Intl.DateTimeFormat('nb-NO', { weekday: 'short' });
      const chartDateFmt = new Intl.DateTimeFormat('nb-NO', { day: '2-digit', month: '2-digit' });
      const aiTopListEl = document.querySelector('[data-ai-top-list]');
      const aiBottomListEl = document.querySelector('[data-ai-bottom-list]');
      const aiProductsStatusEl = document.querySelector('[data-ai-products-status]');
      const aiProductsDateEl = document.querySelector('[data-ai-products-date]');
      const aiProductsPicker = document.querySelector('#ai-products-picker');
      const revenueCardEl = document.querySelector('[data-revenue-card]');
      const revenueDateEl = document.querySelector('[data-revenue-date]');
      const revenueComparisonEl = document.querySelector('[data-revenue-comparison]');
      const revenueCurrentEl = document.querySelector('[data-revenue-current]');
      const revenueCurrentNoteEl = document.querySelector('[data-revenue-current-note]');
      const revenueWeekDeltaEl = document.querySelector('[data-revenue-week-delta]');
      const revenueWeekNoteEl = document.querySelector('[data-revenue-week-note]');
      const revenueMonthDeltaEl = document.querySelector('[data-revenue-month-delta]');
      const revenueMonthNoteEl = document.querySelector('[data-revenue-month-note]');
      const revenueStatusEl = document.querySelector('[data-revenue-status]');
      let chartDataAll = [];
      let chartDataMap = new Map();
      let chartCursorDate = null;
      let chartLatestDate = todayISO;
      let chartOldestDate = todayISO;
      let chartIsDemo = false;
      let revenueAnalysisContext = { date: null, fallbackDaily: [], entry: null };
      const productChangeCardEl = document.querySelector('[data-product-change-card]');
      const productChangeDateEl = document.querySelector('[data-product-change-date]');
      const productChangeCompareEl = document.querySelector('[data-product-change-compare]');
      const productChangeUpEl = document.querySelector('[data-product-change-up]');
      const productChangeDownEl = document.querySelector('[data-product-change-down]');
      const productChangeStatusEl = document.querySelector('[data-product-change-status]');
      let productChangeContext = { date: null, items: [], options: {}, isDemo: false };

      const renderDayStatus = (message, tone = 'muted') => {
        if (!dayStatusEl) return;
        dayStatusEl.textContent = message || '';
        dayStatusEl.dataset.tone = tone;
      };

      const setAiProductsStatus = (message = '', tone = '') => {
        if (!aiProductsStatusEl) return;
        aiProductsStatusEl.textContent = message || '';
        if (tone) {
          aiProductsStatusEl.dataset.tone = tone;
        } else {
          aiProductsStatusEl.removeAttribute('data-tone');
        }
      };

      const buildProductListItem = ({ name, revenue, quantity }) => {
        const itemEl = document.createElement('li');
        itemEl.className = 'ai-insights__item';
        const nameEl = document.createElement('span');
        nameEl.className = 'ai-insights__product';
        nameEl.textContent = name;
        const metricEl = document.createElement('span');
        metricEl.className = 'ai-insights__metric';
        const parts = [];
        const safeRevenue = Number.isFinite(revenue) ? revenue : 0;
        parts.push(moneyFmt.format(safeRevenue));
        if (Number.isFinite(quantity) && quantity > 0) {
          parts.push(`${qtyFmt.format(quantity)} stk`);
        }
        metricEl.textContent = parts.join(' • ');
        itemEl.append(nameEl, metricEl);
        return itemEl;
      };

      const sanitizeIso = (iso) => {
        if (!iso) return null;
        const value = String(iso).trim();
        return /^\d{4}-\d{2}-\d{2}$/.test(value) ? value : null;
      };

      const parseIsoDate = (iso) => {
        const clean = sanitizeIso(iso);
        if (!clean) return null;
        const parsed = new Date(`${clean}T00:00:00`);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      };

      const formatFriendlyDate = (iso) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return '–';
        const formatted = dateFmtLong.format(parsed);
        return formatted.charAt(0).toUpperCase() + formatted.slice(1);
      };

      const shiftIsoDate = (iso, delta) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return null;
        const shifted = new Date(parsed);
        shifted.setDate(parsed.getDate() + delta);
        return toISODate(shifted);
      };

      const formatSignedCurrency = (value) => {
        if (!Number.isFinite(value)) return '–';
        if (value === 0) return moneyFmt.format(0);
        const abs = Math.abs(value);
        const formatted = moneyFmt.format(abs);
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const formatSignedPercent = (value) => {
        if (!Number.isFinite(value)) return null;
        if (value === 0) return '0 %';
        const formatted = percentFmt.format(Math.abs(value));
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const setDeltaTone = (el, value) => {
        if (!el) return;
        if (!Number.isFinite(value)) {
          el.dataset.tone = 'flat';
          return;
        }
        if (value === 0) {
          el.dataset.tone = 'flat';
        } else {
          el.dataset.tone = value > 0 ? 'up' : 'down';
        }
      };

      const formatSignedQuantity = (value) => {
        if (!Number.isFinite(value) || value === 0) return value === 0 ? '0' : null;
        const formatted = qtyFmt.format(Math.abs(value));
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const normalizeProductItems = (items = []) => {
        const map = new Map();
        items.forEach((entry) => {
          if (!entry) return;
          const name = String(entry?.name || '').trim();
          if (!name) return;
          const key = name.toLowerCase();
          const revenue = Number(entry?.revenue || 0);
          const quantity = Number(entry?.quantity ?? entry?.qty ?? 0);
          const existing = map.get(key) || { name, revenue: 0, quantity: 0 };
          existing.revenue += Number.isFinite(revenue) ? revenue : 0;
          existing.quantity += Number.isFinite(quantity) ? quantity : 0;
          map.set(key, existing);
        });
        return map;
      };

      const computeProductChanges = (currentItems = [], previousItems = []) => {
        const currMap = normalizeProductItems(currentItems);
        const prevMap = normalizeProductItems(previousItems);
        const changes = [];

        currMap.forEach((current, key) => {
          const previous = prevMap.get(key) || { name: current.name, revenue: 0, quantity: 0 };
          const revenueChange = Number(current.revenue || 0) - Number(previous.revenue || 0);
          const quantityChange = Number(current.quantity || 0) - Number(previous.quantity || 0);
          const pctChange = Number(previous.revenue || 0) > 0 ? revenueChange / Number(previous.revenue || 0) : null;
          changes.push({
            key,
            name: current.name,
            revenueCurrent: Number(current.revenue || 0),
            revenuePrevious: Number(previous.revenue || 0),
            revenueChange,
            quantityCurrent: Number(current.quantity || 0),
            quantityPrevious: Number(previous.quantity || 0),
            quantityChange,
            percentChange: pctChange,
          });
          prevMap.delete(key);
        });

        prevMap.forEach((previous, key) => {
          const revenueChange = -Number(previous.revenue || 0);
          const quantityChange = -Number(previous.quantity || 0);
          changes.push({
            key,
            name: previous.name,
            revenueCurrent: 0,
            revenuePrevious: Number(previous.revenue || 0),
            revenueChange,
            quantityCurrent: 0,
            quantityPrevious: Number(previous.quantity || 0),
            quantityChange,
            percentChange: previous.revenue > 0 ? -1 : null,
          });
        });

        const increases = changes
          .filter((entry) => entry.revenueChange > 0)
          .sort((a, b) => b.revenueChange - a.revenueChange);

        const decreases = changes
          .filter((entry) => entry.revenueChange < 0)
          .sort((a, b) => a.revenueChange - b.revenueChange);

        return { increases, decreases };
      };

      const buildProductChangeItem = (entry, { compareLabel } = {}) => {
        const li = document.createElement('li');
        li.className = 'product-change-card__item';
        const tone = entry.revenueChange > 0 ? 'up' : entry.revenueChange < 0 ? 'down' : 'flat';
        li.dataset.tone = tone;

        const nameEl = document.createElement('span');
        nameEl.className = 'product-change-card__name';
        nameEl.textContent = entry.name || 'Ukjent produkt';

        const metricsEl = document.createElement('span');
        metricsEl.className = 'product-change-card__metrics';
        const parts = [];
        const currencyLabel = formatSignedCurrency(entry.revenueChange);
        if (currencyLabel) parts.push(currencyLabel);
        const percentLabel = formatSignedPercent(entry.percentChange);
        if (percentLabel) {
          parts.push(percentLabel);
        } else if (!Number.isFinite(entry.percentChange)) {
          if (entry.revenuePrevious === 0 && entry.revenueCurrent > 0) parts.push('ny');
          if (entry.revenueCurrent === 0 && entry.revenuePrevious > 0) parts.push('ut');
        }
        const quantityLabel = formatSignedQuantity(entry.quantityChange);
        if (quantityLabel && entry.quantityChange !== 0) {
          parts.push(`${quantityLabel} stk`);
        }
        if (parts.length === 0) parts.push('–');
        metricsEl.textContent = parts.join(' • ');

        li.append(nameEl, metricsEl);
        return li;
      };

      const renderProductInsights = (items, { date, state = 'ready', message = '', isDemo = false } = {}) => {
        if (aiProductsDateEl) {
          const parsed = date ? new Date(`${date}T00:00:00`) : null;
          const formatted = parsed && !Number.isNaN(parsed.getTime()) ? dateFmtLong.format(parsed) : (date || '–');
          aiProductsDateEl.textContent = formatted ? `Tall for ${formatted}` : '–';
        }

        if (aiTopListEl) aiTopListEl.innerHTML = '';
        if (aiBottomListEl) aiBottomListEl.innerHTML = '';

        if (state === 'loading') {
          setAiProductsStatus('Henter produktinnsikt …');
          return;
        }

        if (state === 'error') {
          setAiProductsStatus(message || 'Kunne ikke hente produktinnsikt.', 'error');
          return;
        }

        const processed = Array.isArray(items) ? items.map((entry) => ({
          name: String(entry?.name || 'Ukjent produkt'),
          revenue: Number(entry?.revenue || 0),
          quantity: Number(entry?.quantity ?? entry?.qty ?? 0),
        })) : [];

        const meaningful = processed.filter((entry) => entry.revenue !== 0 || entry.quantity !== 0);

        if (!meaningful.length) {
          setAiProductsStatus(message || 'Ingen data for valgt dato.');
          return;
        }

        setAiProductsStatus(isDemo ? 'Viser demo-data for produktsalget.' : '', isDemo ? 'demo' : '');

        const topItems = [...meaningful]
          .sort((a, b) => {
            if (b.revenue !== a.revenue) return b.revenue - a.revenue;
            return b.quantity - a.quantity;
          })
          .slice(0, 5);

        const bottomItems = [...meaningful]
          .sort((a, b) => {
            if (a.revenue !== b.revenue) return a.revenue - b.revenue;
            return a.quantity - b.quantity;
          })
          .slice(0, 5);

        if (aiTopListEl) {
          topItems.forEach((item) => aiTopListEl.appendChild(buildProductListItem(item)));
        }

        if (aiBottomListEl) {
          bottomItems.forEach((item) => aiBottomListEl.appendChild(buildProductListItem(item)));
        }
      };

      const getDailyEntry = (iso, fallback = []) => {
        if (!iso) return null;
        const fromChart = chartDataMap.get(iso);
        if (fromChart) return fromChart;
        return fallback.find((entry) => entry?.date === iso) || null;
      };

      const getMonthEntries = (iso, fallback = []) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return [];
        const year = parsed.getFullYear();
        const month = parsed.getMonth();
        const matches = (entry) => {
          const entryDate = parseIsoDate(entry?.date);
          return entryDate && entryDate.getFullYear() === year && entryDate.getMonth() === month && Number.isFinite(entry?.revenue);
        };
        const fromChart = chartDataAll.filter(matches);
        if (fromChart.length) return fromChart;
        return fallback.filter(matches);
      };

      const renderRevenueAnalysisState = (state, { message = '', date } = {}) => {
        if (!revenueCardEl) return;
        if (revenueDateEl) revenueDateEl.textContent = date ? formatFriendlyDate(date) : '–';
        if (state === 'loading' && revenueComparisonEl) revenueComparisonEl.textContent = '–';
        if (state === 'loading') {
          revenueCurrentEl && (revenueCurrentEl.textContent = '–');
          revenueWeekDeltaEl && (revenueWeekDeltaEl.textContent = '–');
          revenueMonthDeltaEl && (revenueMonthDeltaEl.textContent = '–');
          setDeltaTone(revenueWeekDeltaEl, NaN);
          setDeltaTone(revenueMonthDeltaEl, NaN);
          if (revenueCurrentNoteEl) revenueCurrentNoteEl.textContent = '';
          if (revenueWeekNoteEl) { revenueWeekNoteEl.textContent = 'Henter referanse …'; setDeltaTone(revenueWeekNoteEl, NaN); }
          if (revenueMonthNoteEl) { revenueMonthNoteEl.textContent = 'Henter månedsdata …'; setDeltaTone(revenueMonthNoteEl, NaN); }
          if (revenueStatusEl) revenueStatusEl.textContent = message || 'Analyserer omsetningen …';
          return;
        }
        if (state === 'error') {
          if (revenueComparisonEl) revenueComparisonEl.textContent = '–';
          if (revenueStatusEl) revenueStatusEl.textContent = message || 'Kunne ikke hente omsetningsanalyse.';
          return;
        }
        if (revenueStatusEl) revenueStatusEl.textContent = message || '';
      };

      const renderRevenueAnalysis = ({ date, fallbackDaily = [], entry = null } = {}) => {
        revenueAnalysisContext = { date, fallbackDaily, entry };
        if (!revenueCardEl) return;
        const iso = sanitizeIso(date);
        renderRevenueAnalysisState('ready', { date: iso });
        if (!iso) {
          if (revenueStatusEl) revenueStatusEl.textContent = 'Velg en dato for å se omsetningen.';
          return;
        }

        const currentEntry = entry || getDailyEntry(iso, fallbackDaily);
        if (!currentEntry) {
          renderRevenueAnalysisState('error', { date: iso, message: 'Ingen omsetning registrert for valgt dato.' });
          return;
        }

        const currentRevenue = Number(currentEntry.revenue || 0);
        const currentReceipts = Number(currentEntry.receipts || 0);
        if (revenueCurrentEl) revenueCurrentEl.textContent = moneyFmt.format(currentRevenue);
        if (revenueCurrentNoteEl) {
          revenueCurrentNoteEl.textContent = currentReceipts > 0 ? `${qtyFmt.format(currentReceipts)} kvitteringer` : '';
        }

        const prevIso = sanitizeIso(shiftIsoDate(iso, -7));
        if (revenueComparisonEl) {
          revenueComparisonEl.textContent = prevIso ? `Referanse: ${formatFriendlyDate(prevIso)}` : 'Ingen referanse 7 dager tidligere';
        }
        const prevEntry = prevIso ? getDailyEntry(prevIso, fallbackDaily) : null;
        if (prevEntry && Number.isFinite(prevEntry.revenue)) {
          const prevRevenue = Number(prevEntry.revenue || 0);
          const diff = currentRevenue - prevRevenue;
          const pct = prevRevenue > 0 ? diff / prevRevenue : null;
          if (revenueWeekDeltaEl) {
            revenueWeekDeltaEl.textContent = formatSignedPercent(pct) || formatSignedCurrency(diff);
            setDeltaTone(revenueWeekDeltaEl, diff);
          }
          if (revenueWeekNoteEl) {
            const parts = [moneyFmt.format(prevRevenue)];
            if (currentReceipts > 0 && Number.isFinite(prevEntry.receipts)) {
              parts.push(`${qtyFmt.format(prevEntry.receipts)} kvitt.`);
            }
            revenueWeekNoteEl.textContent = `Forrige uke: ${parts.join(' • ')}`;
            setDeltaTone(revenueWeekNoteEl, diff);
          }
        } else {
          if (revenueWeekDeltaEl) {
            revenueWeekDeltaEl.textContent = '–';
            setDeltaTone(revenueWeekDeltaEl, NaN);
          }
          if (revenueWeekNoteEl) {
            revenueWeekNoteEl.textContent = 'Ingen tall 7 dager tilbake.';
            setDeltaTone(revenueWeekNoteEl, NaN);
          }
        }

        const monthEntries = getMonthEntries(iso, fallbackDaily).filter((item) => Number.isFinite(item?.revenue));
        if (monthEntries.length) {
          const total = monthEntries.reduce((sum, item) => sum + Number(item.revenue || 0), 0);
          const monthAverage = monthEntries.length ? total / monthEntries.length : 0;
          const diffMonth = currentRevenue - monthAverage;
          const pctMonth = monthAverage > 0 ? diffMonth / monthAverage : null;
          if (revenueMonthDeltaEl) {
            revenueMonthDeltaEl.textContent = formatSignedPercent(pctMonth) || formatSignedCurrency(diffMonth);
            setDeltaTone(revenueMonthDeltaEl, diffMonth);
          }
          if (revenueMonthNoteEl) {
            revenueMonthNoteEl.textContent = `Månedssnitt: ${moneyFmt.format(monthAverage)} (${monthEntries.length} dager)`;
            setDeltaTone(revenueMonthNoteEl, diffMonth);
          }
        } else {
          if (revenueMonthDeltaEl) {
            revenueMonthDeltaEl.textContent = '–';
            setDeltaTone(revenueMonthDeltaEl, NaN);
          }
          if (revenueMonthNoteEl) {
            revenueMonthNoteEl.textContent = 'Manglende månedsdata for å beregne snitt.';
            setDeltaTone(revenueMonthNoteEl, NaN);
          }
        }

        if (revenueStatusEl) revenueStatusEl.textContent = '';
      };

      const renderProductChangesState = (state, { date, compareDate, message = '', isDemo = false } = {}) => {
        if (!productChangeCardEl) return;
        if (productChangeDateEl) productChangeDateEl.textContent = date ? formatFriendlyDate(date) : '–';
        if (productChangeCompareEl) productChangeCompareEl.textContent = compareDate ? `Mot ${formatFriendlyDate(compareDate)}` : '–';
        if (productChangeUpEl) productChangeUpEl.innerHTML = '';
        if (productChangeDownEl) productChangeDownEl.innerHTML = '';
        if (state === 'loading') {
          if (productChangeStatusEl) productChangeStatusEl.textContent = message || 'Analyserer salgsendringer …';
          return;
        }
        if (state === 'error') {
          if (productChangeStatusEl) productChangeStatusEl.textContent = message || 'Kunne ikke beregne endringer.';
          return;
        }
        if (productChangeStatusEl) {
          productChangeStatusEl.textContent = message || (isDemo ? 'Viser demo-data for produktendringer.' : '');
        }
      };

      const renderProductChanges = ({ date, compareDate, currentItems = [], previousItems = [], isDemo = false }) => {
        if (!productChangeCardEl) return;
        renderProductChangesState('ready', { date, compareDate, isDemo });
        const { increases, decreases } = computeProductChanges(currentItems, previousItems);
        const hasIncreases = increases.length > 0;
        const hasDecreases = decreases.length > 0;

        if (!hasIncreases && !hasDecreases) {
          renderProductChangesState('error', { date, compareDate, message: 'Ingen endringer i salg mot forrige uke.' });
          return;
        }

        if (productChangeUpEl) {
          const topUps = increases.slice(0, 5);
          if (topUps.length) {
            topUps.forEach((entry) => {
              productChangeUpEl.appendChild(buildProductChangeItem(entry, { compareLabel: compareDate }));
            });
          } else {
            const li = document.createElement('li');
            li.className = 'product-change-card__item';
            li.textContent = 'Ingen produkter økte salget vs forrige uke.';
            productChangeUpEl.appendChild(li);
          }
        }

        if (productChangeDownEl) {
          const topDowns = decreases.slice(0, 5);
          if (topDowns.length) {
            topDowns.forEach((entry) => {
              productChangeDownEl.appendChild(buildProductChangeItem(entry, { compareLabel: compareDate }));
            });
          } else {
            const li = document.createElement('li');
            li.className = 'product-change-card__item';
            li.textContent = 'Ingen produkter falt i salg vs forrige uke.';
            productChangeDownEl.appendChild(li);
          }
        }
      };

      const pickItemsFromResponse = (data) => {
        if (!data) return [];
        if (Array.isArray(data.items)) return data.items;
        if (Array.isArray(data.top)) return data.top;
        if (Array.isArray(data.records)) return data.records;
        return [];
      };

      const loadProductChanges = ({ date, items = [], options = {}, isDemo = false }) => {
        if (!productChangeCardEl) return;
        const iso = sanitizeIso(date);
        const compareIso = iso ? sanitizeIso(shiftIsoDate(iso, -7)) : null;
        renderProductChangesState('loading', { date: iso, compareDate: compareIso });
        productChangeContext = { date: iso, items, options, isDemo };

        if (!iso) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Velg en dato for å se endringer.' });
          return;
        }
        if (!Array.isArray(items) || !items.length) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Ingen produktsalg for datoen.' });
          return;
        }
        if (!compareIso) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Manglet referanse 7 dager tilbake.' });
          return;
        }

        const applyResult = (previousItems, compareIsDemo = false) => {
          if (productChangeContext.date !== iso) return;
          renderProductChanges({
            date: iso,
            compareDate: compareIso,
            currentItems: items,
            previousItems,
            isDemo: isDemo || compareIsDemo,
          });
        };

        const handleError = (error) => {
          if (productChangeContext.date !== iso) return;
          renderProductChangesState('error', {
            date: iso,
            compareDate: compareIso,
            message: error?.body?.message || error?.message || 'Kunne ikke hente referansesalget.',
          });
        };

        fetchDayTotals(compareIso, options)
          .then((data) => {
            const previousItems = pickItemsFromResponse(data);
            applyResult(previousItems, !!options.demo || data?.mode === 'demo');
          })
          .catch((error) => {
            const shouldDemo = !options.demo && error?.status === 400 &&
              (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL');
            if (shouldDemo) {
              fetchDayTotals(compareIso, { demo: true })
                .then((demoData) => {
                  const previousItems = pickItemsFromResponse(demoData);
                  applyResult(previousItems, true);
                })
                .catch(handleError);
              return;
            }
            handleError(error);
          });
      };

      const hideGlobalTooltip = () => {
        if (!chartTooltip) return;
        chartTooltip.dataset.visible = '0';
        chartTooltip.hidden = true;
      };

      const defaultDayHeading = 'Dagens omsetning';

      const renderDayTotals = ({ date, revenue, receipts }, { isDemo = false } = {}) => {
        if (!dayRevenueEl) return;
        const parsed = date ? new Date(`${date}T00:00:00`) : null;
        const friendly = parsed && !Number.isNaN(parsed.getTime()) ? dateFmtLong.format(parsed) : date || '–';
        const revenueValue = Number(revenue || 0);
        const receiptsValue = Number(receipts || 0);
        const averageSale = receiptsValue > 0 ? revenueValue / receiptsValue : null;
        dayRevenueEl.textContent = moneyFmt.format(revenueValue);
        dayReceiptsEl.textContent = qtyFmt.format(receiptsValue);
        if (dayAverageEl) {
          dayAverageEl.textContent = averageSale != null ? moneyFmt.format(averageSale) : '–';
        }
        if (dayHeadingEl) {
          const headingFriendly = friendly && friendly !== '–' ? friendly : todayISO;
          const headingDisplay = (typeof headingFriendly === 'string' && headingFriendly.length)
            ? headingFriendly.charAt(0).toUpperCase() + headingFriendly.slice(1)
            : headingFriendly;
          dayHeadingEl.textContent = `Tall hentet fra ${headingDisplay}`;
        }
        renderDayStatus(isDemo ? `Viser demo for ${friendly} (mangler Lightspeed-nøkler).` : '');
      };

      const fetchDayTotals = (date, { demo = false } = {}) => {
        const url = new URL('/.netlify/functions/lightspeed', apiBase);
        url.searchParams.set('date', date);
        url.searchParams.set('limit', '50');
        if (demo) url.searchParams.set('demo', '1');
        return fetch(url.toString(), { headers: { accept: 'application/json' } })
          .then(async (response) => {
            const payload = await response.json().catch(() => null);
            if (!response.ok) {
              const error = new Error(`HTTP ${response.status}`);
              error.status = response.status;
              error.body = payload;
              throw error;
            }
            return payload;
          });
      };

      const loadDayTotals = (date) => {
        if (!dayRevenueEl) return;
        if (aiProductsPicker && aiProductsPicker.value !== date) {
          aiProductsPicker.value = date;
        }
        dayRevenueEl.textContent = '–';
        dayReceiptsEl.textContent = '–';
        if (dayAverageEl) dayAverageEl.textContent = '–';
        if (dayHeadingEl) dayHeadingEl.textContent = defaultDayHeading;
        renderProductInsights(null, { date, state: 'loading' });
        renderRevenueAnalysisState('loading', { date });
        renderProductChangesState('loading', { date });
        revenueAnalysisContext = { date, fallbackDaily: [], entry: null };
        productChangeContext = { date, items: [], options: {}, isDemo: false };

        let attemptedDemo = false;

        const attempt = (options = {}) => {
          fetchDayTotals(date, options)
            .then((data) => {
              const isDemo = !!options.demo;
              const items = Array.isArray(data?.items) ? data.items : Array.isArray(data?.top) ? data.top : [];
              let selected = data?.dayTotal || null;
              const daily = Array.isArray(data?.daily) ? data.daily : [];
              if (!selected && daily.length) {
                selected = daily.find((d) => d.date === date) || daily[0];
              }
              if (selected) {
                renderDayTotals(selected, { isDemo });
              } else {
                renderDayStatus('Ingen omsetning funnet for valgt dato.');
              }
              renderProductInsights(items, { date, isDemo, message: 'Ingen data for valgt dato.' });
              revenueAnalysisContext = { date, fallbackDaily: daily, entry: selected };
              renderRevenueAnalysis(revenueAnalysisContext);
              productChangeContext = { date, items, options, isDemo };
              loadProductChanges(productChangeContext);
            })
            .catch((error) => {
              console.error('Kunne ikke hente dagsomsetning:', error);
              const allowDemo = !attemptedDemo && error?.status === 400 &&
                (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL');
              if (allowDemo) {
                attemptedDemo = true;
                renderProductInsights(null, { date, state: 'loading' });
                renderRevenueAnalysisState('loading', { date });
                renderProductChangesState('loading', { date });
                attempt({ demo: true });
                return;
              }
              if (attemptedDemo && options.demo && error?.body?.dayTotal) {
                renderDayTotals(error.body.dayTotal, { isDemo: true });
                const items = Array.isArray(error?.body?.items) ? error.body.items : Array.isArray(error?.body?.top) ? error.body.top : [];
                renderProductInsights(items, { date, isDemo: true });
                revenueAnalysisContext = { date, fallbackDaily: Array.isArray(error?.body?.daily) ? error.body.daily : [], entry: error.body.dayTotal };
                renderRevenueAnalysis(revenueAnalysisContext);
                productChangeContext = { date, items, options, isDemo: true };
                loadProductChanges(productChangeContext);
                return;
              }
              renderDayStatus(error?.body?.message || error?.message || 'Feil ved henting av omsetning', 'error');
              renderProductInsights(null, {
                date,
                state: 'error',
                message: error?.body?.message || error?.message || 'Kunne ikke hente produktsalget. Prøv igjen senere.',
              });
              renderRevenueAnalysisState('error', { date, message: error?.body?.message || error?.message || 'Kunne ikke hente omsetningsanalyse.' });
              renderProductChangesState('error', { date, message: error?.body?.message || error?.message || 'Kunne ikke beregne endringer.' });
            });
        };

        attempt();
      };

      if (barChart) {
        barChart.addEventListener('mouseleave', hideGlobalTooltip);
      }

      if (dayPicker) {
        dayPicker.max = todayISO;
        if (!dayPicker.value) dayPicker.value = todayISO;
        loadDayTotals(dayPicker.value);
        dayPicker.addEventListener('change', () => {
          const date = dayPicker.value || todayISO;
          loadDayTotals(date);
        });
      }

      if (aiProductsPicker) {
        aiProductsPicker.max = todayISO;
        if (!aiProductsPicker.value) {
          aiProductsPicker.value = dayPicker?.value || todayISO;
        }
        aiProductsPicker.addEventListener('change', () => {
          const date = aiProductsPicker.value || todayISO;
          if (dayPicker && dayPicker.value !== date) {
            dayPicker.value = date;
          }
          loadDayTotals(date);
        });
      }

      const dailyTableBody = document.querySelector('#daily-sales-body');
      if (dailyTableBody && typeof fetch === 'function') {
        const fallbackHtml = dailyTableBody.innerHTML;

        const renderLoading = () => {
          const loadingRow = document.createElement('tr');
          loadingRow.innerHTML = '<td colspan="3">Henter omsetning …</td>';
          dailyTableBody.innerHTML = '';
          dailyTableBody.appendChild(loadingRow);
        };

      const renderChart = (days, { isDemo = false, message = '' } = {}) => {
        if (!barChart) return;
        barChart.innerHTML = '';
        if (chartTooltip) {
          chartTooltip.hidden = true;
          chartTooltip.dataset.visible = '0';
        }
        if (!Array.isArray(days) || !days.length) {
          barChart.dataset.empty = '1';
          barChart.removeAttribute('data-demo');
          barChart.innerHTML = `<div class="bar-chart__empty">${message || 'Ingen data for valgt dato.'}</div>`;
          return;
          }

          const revenues = days.map(d => Math.max(0, Number(d.revenue || 0)));
          const maxRevenue = Math.max(...revenues, 0) || 1;
          const nonZeroRevenues = revenues.filter(n => n > 0);
          const minRevenue = nonZeroRevenues.length ? Math.min(...nonZeroRevenues) : 0;
          const stretchFactor = 0.6;
          const chartHeight = barChart.clientHeight || 240;
          const maxBarHeight = chartHeight * 0.9;
          const minBarHeight = Math.max(6, chartHeight * 0.05);

          barChart.removeAttribute('data-empty');
          if (isDemo) {
            barChart.dataset.demo = '1';
          } else {
            barChart.removeAttribute('data-demo');
          }

          const showTooltip = (barEl, friendly, revenue) => {
            if (!chartTooltip) return;
            const containerRect = chartCard?.getBoundingClientRect() || barChart.getBoundingClientRect();
            const barRect = barEl.getBoundingClientRect();
            const left = barRect.left + barRect.width / 2 - containerRect.left;
            const top = barRect.top - containerRect.top;
            chartTooltip.textContent = `${friendly}: ${moneyFmt.format(revenue)}`;
            chartTooltip.style.left = `${left}px`;
            chartTooltip.style.top = `${top}px`;
            chartTooltip.hidden = false;
            chartTooltip.dataset.visible = '1';
          };

          const hideTooltip = () => {
            if (!chartTooltip) return;
            chartTooltip.dataset.visible = '0';
            chartTooltip.hidden = true;
          };

          days.forEach((day) => {
            const revenue = Math.max(0, Number(day.revenue || 0));
            let ratio = 0;
            if (revenue > 0) {
              const scaled = (revenue - minRevenue) * stretchFactor;
              ratio = (minRevenue + scaled) / Math.max(maxRevenue, 1);
            }
            ratio = Math.max(0, Math.min(1, ratio));
            const column = document.createElement('div');
            column.className = 'bar__column';
            const columnHeight = Math.max(minBarHeight, ratio * maxBarHeight);
            const fillHeight = Math.max(12, Math.min(maxBarHeight, columnHeight));
            column.style.setProperty('--fill-height', `${fillHeight}px`);
            column.style.setProperty('--track-height', `${maxBarHeight + 12}px`);
            column.dataset.zero = revenue > 0 ? '0' : '1';
            const bar = document.createElement('div');
            bar.className = 'bar';
            const dateObj = day.date ? new Date(`${day.date}T00:00:00`) : null;
            const dayNameRaw = dateObj && !Number.isNaN(dateObj.getTime()) ? weekdayFmt.format(dateObj) : '';
            const dayName = dayNameRaw ? dayNameRaw.replace('.', '').slice(0,3).toUpperCase() : '';
            const dateLabel = dateObj && !Number.isNaN(dateObj.getTime()) ? chartDateFmt.format(dateObj) : (day.date || '');
            const friendly = dateObj && !Number.isNaN(dateObj.getTime()) ? dateFmtLong.format(dateObj) : (day.date || '');
            bar.title = `${friendly}: ${moneyFmt.format(revenue)}`;
            const label = document.createElement('span');
            label.className = 'bar__label';
            label.innerHTML = `<strong>${dayName}</strong><small>${dateLabel}</small>`;
            bar.append(column, label);
            const eventTarget = column;
            const handleEnter = () => showTooltip(bar, friendly, revenue);
            const handleLeave = () => hideTooltip();
            eventTarget.addEventListener('mouseenter', handleEnter);
            eventTarget.addEventListener('mouseleave', handleLeave);
            eventTarget.addEventListener('focus', handleEnter);
            eventTarget.addEventListener('blur', handleLeave);
            eventTarget.tabIndex = 0;
            eventTarget.setAttribute('aria-label', `${friendly}: ${moneyFmt.format(revenue)}`);
            barChart.appendChild(bar);
          });
        };

        const renderRows = (days, { showDemoNotice = false } = {}) => {
          dailyTableBody.innerHTML = '';
          if (!Array.isArray(days) || !days.length) {
            renderError('Ingen data for valgt dato.', { replace: true });
            return;
          }
          if (showDemoNotice) {
            const notice = document.createElement('tr');
            notice.innerHTML = '<td colspan="3">Viser demo-data. Sett Lightspeed-nøkler i Netlify for ekte tall.</td>';
            dailyTableBody.appendChild(notice);
          }
          days.slice(0, 7).forEach((entry) => {
            const dateStr = typeof entry?.date === 'string' ? entry.date : null;
            const displayDate = (() => {
              if (!dateStr) return '–';
              const parsed = new Date(`${dateStr}T00:00:00`);
              if (Number.isNaN(parsed.getTime())) return dateStr;
              return dateFmtShort.format(parsed);
            })();
            const revenue = Number(entry?.revenue || 0);
            const guests = Number(entry?.guests || entry?.guestCount || 0);
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${displayDate}</td>
              <td>${moneyFmt.format(revenue)}</td>
              <td>${guests > 0 ? qtyFmt.format(guests) : '–'}</td>
            `;
            dailyTableBody.appendChild(row);
          });
        };

        const renderError = (message, { replace = false } = {}) => {
          if (replace) dailyTableBody.innerHTML = '';
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="3">${message}</td>`;
          dailyTableBody.appendChild(row);
        };

      const chartWindowDays = 14;

        const addDaysISO = (iso, delta) => {
          const base = iso ? new Date(`${iso}T00:00:00`) : new Date(`${todayISO}T00:00:00`);
          if (Number.isNaN(base.getTime())) return toISODate(new Date(`${todayISO}T00:00:00`));
          base.setDate(base.getDate() + delta);
          return toISODate(base);
        };

        const clampCursorDate = (iso) => {
          const latest = chartDataAll.length ? chartDataAll[0].date : todayISO;
          const oldest = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : latest;
          const earliestEnd = chartDataAll.length >= chartWindowDays ? addDaysISO(oldest, chartWindowDays - 1) : latest;
          let target = iso || latest;
          if (target.localeCompare(latest) > 0) target = latest;
          if (target.localeCompare(earliestEnd) < 0) target = earliestEnd;
          return target;
        };

        const buildChartRange = (endIso) => {
          const cursor = clampCursorDate(endIso);
          const endDate = new Date(`${cursor}T00:00:00`);
          const startDate = new Date(endDate);
          startDate.setDate(startDate.getDate() - (chartWindowDays - 1));
          const range = [];
          for (let i = 0; i < chartWindowDays; i++) {
            const current = new Date(startDate);
            current.setDate(startDate.getDate() + i);
            const iso = toISODate(current);
            const entry = chartDataMap.get(iso) || { date: iso, revenue: 0, guests: 0, receipts: 0 };
            range.push(entry);
          }
          return { cursor, range };
        };

        const updateChartNavButtons = () => {
          if (!chartPrevBtn || !chartNextBtn) return;
          if (!chartDataAll.length) {
            chartPrevBtn.disabled = true;
            chartNextBtn.disabled = true;
            return;
          }
          const latest = chartDataAll[0]?.date || todayISO;
          const oldest = chartDataAll[chartDataAll.length - 1]?.date || latest;
          const earliestEnd = chartDataAll.length >= chartWindowDays ? addDaysISO(oldest, chartWindowDays - 1) : latest;
          chartPrevBtn.disabled = chartCursorDate ? chartCursorDate.localeCompare(earliestEnd) <= 0 : true;
          chartNextBtn.disabled = chartCursorDate ? chartCursorDate.localeCompare(latest) >= 0 : false;
        };

        const renderChartWindow = (endIso, { isDemo = false } = {}) => {
          const { cursor, range } = buildChartRange(endIso);
          chartCursorDate = cursor;
          renderChart(range, { isDemo });
          updateChartNavButtons();
        };

        const shiftChartWindow = (offsetDays) => {
          if (!chartCursorDate) return;
          hideGlobalTooltip();
          const target = addDaysISO(chartCursorDate, offsetDays);
          renderChartWindow(target, { isDemo: chartIsDemo });
        };

        const fromDate = new Date(today);
        fromDate.setDate(fromDate.getDate() - 60);
        const from = toISODate(fromDate);

        const fetchDaily = ({ demo = false } = {}) => {
          const url = new URL('/.netlify/functions/lightspeed', apiBase);
          url.searchParams.set('from', from);
          url.searchParams.set('to', todayISO);
          url.searchParams.set('group', 'daily');
          url.searchParams.set('limit', '90');
          url.searchParams.set('window', '90');
          if (demo) url.searchParams.set('demo', '1');

          return fetch(url.toString(), { headers: { accept: 'application/json' } })
            .then(async (response) => {
              const payload = await response.json().catch(() => null);
              if (!response.ok) {
                const error = new Error(`HTTP ${response.status}`);
                error.status = response.status;
                error.body = payload;
                throw error;
              }
              return payload;
            });
        };

        let attemptedDemoFallback = false;
        renderLoading();
        renderChart([], { message: 'Henter …' });
        updateChartNavButtons();

        const load = (options = {}) => {
          fetchDaily(options)
            .then((data) => {
              const days = Array.isArray(data?.daily) ? data.daily : [];
              const isDemo = !!options.demo || data?.mode === 'demo';
              const sortedDesc = [...days].sort((a, b) => b.date.localeCompare(a.date));
              renderRows(sortedDesc, { showDemoNotice: isDemo });
              chartDataAll = sortedDesc;
              chartDataMap = new Map(sortedDesc.map(entry => [entry.date, entry]));
              chartLatestDate = chartDataAll.length ? chartDataAll[0].date : todayISO;
              chartOldestDate = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : chartLatestDate;
              chartIsDemo = isDemo;
              renderChartWindow(chartLatestDate, { isDemo });
              if (revenueAnalysisContext?.date) {
                renderRevenueAnalysis(revenueAnalysisContext);
              }
            })
            .catch((error) => {
              console.error('Kunne ikke hente daglig omsetning:', error);
              const shouldTryDemo = !attemptedDemoFallback && (
                error?.status === 400 &&
                (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL')
              );
              if (shouldTryDemo) {
                attemptedDemoFallback = true;
                renderLoading();
                load({ demo: true });
                return;
              }
              if (attemptedDemoFallback && options.demo) {
                try {
                  const days = error?.body?.daily || [];
                  const sortedDesc = [...days].sort((a, b) => b.date.localeCompare(a.date));
                  renderRows(sortedDesc, { showDemoNotice: true });
                  chartDataAll = sortedDesc;
                  chartDataMap = new Map(sortedDesc.map(entry => [entry.date, entry]));
                  chartLatestDate = chartDataAll.length ? chartDataAll[0].date : todayISO;
                  chartOldestDate = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : chartLatestDate;
                  chartIsDemo = true;
                  renderChartWindow(chartLatestDate, { isDemo: true });
                  return;
                } catch (_) {
                  /* fall through */
                }
              }
              dailyTableBody.innerHTML = fallbackHtml;
              renderError(
                (error?.body?.message) ? `Kunne ikke hente daglig omsetning: ${error.body.message}`
                  : `Kunne ikke hente daglig omsetning. ${error?.message || ''}`,
                { replace: false }
              );
              chartDataAll = [];
              chartDataMap = new Map();
              chartCursorDate = null;
              chartLatestDate = todayISO;
              chartOldestDate = todayISO;
              chartIsDemo = false;
              renderChart([], { message: error?.body?.message || error?.message || 'Feil ved henting' });
              updateChartNavButtons();
            });
        };

        if (chartPrevBtn) {
          chartPrevBtn.addEventListener('click', () => shiftChartWindow(-chartWindowDays));
        }
        if (chartNextBtn) {
          chartNextBtn.addEventListener('click', () => shiftChartWindow(chartWindowDays));
        }

        load();
      }

      const tripletexSection = document.querySelector('[data-tripletex-config]');
      if (tripletexSection) {
        const resolveTripletexEndpoint = async () => {
          if (resolveTripletexEndpoint.cache) return resolveTripletexEndpoint.cache;
          const candidates = [
            '/.netlify/functions/tripletex',
            '/api/tripletex',
            '/functions/tripletex'
          ];
          for (const base of candidates) {
            try {
              const ping = await fetch(`${base}?ping=1`, { method: 'GET' });
              if (ping.ok) {
                resolveTripletexEndpoint.cache = base;
                return base;
              }
            } catch (_) {
              /* ignore */
            }
          }
          resolveTripletexEndpoint.cache = candidates[0];
          return resolveTripletexEndpoint.cache;
        };

        const sectionConfigRaw = tripletexSection.dataset.tripletexConfig || '{}';
        let sectionConfig = {};
        try { sectionConfig = JSON.parse(sectionConfigRaw); } catch (_) {
          console.warn('Tripletex-config: kunne ikke tolke JSON');
        }

        const products = Object.entries(sectionConfig).map(([key, value]) => ({
          key,
          label: value?.label || key,
          revenueAccount: value?.accounts?.revenue || null,
          costAccount: value?.accounts?.cost || null,
        })).filter((item) => item.revenueAccount || item.costAccount);

        if (!products.length) {
          products.push({ key: 'beer', label: 'Øl', revenueAccount: 'id-289896744', costAccount: 'id-289896742' });
        }

        const accountsParam = [];
        products.forEach((product) => {
          if (product.revenueAccount) accountsParam.push(`${product.key}Revenue|${product.label} salg:${product.revenueAccount}`);
          if (product.costAccount) accountsParam.push(`${product.key}Cost|${product.label} varekost:${product.costAccount}`);
        });

        const year = new Date().getFullYear();
        const fromISO = `${year}-01-01`;
        const lastDayFeb = new Date(year, 2, 0).getDate();
        const toISO = `${year}-02-${String(lastDayFeb).padStart(2, '0')}`;

        const updateProductHeader = (productKey, label) => {
          const card = tripletexSection.querySelector(`[data-tripletex-product="${productKey}"]`);
          const heading = card?.querySelector('[data-tripletex-label]');
          if (card && heading) heading.textContent = `Tripletex · ${label}`;
        };

        products.forEach((product) => updateProductHeader(product.key, product.label));

        const setStatus = (productKey, text, tone = 'muted') => {
          const card = tripletexSection.querySelector(`[data-tripletex-product="${productKey}"]`);
          const statusEl = card?.querySelector('[data-tripletex-status]');
          if (statusEl) {
            statusEl.textContent = text;
            statusEl.dataset.tone = tone;
          }
        };

        const setTable = (productKey, rows) => {
          const card = tripletexSection.querySelector(`[data-tripletex-product="${productKey}"]`);
          const body = card?.querySelector('[data-tripletex-table]');
          if (!body) return;
          body.innerHTML = '';
          if (!rows.length) {
            const emptyRow = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.className = 'muted';
            cell.textContent = 'Ingen transaksjoner i perioden';
            emptyRow.appendChild(cell);
            body.appendChild(emptyRow);
            return;
          }
          rows.forEach((row) => {
            const tr = document.createElement('tr');
            const monthCell = document.createElement('td');
            monthCell.textContent = row.monthLabel;
            const revenueCell = document.createElement('td');
            revenueCell.className = 'numeric';
            revenueCell.textContent = row.revenue;
            const costCell = document.createElement('td');
            costCell.className = 'numeric';
            costCell.textContent = row.cost;
            const marginCell = document.createElement('td');
            marginCell.className = 'numeric';
            if (row.margin == null) {
              marginCell.classList.add('muted');
              marginCell.textContent = '–';
            } else {
              if (row.margin >= 0) marginCell.classList.add('trend-positive');
              else marginCell.classList.add('trend-negative');
              marginCell.textContent = percentFmt.format(row.margin);
            }
            tr.append(monthCell, revenueCell, costCell, marginCell);
            body.appendChild(tr);
          });
        };

        const load = async () => {
          products.forEach((product) => setStatus(product.key, 'Henter …', 'muted'));
          try {
            const base = await resolveTripletexEndpoint();
            const url = new URL(base, window.location.origin);
            url.searchParams.set('from', fromISO);
            url.searchParams.set('to', toISO);
            url.searchParams.set('group', 'month');
            accountsParam.forEach((entry) => url.searchParams.append('accounts', entry));
            const res = await fetch(url.toString(), { headers: { accept: 'application/json' } });
            const text = await res.text();
            let data = {};
            try { data = JSON.parse(text); } catch (_) {}
            if (!res.ok) {
              const message = data?.message || data?.error || res.statusText || text || 'Kunne ikke hente Tripletex-data';
              throw new Error(message);
            }
            const aggregates = Array.isArray(data.accounts) ? data.accounts : [];
            console.groupCollapsed('Tripletex aggregater');
            console.table(aggregates.map((entry) => ({
              key: entry.key,
              label: entry.label,
              total: entry.total,
              totalAbsolute: entry.totalAbsolute,
              months: Object.entries(entry.months || {}).map(([k, v]) => `${k}: ${v.total}`).join(', ')
            })));
            console.groupEnd();
            const aggregateMap = new Map(aggregates.map((entry) => [entry.key, entry]));
            const monthSet = new Set();
            aggregates.forEach((entry) => Object.keys(entry.months || {}).forEach((m) => monthSet.add(m)));
            const sortedMonths = Array.from(monthSet).sort();
            const monthLabelFmt = new Intl.DateTimeFormat('nb-NO', { month: 'long', year: 'numeric' });

            products.forEach((product) => {
              const revenue = product.revenueAccount ? aggregateMap.get(`${product.key}Revenue`) : null;
              const cost = product.costAccount ? aggregateMap.get(`${product.key}Cost`) : null;
              const rows = sortedMonths.map((monthKey) => {
                if (!monthKey || monthKey === 'ukjent') return null;
                const [yearPart, monthPart] = monthKey.split('-');
                const monthDate = new Date(Number(yearPart), Number(monthPart) - 1, 1);
                const monthLabel = monthLabelFmt.format(monthDate);
                const revenueValue = revenue?.months?.[monthKey]?.totalAbsolute || 0;
                const costValue = cost?.months?.[monthKey]?.totalAbsolute || 0;
                const margin = revenueValue > 0 ? (revenueValue - costValue) / revenueValue : null;
                return {
                  monthKey,
                  monthLabel,
                  revenue: moneyFmt.format(revenueValue),
                  cost: moneyFmt.format(costValue),
                  margin,
                };
              }).filter(Boolean);

              setTable(product.key, rows);
              const statusText = `${dateFmtShort.format(new Date(fromISO))} – ${dateFmtShort.format(new Date(toISO))}`;
              setStatus(product.key, statusText);
            });
          } catch (error) {
            console.error('Tripletex aggregation', error);
            products.forEach((product) => {
              setTable(product.key, []);
              setStatus(product.key, String(error.message || error), 'error');
            });
          }
        };

        load();
      }

      const navMobileToggle = document.querySelector('.nav-actions .mobile-toggle');
      const navControls = document.querySelector('.nav-controls');
      const topBar = document.querySelector('.top-bar');
      const mobileThemeSwitch = document.querySelector('.mobile-theme-switch');
      if (navMobileToggle && navControls) {
        navMobileToggle.addEventListener('click', () => {
          const open = !navControls.classList.contains('open');
          navControls.classList.toggle('open', open);
          navMobileToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (mobileThemeSwitch && dashMq.matches) mobileThemeSwitch.hidden = !open;
        });
        const dashMq = window.matchMedia('(max-width: 720px)');
        const resetDash = () => {
          if (!dashMq.matches) {
            navControls.classList.remove('open');
            navMobileToggle.setAttribute('aria-expanded', 'false');
            if (mobileThemeSwitch) mobileThemeSwitch.hidden = false;
          } else {
            if (mobileThemeSwitch) mobileThemeSwitch.hidden = !navControls.classList.contains('open');
          }
        };
        dashMq.addEventListener ? dashMq.addEventListener('change', resetDash) : dashMq.addListener(resetDash);
        resetDash();
      }

      const themeToggleInput = document.querySelector('#dash-theme-toggle');
      if (themeToggleInput) {
        const isDark = document.body.getAttribute('data-theme') !== 'light';
        themeToggleInput.checked = isDark;
        themeToggleInput.addEventListener('change', () => {
          const toDark = themeToggleInput.checked;
          document.body.setAttribute('data-theme', toDark ? 'dark' : 'light');
          if (mobileThemeSwitch) {
            const mobileInput = mobileThemeSwitch.querySelector('input');
            if (mobileInput) mobileInput.checked = toDark;
          }
        });
      }

      if (mobileThemeSwitch) {
        const mobileInput = mobileThemeSwitch.querySelector('input');
        if (mobileInput && themeToggleInput) {
          const syncMobileState = () => {
            mobileInput.checked = themeToggleInput.checked;
          };
          syncMobileState();
          mobileInput.addEventListener('change', () => {
            const toDark = mobileInput.checked;
            document.body.setAttribute('data-theme', toDark ? 'dark' : 'light');
            themeToggleInput.checked = toDark;
          });
          themeToggleInput.addEventListener('change', syncMobileState);
        }
      }

      const languageToggleGroup = document.querySelector('[data-language-toggle]');
      if (languageToggleGroup) {
        languageToggleGroup.addEventListener('click', (event) => {
          const trigger = event.target.closest('[data-lang]');
          if (!trigger) return;
          languageToggleGroup.querySelectorAll('[data-lang]').forEach((btn) => {
            btn.setAttribute('aria-pressed', btn === trigger ? 'true' : 'false');
          });
        });
      }

      if (topBar) {
        let lastScrollY = window.scrollY;
        let ticking = false;
        const threshold = 10;
        const handleScroll = () => {
          const currentY = window.scrollY;
          const delta = currentY - lastScrollY;
          if (Math.abs(delta) > threshold) {
            const shouldHide = currentY > lastScrollY && currentY > 48;
            topBar.dataset.hidden = shouldHide ? '1' : '0';
            lastScrollY = currentY;
          }
          ticking = false;
        };
        window.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(handleScroll);
            ticking = true;
          }
        }, { passive: true });
      }

      const userMenu = document.querySelector('[data-menu]');
      if (userMenu) {
        const trigger = userMenu.querySelector('.user-menu__trigger');
        const panel = userMenu.querySelector('.user-menu__panel');
        const items = Array.from(userMenu.querySelectorAll('.user-menu__item'));

        const setOpen = (open) => {
          userMenu.classList.toggle('open', open);
          trigger.setAttribute('aria-expanded', String(open));
          panel.toggleAttribute('hidden', !open);
          if (open) {
            requestAnimationFrame(() => items[0]?.focus());
          }
        };

        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          const open = !userMenu.classList.contains('open');
          setOpen(open);
        });

        trigger.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            if (!userMenu.classList.contains('open')) {
              setOpen(true);
            } else {
              items[0]?.focus();
            }
          } else if (event.key === 'Escape') {
            setOpen(false);
            trigger.focus();
          }
        });

        items.forEach((item, index) => {
          item.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
              event.preventDefault();
              const direction = event.key === 'ArrowDown' ? 1 : -1;
              const nextIndex = (index + direction + items.length) % items.length;
              items[nextIndex].focus();
            } else if (event.key === 'Escape') {
              setOpen(false);
              trigger.focus();
            }
          });

          item.addEventListener('click', () => {
            setOpen(false);
            trigger.focus();
          });
        });

        document.addEventListener('click', (event) => {
          if (!userMenu.contains(event.target)) {
            setOpen(false);
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && userMenu.classList.contains('open')) {
            setOpen(false);
            trigger.focus();
          }
        });
      }
    })();
  </script>
</body>
</html>
