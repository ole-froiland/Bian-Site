<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Scope Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" />
  <script>
    (function(){
      if(!window.DASHBOARD_API_BASE){
        const explicit = document.documentElement?.getAttribute('data-api-base') || document.body?.getAttribute('data-api-base');
        if(explicit){
          window.DASHBOARD_API_BASE = explicit;
        }else{
          const host = (typeof window !== 'undefined' && window.location) ? window.location.hostname : '';
          const isLocal = ['localhost','127.0.0.1','0.0.0.0','::1'].includes(host);
          if(isLocal){
            window.DASHBOARD_API_BASE = 'http://localhost:8888';
          }else if (typeof window !== 'undefined' && window.location && window.location.origin){
            window.DASHBOARD_API_BASE = window.location.origin;
          }else{
            window.DASHBOARD_API_BASE = 'https://din-side.netlify.app';
          }
        }
      }
    })();
  </script>
  <style>
    :root{
      color-scheme:light;
      --bg-from:#f7f8fc;
      --bg-to:#eef1f7;
      --surface:#ffffff;
      --surface-muted:rgba(255,255,255,0.72);
      --surface-elevated:#ffffff;
      --surface-glass:rgba(255,255,255,0.82);
      --surface-ghost:rgba(255,255,255,0.6);
      --primary:#6C63FF;
      --primary-hover:#5A53E6;
      --primary-pressed:#4D47CC;
      --primary-border:rgba(108,99,255,0.35);
      --text:#0F172A;
      --text-strong:#0F172A;
      --text-muted:#475569;
      --text-subtle:#64748B;
      --text-inverse:#F8FAFC;
      --border:#E2E8F0;
      --border-subtle:rgba(148,163,184,0.4);
      --shadow-xs:0 8px 20px rgba(15,23,42,0.08);
      --shadow-sm:0 12px 28px rgba(15,23,42,0.12);
      --shadow-md:0 18px 42px rgba(15,23,42,0.12);
      --shadow-lg:0 28px 64px rgba(15,23,42,0.16);
      --ring:0 0 0 3px rgba(108,99,255,0.38);
      --ring-offset:0 0 0 5px rgba(255,255,255,0.85);
      --radius-sm:0.75rem;
      --radius-md:1rem;
      --radius-lg:1.5rem;
      --radius-pill:999px;
      --space-1:0.5rem;
      --space-2:0.75rem;
      --space-3:1rem;
      --space-4:1.5rem;
      --space-5:2rem;
      --transition:180ms ease;
    }
    body[data-theme="dark"]{
      color-scheme:dark;
      --bg-from:#0b1020;
      --bg-to:#0b1222;
      --surface:#0f172a;
      --surface-muted:rgba(15,23,42,0.7);
      --surface-elevated:#111c32;
      --surface-glass:rgba(15,23,42,0.8);
      --surface-ghost:rgba(15,23,42,0.62);
      --text:#E2E8F0;
      --text-strong:#F8FAFC;
      --text-muted:#94A3B8;
      --text-subtle:#7C8FAC;
      --text-inverse:#0F172A;
      --border:#1f2937;
      --border-subtle:rgba(30,41,59,0.68);
      --shadow-xs:0 10px 26px rgba(2,6,23,0.42);
      --shadow-sm:0 18px 36px rgba(2,6,23,0.48);
      --shadow-md:0 24px 54px rgba(2,6,23,0.6);
      --shadow-lg:0 32px 80px rgba(2,6,23,0.66);
      --ring-offset:0 0 0 4px rgba(15,23,42,0.85);
    }
    *,*::before,*::after{box-sizing:border-box;}
    html{background:var(--bg-from);}
    body{
      margin:0;
      min-height:100vh;
      font-family:"Inter","SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      line-height:1.6;
      letter-spacing:0.01em;
      color:var(--text);
      background:var(--bg-from);
      position:relative;
      transition:color var(--transition),background var(--transition);
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        radial-gradient(900px 900px at 0% -5%,rgba(108,99,255,0.16),transparent 60%),
        radial-gradient(720px 720px at 95% -10%,rgba(90,83,230,0.14),transparent 65%),
        linear-gradient(180deg,var(--bg-from) 0%,var(--bg-to) 100%);
    }
    body[data-theme="dark"]::before{
      background:
        radial-gradient(880px 880px at 0% -10%,rgba(108,99,255,0.24),transparent 65%),
        radial-gradient(680px 680px at 95% -10%,rgba(76,72,180,0.2),transparent 70%),
        linear-gradient(180deg,var(--bg-from) 0%,var(--bg-to) 100%);
    }
    @media (prefers-reduced-motion:reduce){
      *,*::before,*::after{transition:none!important;animation:none!important;}
    }
    ::selection{background:rgba(108,99,255,0.25);}
    a{color:inherit;text-decoration:none;}
    a:hover{color:var(--primary);}
    img{max-width:100%;display:block;}
    h1,h2,h3,h4{margin:0;color:var(--text-strong);font-weight:600;}
    p{margin:0;color:var(--text);}
    p.muted{color:var(--text-muted);}
    ul{margin:0;padding:0;list-style:none;}
    table{border-collapse:separate;border-spacing:0;width:100%;}
    thead th{font-weight:600;color:var(--text-muted);font-size:0.85rem;text-transform:uppercase;letter-spacing:0.08em;padding-bottom:var(--space-2);}
    tbody td{padding:0.5rem 0;color:var(--text);font-size:0.95rem;border-top:1px solid var(--border);}
    tbody tr:first-child td{border-top:none;}
    button,input,select,label{font:inherit;color:inherit;}
    button{background:none;border:none;padding:0;cursor:pointer;}
    button:disabled{cursor:not-allowed;opacity:0.6;}
    button:focus-visible,[role="button"]:focus-visible,input:focus-visible,select:focus-visible{outline:none;box-shadow:var(--ring);}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .shell{width:100%;max-width:1160px;margin:0 auto;padding-inline:clamp(16px,4vw,56px);}
    main.shell{padding-block:clamp(24px,4vw,56px);}
    .top-bar{
      position:sticky;
      top:0;
      z-index:30;
      background:var(--surface-glass);
      backdrop-filter:saturate(160%) blur(14px);
      border-bottom:1px solid var(--border-subtle);
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
      transition:transform var(--transition),opacity var(--transition),background var(--transition);
    }
    body[data-theme="dark"] .top-bar{
      background:var(--surface-glass);
      box-shadow:0 14px 36px rgba(2,6,23,0.5);
    }
    .top-bar[data-hidden="1"]{transform:translateY(-110%);opacity:0;}
    .top-bar__inner{
      display:flex;
      align-items:center;
      gap:var(--space-3);
      min-height:4.25rem;
      font-family:"Inter","SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .brand{
      display:inline-flex;
      align-items:center;
      justify-content:flex-start;
      font-weight:700;
      font-size:clamp(1.25rem,3vw,1.65rem);
      letter-spacing:0.04em;
      color:var(--primary);
      text-transform:capitalize;
    }
    .brand-title{
      flex:1;
      text-align:center;
      font-size:clamp(1rem,2.2vw,1.25rem);
      font-weight:600;
      color:var(--text-strong);
    }
    .nav-actions{
      display:flex;
      align-items:center;
      gap:var(--space-2);
      margin-left:auto;
      position:relative;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.35rem;
      padding:0.35rem 0.95rem;
      min-height:2.5rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      font-size:0.92rem;
      font-weight:600;
      letter-spacing:0.01em;
      box-shadow:var(--shadow-xs);
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition),transform var(--transition);
    }
    .chip:hover{background:color-mix(in srgb,var(--surface) 82%,var(--primary) 18%);color:var(--text-strong);border-color:var(--primary);transform:translateY(-1px);}
    .chip[aria-pressed="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--text-inverse);
      box-shadow:0 16px 34px rgba(108,99,255,0.26);
    }
    .chip[aria-pressed="true"]:hover{background:var(--primary-hover);}
    .chip:active{background:var(--primary-pressed);color:var(--text-inverse);}
    .chip:focus-visible{box-shadow:var(--ring);}
    .user-menu{position:relative;}
    .user-menu__trigger{
      width:2.75rem;
      height:2.75rem;
      padding:0;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:var(--shadow-xs);
    }
    .user-menu__trigger:hover{background:color-mix(in srgb,var(--surface) 88%,var(--primary) 12%);}
    .user-menu__icon{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;}
    .user-menu__icon span{display:block;width:18px;height:2px;border-radius:999px;background:var(--text);transition:background var(--transition);}
    .user-menu.open .user-menu__icon span{background:var(--primary);}
    .user-menu__panel{
      position:absolute;
      top:calc(100% + 12px);
      right:0;
      min-width:220px;
      background:var(--surface-elevated);
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      box-shadow:var(--shadow-lg);
      padding:var(--space-1) 0;
      opacity:0;
      visibility:hidden;
      transform:translateY(-8px);
      transition:opacity var(--transition),transform var(--transition),visibility var(--transition);
      z-index:40;
    }
    .user-menu.open .user-menu__panel{opacity:1;visibility:visible;transform:translateY(0);}
    .user-menu__section-title{
      font-size:0.72rem;
      font-weight:600;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-muted);
      padding:0 var(--space-3);
      margin-bottom:0.25rem;
    }
    .user-menu__item{
      width:100%;
      padding:0.65rem var(--space-3);
      display:flex;
      align-items:center;
      gap:0.6rem;
      font-size:0.92rem;
      background:none;
      border:none;
      color:var(--text);
      text-align:left;
      transition:background var(--transition),color var(--transition);
    }
    .user-menu__item:hover,
    .user-menu__item:focus-visible{background:color-mix(in srgb,var(--surface) 86%,var(--primary) 14%);color:var(--text-strong);outline:none;}
    .user-menu__item--danger{color:#f87171;}
    .user-menu__separator{height:1px;background:var(--border);margin:0.75rem 0;}
    .mobile-toggle{
      display:none;
      align-items:center;
      gap:0.45rem;
      padding:0.4rem 0.95rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text-strong);
      font-weight:600;
      font-size:0.9rem;
      box-shadow:var(--shadow-xs);
      transition:background var(--transition),border-color var(--transition),color var(--transition);
    }
    .mobile-toggle .dots{display:flex;flex-direction:column;gap:3px;}
    .mobile-toggle .dots span{width:16px;height:2px;border-radius:999px;background:currentColor;}
    .mobile-toggle:hover{background:color-mix(in srgb,var(--surface) 86%,var(--primary) 14%);color:var(--text-strong);border-color:var(--primary);}
    .nav-controls{
      display:inline-flex;
      align-items:center;
      gap:var(--space-2);
      padding:0.35rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface-muted);
      box-shadow:var(--shadow-xs);
    }
    .nav-controls.open{display:flex;}
    .segmented-control{
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      padding:0.25rem;
      border-radius:var(--radius-pill);
      background:var(--surface);
      border:1px solid var(--border);
      box-shadow:var(--shadow-xs);
    }
    .segmented-control__option{
      min-height:2.1rem;
      padding:0.25rem 0.9rem;
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      background:transparent;
      color:var(--text-muted);
      font-size:0.85rem;
      font-weight:600;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .segmented-control__option[aria-pressed="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--text-inverse);
      box-shadow:0 10px 24px rgba(108,99,255,0.28);
    }
    .segmented-control__option:hover{color:var(--text-strong);}
    .segmented-control__option:focus-visible{box-shadow:var(--ring);}
    .theme-switch{
      position:relative;
      display:inline-flex;
      width:54px;
      height:30px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:var(--shadow-xs);
    }
    .theme-switch input{opacity:0;width:0;height:0;position:absolute;}
    .theme-switch .slider{
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:linear-gradient(120deg,rgba(108,99,255,0.16),rgba(108,99,255,0.05));
      transition:background var(--transition),border-color var(--transition);
      padding:4px;
      display:block;
    }
    .theme-switch .thumb{
      position:absolute;
      top:50%;
      left:4px;
      width:22px;
      height:22px;
      border-radius:50%;
      background:var(--surface);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      transform:translateY(-50%);
      transition:transform var(--transition),background var(--transition),border-color var(--transition),color var(--transition);
      box-shadow:var(--shadow-xs);
      color:#FDB813;
    }
    .theme-switch .icon{width:16px;height:16px;}
    .theme-switch .icon.moon{display:none;color:#f8fafc;}
    .theme-switch input:checked + .slider .thumb{
      left:calc(100% - 26px);
      color:#f1f5f9;
      border-color:var(--primary-border);
      background:var(--primary);
    }
    .theme-switch input:checked + .slider{background:linear-gradient(120deg,rgba(93,84,230,0.32),rgba(76,71,204,0.18));}
    .theme-switch input:checked + .slider .icon.sun{display:none;}
    .theme-switch input:checked + .slider .icon.moon{display:block;}
    .theme-switch input:focus-visible + .slider,
    .theme-switch .thumb:focus-visible{box-shadow:var(--ring);}
    nav.sub-nav{
      padding-block-start:clamp(12px,2.4vw,20px);
      padding-block-end:clamp(6px,1.6vw,12px);
      border-bottom:1px solid transparent;
      background:transparent;
    }
    .tablist{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0.4rem;
      padding:0.4rem;
      border:1px solid var(--border);
      border-radius:calc(var(--radius-pill) + 8px);
      background:color-mix(in srgb,var(--surface) 78%,transparent);
      box-shadow:var(--shadow-xs);
      width:fit-content;
      max-width:100%;
      margin-inline:auto;
      overflow-x:auto;
    }
    .tab-button{
      min-height:2.6rem;
      padding:0.5rem 1.3rem;
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      background:transparent;
      color:var(--text-muted);
      font-size:0.95rem;
      font-weight:600;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition),transform var(--transition);
    }
    .tab-button:hover{color:var(--text-strong);}
    .tab-button.active,
    .tab-button[aria-selected="true"]{
      background:var(--primary);
      color:var(--text-inverse);
      border-color:var(--primary);
      box-shadow:0 16px 32px rgba(108,99,255,0.28);
    }
    .tab-button:focus-visible{box-shadow:var(--ring);}
    .tab-panel{
      display:flex;
      flex-direction:column;
      gap:clamp(24px,4vw,36px);
    }
    .tab-panel[hidden]{display:none;}
    .tab-panel> *{width:100%;}
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      padding:clamp(1.5rem,2.8vw,2rem);
      transition:box-shadow var(--transition),transform var(--transition),background var(--transition);
    }
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}
    .card header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:var(--space-2);
      margin-bottom:var(--space-3);
    }
    .card header h2{
      font-size:1.1rem;
      font-weight:600;
      color:var(--text-strong);
    }
    .card header .subtle{
      font-size:0.9rem;
      color:var(--text-muted);
    }
    .stats-grid{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    }
    .chart-stats{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      align-items:stretch;
      width:100%;
    }
    .chart-stat-card{
      padding:var(--space-4);
      display:flex;
      flex-direction:column;
      gap:0.6rem;
    }
    .chart-stat-card__header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:var(--space-2);
      flex-wrap:wrap;
    }
    .chart-stat-card__title{
      margin:0;
      font-size:1.12rem;
      font-weight:700;
      color:var(--text-strong);
      flex:1;
    }
    .chart-stat-card__body{
      display:flex;
      flex-direction:column;
      gap:var(--space-3);
    }
    .chart-stat-card--metric{gap:0.4rem;padding:var(--space-3);}
    .chart-stat-card--metric .chart-stat-card__value{font-size:clamp(1.5rem,2.6vw,2rem);}
    .chart-stat-card--metric .chart-stat-card__status{margin:0;font-size:0.82rem;color:var(--text-muted);} 
    .chart-stat-card--metric .chart-stat-card__status[data-tone="error"]{color:#ef4444;}
    .chart-stat-card--metric .chart-stat-card__status[data-tone="warning"]{color:#fbbf24;}
    .chart-stat-card__eyebrow{
      font-size:0.82rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-muted);
      font-weight:600;
    }
    .chart-stat-card__value{
      font-size:clamp(1.8rem,3vw,2.4rem);
      font-weight:700;
      color:var(--text-strong);
      margin:0;
      transition:color var(--transition);
    }
    .chart-stat-card__value.negative{color:#ef4444;}
    .chart-stat-card__value.positive{color:#16a34a;}
    .chart-stat-card__status{
      margin:0;
      font-size:0.9rem;
      color:var(--text-muted);
    }
    .chart-stat-card__status[data-tone="error"]{color:#f87171;}
    .stat{padding:var(--space-4);}
    .stat h2{font-size:1rem;color:var(--text-muted);font-weight:600;}
    .stat-number{
      font-size:2rem;
      font-weight:700;
      color:var(--text-strong);
      margin-top:0.35rem;
      letter-spacing:-0.01em;
    }
    .stat-sub{
      color:var(--text-muted);
      margin-top:0.35rem;
      font-size:0.95rem;
    }
    .table-card table{font-size:0.95rem;}
    .table-scroll{overflow:auto;max-height:360px;padding-bottom:0.5rem;}
    .table-scroll::-webkit-scrollbar{height:8px;width:8px;}
    .table-scroll::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.4);border-radius:999px;}
    .chart-card .bar-chart{
      position:relative;
      min-height:260px;
      border-radius:var(--radius-md);
      border:1px dashed var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 90%,transparent);
      display:flex;
      align-items:flex-end;
      justify-content:space-evenly;
      gap:0.8rem;
      overflow-x:auto;
      padding:var(--space-4);
    }
    .chart-card .bar-chart[data-empty="1"]{
      align-items:center;
      justify-content:center;
      gap:0;
    }
    .chart-card .bar-chart::-webkit-scrollbar{height:8px;}
    .chart-card .bar-chart::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.35);border-radius:999px;}
    .bar{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:0.6rem;
      min-width:4.4rem;
      flex:1 1 4.4rem;
      --bar-index:0;
    }
    .bar__column{
      position:relative;
      width:100%;
      height:var(--track-height,240px);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:0.35rem 0.35rem;
      border-radius:28px;
      border:0;
      background:transparent;
      transition:transform 160ms ease;
      cursor:pointer;
    }
    .bar__column::after{
      content:"";
      position:relative;
      display:block;
      width:100%;
      height:var(--fill-height,22px);
      border-radius:22px;
      background:linear-gradient(180deg,var(--primary) 0%,var(--primary-hover) 100%);
      transition:height 200ms ease,transform 160ms ease;
    }
    .bar__column[data-zero="1"]::after{
      background:rgba(148,163,184,0.55);
      height:12px;
    }
    .bar__column[data-tone="best"]::after{
      background:linear-gradient(180deg,#34d399 0%,#059669 100%);
    }
    .bar__column[data-tone="worst"]::after{
      background:linear-gradient(180deg,#fda4af 0%,#ef4444 100%);
    }
    .bar__column:hover,
    .bar__column:focus-visible{
      transform:translateY(-6px);
      outline:none;
    }
    .bar__column:hover::after,
    .bar__column:focus-visible::after{
      transform:translateY(-6px);
    }
    .bar__label{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:0.14rem;
      font-size:0.74rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--text-muted);
    }
    .bar__label strong{font-size:0.78rem;color:var(--text-strong);}
    .bar__label small{font-size:0.7rem;color:var(--text-muted);}
    .tripletex-grid{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    }
    .reports-toolbar{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:var(--space-2);
      margin-bottom:var(--space-2);
      width:100%;
      position:relative;
    }
    .reports-range{
      display:flex;
      align-items:center;
      gap:var(--space-1);
      flex-wrap:wrap;
    }
    .reports-range__btn{
      padding:0.35rem 0.75rem;
      border-radius:var(--radius-sm);
      border:1px solid var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 94%,transparent);
      font-weight:600;
      font-size:0.85rem;
      cursor:pointer;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .reports-range__btn.active{
      background:var(--primary);
      color:var(--text-inverse);
      border-color:var(--primary);
      box-shadow:0 8px 18px rgba(108,99,255,0.24);
    }
    .reports-range__btn:focus-visible{outline:none;box-shadow:var(--ring);}
    .reports-range__btn:not(.active):hover{border-color:var(--primary);color:var(--primary-hover);}
    .reports-filter{
      display:flex;
      flex-direction:column;
      gap:var(--space-1);
      width:100%;
      max-width:100%;
      align-items:flex-start;
    }
    .reports-filter[data-open]{
      position:absolute;
      top:calc(100% + var(--space-1));
      left:0;
      background:var(--surface-elevated);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:var(--space-3);
      box-shadow:var(--shadow-lg);
      width:min(100%,360px);
      z-index:50;
      gap:var(--space-2);
    }
    .reports-filter[data-open][data-range-panel="week"]{
      width:min(100%,420px);
    }
    .reports-filter[data-open][data-range-panel="day"]{
      width:min(100%,340px);
    }
    .reports-month-grid,
    .reports-week-grid{
      display:flex;
      align-items:center;
      gap:var(--space-1);
      flex-wrap:nowrap;
      overflow-x:auto;
      padding-bottom:0.35rem;
      margin-bottom:-0.35rem;
      width:100%;
      scrollbar-width:thin;
      scroll-snap-type:x proximity;
      -webkit-overflow-scrolling:touch;
    }
    .reports-filter[data-open] .reports-month-grid,
    .reports-filter[data-open] .reports-week-grid{
      display:flex;
      flex-direction:column;
      gap:var(--space-1);
      max-height:280px;
      padding-right:0.25rem;
      overflow-y:auto;
      overflow-x:hidden;
      flex-wrap:nowrap;
      scroll-snap-type:none;
    }
    .reports-filter[data-open] .reports-day-grid{
      display:flex;
      flex-direction:column;
      gap:var(--space-1);
      max-height:280px;
      padding-right:0.25rem;
      overflow-y:auto;
      overflow-x:hidden;
    }
    .reports-month{
      padding:0.35rem 0.5rem;
      border-radius:var(--radius-sm);
      border:1px solid var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 95%,transparent);
      font-weight:600;
      font-size:0.82rem;
      cursor:pointer;
      scroll-snap-align:start;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .reports-month[data-active="true"],
    .reports-week[data-active="true"]{
      background:color-mix(in srgb,var(--primary) 20%,var(--surface) 80%);
      color:var(--text-strong);
      border-color:var(--primary);
      box-shadow:0 6px 18px rgba(0,0,0,0.16);
    }
    .reports-month[data-available="true"]:not([data-active="true"]),
    .reports-week[data-available="true"]:not([data-active="true"]){
      border-color:var(--border);
      color:var(--text-muted);
      background:color-mix(in srgb,var(--surface) 96%,transparent);
    }
    .reports-month:hover,
    .reports-week:hover{border-color:var(--primary);}
    .reports-week{
      padding:0.35rem 0.5rem;
      border-radius:var(--radius-sm);
      border:1px solid var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 95%,transparent);
      font-weight:600;
      font-size:0.82rem;
      cursor:pointer;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .reports-day{
      padding:0.45rem 0.6rem;
      border-radius:var(--radius-md);
      border:1px solid var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 95%,transparent);
      font-weight:600;
      font-size:0.85rem;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .reports-day[data-active="true"]{
      background:color-mix(in srgb,var(--primary) 20%,var(--surface) 80%);
      color:var(--text-strong);
      border-color:var(--primary);
      box-shadow:0 6px 18px rgba(0,0,0,0.16);
    }
    .reports-day:hover{border-color:var(--primary);}
    .reports-day small{
      font-weight:500;
      color:var(--text-muted);
    }
    .reports-day-controls{
      display:flex;
      gap:var(--space-1);
      width:100%;
      align-items:center;
    }
    .reports-day-input{
      flex:1;
      padding:0.45rem 0.6rem;
      border-radius:var(--radius-sm);
      border:1px solid var(--border-subtle);
      background:color-mix(in srgb,var(--surface) 95%,transparent);
      color:var(--text);
    }
    .reports-day-today{
      padding:0.45rem 0.75rem;
      border-radius:var(--radius-sm);
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--surface) 90%,transparent);
      font-weight:600;
      cursor:pointer;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .reports-day-today:hover{border-color:var(--primary);color:var(--primary-hover);}
    .reports-hint{font-size:0.9rem;color:var(--text-muted);} 
    .tripletex-card h2{font-size:1.05rem;}
    .tripletex-status{font-size:0.85rem;color:var(--text-muted);margin:0;}
    .tripletex-status[data-tone="error"]{color:#dc2626;}
    .tripletex-status[data-tone="muted"]{color:var(--text-muted);}
    .tripletex-table{width:100%;border-collapse:separate;border-spacing:0;font-size:0.9rem;font-variant-numeric:tabular-nums;}
    .tripletex-table thead th{padding-bottom:0.6rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;font-size:0.78rem;letter-spacing:0.08em;border-bottom:1px solid var(--border);text-align:left;}
    .tripletex-table tbody td{padding:0.7rem 0;border-bottom:1px solid var(--border-subtle);}
    .tripletex-table tbody tr:last-child td{border-bottom:none;}
    .tripletex-table .numeric{text-align:right;}
    .tripletex-table .trend-positive{color:#16a34a;}
    .tripletex-table .trend-negative{color:#dc2626;}
    .tripletex-table .muted{color:var(--text-muted);}
    .chart-nav{
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .chart-nav__btn{
      width:2.4rem;
      height:2.4rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      box-shadow:var(--shadow-xs);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .chart-nav__btn:hover{background:color-mix(in srgb,var(--surface) 85%,var(--primary) 15%);border-color:var(--primary);}
    .chart-card header{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:0.75rem 1rem;
    }
    .chart-card header h2{
      margin:0;
    }
    .chart-header__main{
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }
    .chart-week-heading{
      margin:0;
      font-size:1.25rem;
      font-weight:700;
      color:var(--text-strong);
    }
    .chart-meta{
      display:flex;
      flex-wrap:wrap;
      gap:0.45rem 1.2rem;
      font-size:0.85rem;
      color:var(--text-muted);
    }
    .chart-meta__total,
    .chart-meta__average{
      font-weight:600;
      color:var(--text-strong);
    }
    .bar-chart--slide-next .bar,
    .bar-chart--slide-prev .bar{
      animation-duration:280ms;
      animation-timing-function:cubic-bezier(0.22,0.61,0.36,1);
      animation-fill-mode:both;
      animation-delay:calc(var(--bar-index) * 26ms);
    }
    .bar-chart--slide-next .bar{animation-name:chart-slide-next;}
    .bar-chart--slide-prev .bar{animation-name:chart-slide-prev;}
    @keyframes chart-slide-next{
      from{opacity:0;transform:translateX(14%);}
      to{opacity:1;transform:translateX(0);}
    }
    @keyframes chart-slide-prev{
      from{opacity:0;transform:translateX(-14%);}
      to{opacity:1;transform:translateX(0);}
    }
    .chart-tooltip{
      position:absolute;
      transform:translate(-50%,calc(-100% - 18px));
      background:color-mix(in srgb,var(--surface) 94%,rgba(15,23,42,0.85));
      color:var(--text-strong);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:0.6rem 0.9rem;
      box-shadow:0 18px 36px rgba(15,23,42,0.32);
      font-size:0.85rem;
      pointer-events:none;
      min-width:150px;
      text-align:left;
      opacity:0;
      transition:opacity 140ms ease,transform 140ms ease;
    }
    .chart-tooltip[data-visible="1"]{opacity:1;}
    .chart-tooltip strong{display:block;font-size:0.88rem;margin-bottom:0.15rem;}
    .chart-tooltip span{font-size:0.88rem;display:block;}
    .chart-stat-card__controls,
    .daily-summary__controls{display:flex;align-items:center;gap:0.5rem;justify-content:flex-end;flex-shrink:0;}
    .chart-stat-card__input,
    .daily-summary__input{
      appearance:none;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:0.45rem 0.75rem;
      font-size:0.95rem;
      color:var(--text);
      box-shadow:var(--shadow-xs);
      transition:border-color var(--transition),box-shadow var(--transition);
    }
    .chart-stat-card__input:focus-visible,
    .daily-summary__input:focus-visible{border-color:var(--primary);box-shadow:var(--ring);}
    .summary-card{
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.06));
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      padding:var(--space-3);
      box-shadow:var(--shadow-xs);
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }
    .summary-card__label{color:var(--text-muted);font-size:0.9rem;font-weight:500;}
    .summary-card__value{font-size:1.4rem;font-weight:700;color:var(--text-strong);}
    .summary-card__value.fade{color:var(--text-muted);}
    .summary-card__meta{font-size:0.85rem;color:var(--text-muted);}
    .ai-insights-card .ai-insights{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }
    .ai-insights__column h3{font-size:0.95rem;font-weight:600;color:var(--text-muted);}
    .ai-insights__list{
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      margin-top:var(--space-2);
    }
    .ai-section-header{display:flex;align-items:center;justify-content:space-between;gap:var(--space-2);flex-wrap:wrap;margin-bottom:var(--space-3);}
    .ai-section-header__meta{display:flex;align-items:center;gap:var(--space-2);flex-wrap:wrap;}
    .ai-section-header__today{
      padding:0.45rem 0.9rem;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--surface) 90%,transparent);
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      transition:background var(--transition),color var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    .ai-section-header__today:hover{background:color-mix(in srgb,var(--surface) 80%,var(--primary-hover) 20%);border-color:var(--primary);color:var(--text-strong);}
    .ai-section-header__today:focus-visible{outline:none;box-shadow:var(--ring);}
    .ai-insights__list:empty{
      border:1px dashed var(--border);
      border-radius:var(--radius-md);
      padding:1rem;
      align-items:center;
      justify-content:center;
      min-height:4.5rem;
      display:flex;
    }
    .ai-insights__list:empty::before{
      content:"Ingen data for valgt dato.";
      color:var(--text-muted);
      font-size:0.9rem;
    }
    .ai-insights__item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:0.75rem;
      padding:0.7rem 0.9rem;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.05));
      box-shadow:var(--shadow-xs);
      font-size:0.92rem;
    }
    .ai-insights__product{font-weight:600;color:var(--text-strong);}
    .ai-insights__metric{color:var(--text-muted);font-size:0.9rem;}
    .ai-insights__status{
      margin-top:var(--space-3);
      font-size:0.92rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .ai-insights__status::before{
      content:"";
      width:0.75rem;
      height:0.75rem;
      border-radius:50%;
      background:var(--border);
      flex-shrink:0;
    }
    .ai-insights__status[data-tone="error"]{color:#f87171;}
    .ai-insights__status[data-tone="info"]{color:var(--primary);}
    .ai-insights__status[data-tone="demo"]{color:var(--primary);}
    .ai-insights__status:empty{display:none;}
    .ai-insights__status[data-tone="error"]::before{background:#f87171;}
    .ai-insights__status[data-tone="info"]::before{background:var(--primary);}
    .ai-insights__status[data-tone="demo"]::before{background:var(--primary);}
    .revenue-card,.product-change-card{
      display:flex;
      flex-direction:column;
      gap:var(--space-3);
    }
    .revenue-card__grid{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .revenue-card__stat{
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      padding:var(--space-3);
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.05));
      box-shadow:var(--shadow-xs);
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }
    .revenue-card__label{font-size:0.85rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;}
    .revenue-card__value{font-size:1.35rem;font-weight:700;color:var(--text-strong);}
    .revenue-card__delta{font-size:0.9rem;color:var(--text-muted);}
    .revenue-card__delta[data-tone="up"]{color:#22c55e;}
    .revenue-card__delta[data-tone="down"]{color:#f87171;}
    .revenue-card__note{
      font-size:0.92rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .revenue-card__note:empty{display:none;}
    .revenue-card__note::before,
    .product-change-card__status::before,
    .day-status::before{
      content:"";
      width:0.65rem;
      height:0.65rem;
      border-radius:50%;
      background:var(--border);
      flex-shrink:0;
    }
    .revenue-card__note[data-tone="error"]::before,
    .product-change-card__status[data-tone="error"]::before,
    .day-status[data-tone="error"]::before{background:#f87171;}
    .revenue-card__note[data-tone="positive"]::before,
    .product-change-card__status[data-tone="positive"]::before,
    .day-status[data-tone="positive"]::before{background:#22c55e;}
    .revenue-card__note[data-tone="warning"]::before,
    .product-change-card__status[data-tone="warning"]::before,
    .day-status[data-tone="warning"]::before{background:#fbbf24;}
    .product-change-card__columns{
      display:grid;
      gap:var(--space-3);
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }
    .product-change-card__column h3{font-size:0.95rem;font-weight:600;color:var(--text-muted);}
    .product-change-card__list{
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      margin-top:var(--space-2);
    }
    .product-change-card__list:empty{
      border:1px dashed var(--border);
      border-radius:var(--radius-md);
      padding:1rem;
      align-items:center;
      justify-content:center;
      min-height:4.5rem;
      display:flex;
    }
    .product-change-card__list:empty::before{
      content:"Ingen data for valgt dato.";
      color:var(--text-muted);
      font-size:0.9rem;
    }
    .product-change-card__item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:0.75rem;
      padding:0.7rem 0.9rem;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--surface) 82%,rgba(108,99,255,0.05));
      box-shadow:var(--shadow-xs);
      font-size:0.92rem;
    }
    .product-change-card__name{
      font-weight:600;
      color:var(--text-strong);
      flex:1;
      min-width:0;
    }
    .product-change-card__metrics{
      font-size:0.9rem;
      color:var(--text-muted);
      text-align:right;
      white-space:nowrap;
    }
    .product-change-card__item[data-tone="up"] .product-change-card__metrics{color:#22c55e;}
    .product-change-card__item[data-tone="down"] .product-change-card__metrics{color:#f87171;}
    .product-change-card__status{
      font-size:0.92rem;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .product-change-card__status:empty{display:none;}
    .day-status{
      margin-top:var(--space-2);
      font-size:0.9rem;
      color:var(--text-muted);
    }
    .day-status:empty{display:none;}
    .day-status[data-tone="muted"]{color:var(--text-muted);}
    .day-status[data-tone="warning"]{color:#fbbf24;}
    .day-status[data-tone="error"]{color:#f87171;}
    .day-status[data-tone="positive"]{color:#22c55e;}
    .bar-chart__empty{
      font-size:0.95rem;
      color:var(--text-muted);
    }
    @media (max-width:900px){
      .brand-title{text-align:left;}
      .nav-actions{gap:var(--space-1);}
    }
    @media (max-width:720px){
      .top-bar__inner{flex-wrap:wrap;justify-content:space-between;}
      .brand-title{order:3;width:100%;text-align:left;}
      .nav-actions{width:100%;justify-content:space-between;}
      .mobile-toggle{display:inline-flex;}
      .nav-controls{
        position:absolute;
        top:calc(100% + 12px);
        right:clamp(16px,6vw,40px);
        flex-direction:column;
        align-items:stretch;
        gap:var(--space-2);
        padding:var(--space-3);
        border-radius:var(--radius-lg);
        background:var(--surface-elevated);
        box-shadow:var(--shadow-lg);
        min-width:220px;
        display:none;
        z-index:40;
      }
      .nav-controls.open{display:flex;}
      .segmented-control{width:100%;justify-content:space-between;}
      .theme-switch{align-self:flex-start;}
      .chart-stats{grid-template-columns:1fr;}
    }
    @media (min-width:1024px){
      .tab-panel{flex-direction:column;}
    }
  </style>
</head>
<body data-theme="dark">
  <header class="top-bar">
    <div class="shell top-bar__inner">
      <div class="brand">Scope</div>
      <div class="brand-title">Gressholmen Kro</div>
      <div class="nav-actions">
        <div class="user-menu" data-menu>
          <button type="button" id="user-menu-trigger" class="chip user-menu__trigger" aria-haspopup="true" aria-expanded="false" aria-controls="user-menu-panel" aria-label="Konto og innstillinger">
            <span class="sr-only">Din konto</span>
            <span class="user-menu__icon" aria-hidden="true">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </button>
          <div class="user-menu__panel" id="user-menu-panel" role="menu" aria-labelledby="user-menu-trigger" hidden>
            <div class="user-menu__section-title">Konto</div>
            <button type="button" class="user-menu__item" role="menuitem">Betaling &amp; faktura</button>
            <button type="button" class="user-menu__item" role="menuitem">Innstillinger</button>
            <div class="user-menu__separator" role="presentation"></div>
            <button type="button" class="user-menu__item user-menu__item--danger" role="menuitem">Logg ut</button>
          </div>
        </div>
        <button class="mobile-toggle" aria-expanded="false" aria-controls="dash-controls" data-i18n-attr="aria-label:mobile.menu_button">
          <span class="dots" aria-hidden="true"><span></span><span></span><span></span></span>
          <span data-i18n="mobile.menu_button">Meny</span>
        </button>
        <div class="nav-controls" id="dash-controls">
          <div class="segmented-control nav-language" role="group" aria-label="Språk" data-language-toggle>
            <button type="button" class="segmented-control__option" aria-pressed="true" data-lang="no">NO</button>
            <button type="button" class="segmented-control__option" aria-pressed="false" data-lang="en">EN</button>
          </div>
          <label class="theme-switch mobile-theme-switch" aria-label="Bytt tema">
            <input type="checkbox" id="dash-theme-toggle" aria-label="Tema" />
            <span class="slider">
              <span class="thumb">
                <svg class="icon sun" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="5" />
                  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <svg class="icon moon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" />
                </svg>
              </span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </header>
  <nav class="sub-nav">
    <div class="shell">
      <div class="tablist" role="tablist" aria-label="Dashboard faner">
        <button class="tab-button active" id="tab-kpi" type="button" role="tab" aria-selected="true" aria-controls="kpi" data-tab-target="kpi" tabindex="0">Rapporter</button>
        <button class="tab-button" id="tab-oversikt" type="button" role="tab" aria-selected="false" aria-controls="oversikt" data-tab-target="oversikt" tabindex="-1">Oversikt</button>
        <button class="tab-button" id="tab-ai" type="button" role="tab" aria-selected="false" aria-controls="ai-tips" data-tab-target="ai-tips" tabindex="-1">AI-tips</button>
      </div>
    </div>
  </nav>
  <main class="shell">
    <section class="tab-panel active" id="kpi" role="tabpanel" aria-labelledby="tab-kpi" tabindex="0" data-tripletex-config='{"beer":{"label":"Øl","accounts":{"revenue":"id-289896744","cost":"id-289896742"}},"wine":{"label":"Vin","accounts":{"revenue":"id-289896745","cost":"id-289896743"}}}'>
      <div class="reports-toolbar" data-reports-toolbar>
        <div class="reports-range" role="tablist" aria-label="Rapporter periode">
          <button type="button" class="reports-range__btn" data-range="month" aria-selected="false" aria-expanded="false">Måned</button>
          <button type="button" class="reports-range__btn" data-range="week" aria-selected="false" aria-expanded="false">Uke</button>
          <button type="button" class="reports-range__btn" data-range="day" aria-selected="false" aria-expanded="false">Dag</button>
        </div>
        <div class="reports-filter" data-range-panel="month" hidden>
          <div class="reports-month-grid">
            <button type="button" class="reports-month" data-month="01">Jan</button>
            <button type="button" class="reports-month" data-month="02">Feb</button>
            <button type="button" class="reports-month" data-month="03">Mar</button>
            <button type="button" class="reports-month" data-month="04">Apr</button>
            <button type="button" class="reports-month" data-month="05">Mai</button>
            <button type="button" class="reports-month" data-month="06">Jun</button>
            <button type="button" class="reports-month" data-month="07">Jul</button>
            <button type="button" class="reports-month" data-month="08">Aug</button>
            <button type="button" class="reports-month" data-month="09">Sep</button>
            <button type="button" class="reports-month" data-month="10">Okt</button>
            <button type="button" class="reports-month" data-month="11">Nov</button>
            <button type="button" class="reports-month" data-month="12">Des</button>
          </div>
        </div>
        <div class="reports-filter" data-range-panel="week" hidden>
          <div class="reports-week-grid" data-week-grid></div>
        </div>
        <div class="reports-filter" data-range-panel="day" hidden>
          <div class="reports-day-controls">
            <label class="sr-only" for="reports-day-picker">Velg dato</label>
            <input type="date" id="reports-day-picker" class="reports-day-input" data-range-day-input />
            <button type="button" class="reports-day-today" data-range-day-today>I dag</button>
          </div>
          <div class="reports-day-grid" data-day-grid></div>
          <span class="reports-hint">Velg en dag via listen eller dato-feltet.</span>
        </div>
      </div>
      <div class="tripletex-grid">
        <article class="card tripletex-card" data-tripletex-product="beer">
          <header>
            <h2 data-tripletex-label>Tripletex · Øl</h2>
            <p class="tripletex-status" data-tripletex-status>Henter …</p>
          </header>
          <table class="tripletex-table">
            <thead>
              <tr>
                <th>Måned</th>
                <th>Salgsinntekt</th>
                <th>Varekost</th>
                <th>Dekningsgrad</th>
              </tr>
            </thead>
            <tbody data-tripletex-table>
              <tr><td colspan="4" class="muted">Henter …</td></tr>
            </tbody>
          </table>
        </article>
        <article class="card tripletex-card" data-tripletex-product="wine">
          <header>
            <h2 data-tripletex-label>Tripletex · Vin</h2>
            <p class="tripletex-status" data-tripletex-status>Henter …</p>
          </header>
          <table class="tripletex-table">
            <thead>
              <tr>
                <th>Måned</th>
                <th>Salgsinntekt</th>
                <th>Varekost</th>
                <th>Dekningsgrad</th>
              </tr>
            </thead>
            <tbody data-tripletex-table>
              <tr><td colspan="4" class="muted">Henter …</td></tr>
            </tbody>
          </table>
        </article>
      </div>
    </section>
    <section class="tab-panel" id="oversikt" role="tabpanel" aria-labelledby="tab-oversikt" tabindex="0" hidden>
      <div class="chart-stats">
        <article class="card chart-stat-card" data-balance-card>
          <span class="chart-stat-card__eyebrow">Saldo Driftskonto</span>
          <p class="chart-stat-card__value" data-balance-value>–</p>
          <p class="chart-stat-card__status" data-balance-status data-tone="muted">Henter saldo …</p>
        </article>
        <article class="card chart-stat-card chart-stat-card--metric" data-day-card>
          <header class="chart-stat-card__header">
            <span class="chart-stat-card__eyebrow">Dagens omsetning</span>
            <div class="chart-stat-card__controls">
              <label for="sales-day-picker" class="sr-only">Velg dato</label>
              <input type="date" id="sales-day-picker" class="chart-stat-card__input" />
            </div>
          </header>
          <p class="chart-stat-card__value" data-day-revenue>–</p>
          <p class="chart-stat-card__status" data-day-status data-tone="muted">Henter …</p>
        </article>
        <article class="card chart-stat-card chart-stat-card--metric">
          <span class="chart-stat-card__eyebrow">Snitt per kjøp</span>
          <p class="chart-stat-card__value" data-day-average>–</p>
          <p class="chart-stat-card__status" data-day-receipts-status data-tone="muted">Henter …</p>
        </article>
      </div>
      <article class="card chart-card">
        <header>
          <div class="chart-header__main">
            <h2 class="chart-week-heading" data-chart-week-label>Uke –</h2>
            <div class="chart-meta">
              <span class="chart-meta__total" data-chart-week-total>Totalt: –</span>
              <span class="chart-meta__average" data-chart-week-average>Snitt: –</span>
            </div>
          </div>
          <div class="chart-nav">
            <button type="button" class="chart-nav__btn" data-chart-nav="prev" aria-label="Forrige uke">‹</button>
            <button type="button" class="chart-nav__btn" data-chart-nav="next" aria-label="Neste uke">›</button>
          </div>
        </header>
        <div class="bar-chart" data-daily-chart role="img" aria-live="polite" aria-label="Omsetning siste 7 dager"></div>
        <div class="chart-tooltip" data-chart-tooltip hidden></div>
      </article>
    </section>
    <section class="tab-panel" id="ai-tips" role="tabpanel" aria-labelledby="tab-ai" tabindex="0" hidden>
      <div class="ai-section-header">
        <h2>AI-tips</h2>
        <div class="ai-section-header__meta">
          <span data-ai-products-date>–</span>
          <label for="ai-products-picker" class="sr-only">Velg dato for AI-tips</label>
          <input type="date" id="ai-products-picker" class="daily-summary__input ai-insights__input" />
          <button type="button" class="ai-section-header__today" data-ai-today>i dag</button>
        </div>
      </div>
      <article class="card ai-insights-card">
        <div class="ai-insights" data-ai-insights>
          <div class="ai-insights__column">
            <h3>Mest solgte produkter</h3>
            <ul class="ai-insights__list" data-ai-top-list></ul>
          </div>
          <div class="ai-insights__column">
            <h3>Minst solgte produkter</h3>
            <ul class="ai-insights__list" data-ai-bottom-list></ul>
          </div>
        </div>
        <p class="ai-insights__status" data-ai-products-status></p>
      </article>
      <article class="revenue-card" data-revenue-card>
        <header>
          <h2 class="revenue-card__title">Omsetningsanalyse</h2>
          <div class="revenue-card__meta">
            <span data-revenue-date>–</span>
            <span data-revenue-comparison>–</span>
          </div>
        </header>
        <div class="revenue-card__grid">
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Omsetning</span>
            <strong class="revenue-card__value" data-revenue-current>–</strong>
            <span class="revenue-card__delta" data-revenue-current-note></span>
          </div>
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Mot forrige uke</span>
            <strong class="revenue-card__value" data-revenue-week-delta>–</strong>
            <span class="revenue-card__delta" data-revenue-week-note></span>
          </div>
          <div class="revenue-card__stat">
            <span class="revenue-card__label">Mot månedssnitt</span>
            <strong class="revenue-card__value" data-revenue-month-delta>–</strong>
            <span class="revenue-card__delta" data-revenue-month-note></span>
          </div>
        </div>
        <p class="revenue-card__note" data-revenue-status></p>
      </article>
      <article class="product-change-card" data-product-change-card>
        <header>
          <h2 class="product-change-card__title">Produktendringer</h2>
          <div class="product-change-card__meta">
            <span data-product-change-date>–</span>
            <span data-product-change-compare>–</span>
          </div>
        </header>
        <div class="product-change-card__columns">
          <div class="product-change-card__column">
            <h3>Størst vekst</h3>
            <ul class="product-change-card__list" data-product-change-up></ul>
          </div>
          <div class="product-change-card__column">
            <h3>Størst nedgang</h3>
            <ul class="product-change-card__list" data-product-change-down></ul>
          </div>
        </div>
        <p class="product-change-card__status" data-product-change-status></p>
      </article>
    </section>
  </main>
  <script>
    (function() {
      const buttons = Array.from(document.querySelectorAll('.tab-button'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));

      function activateTab(targetId) {
        buttons.forEach((btn) => {
          const isActive = btn.dataset.tabTarget === targetId;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
          btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });

        panels.forEach((panel) => {
          const isMatch = panel.id === targetId;
          panel.classList.toggle('active', isMatch);
          panel.toggleAttribute('hidden', !isMatch);
        });

      }

      // simple tab controller for switching dashboard sections
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
        btn.addEventListener('keydown', (event) => {
          const index = buttons.indexOf(btn);
          if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
            event.preventDefault();
            const direction = event.key === 'ArrowRight' ? 1 : -1;
            const nextIndex = (index + direction + buttons.length) % buttons.length;
            buttons[nextIndex].focus();
          } else if (event.key === 'Home') {
            event.preventDefault();
            buttons[0].focus();
          } else if (event.key === 'End') {
            event.preventDefault();
            buttons[buttons.length - 1].focus();
          }
        });
      });

      const defaultTab = buttons.find((btn) => btn.classList.contains('active'))?.dataset.tabTarget || buttons[0]?.dataset.tabTarget;
      if (defaultTab) {
        activateTab(defaultTab);
      }

      const moneyFmt = new Intl.NumberFormat('nb-NO', { style: 'currency', currency: 'NOK', maximumFractionDigits: 0 });
      const qtyFmt = new Intl.NumberFormat('nb-NO', { maximumFractionDigits: 0 });
      const percentFmt = new Intl.NumberFormat('nb-NO', { style: 'percent', maximumFractionDigits: 0 });
      const dateFmtShort = new Intl.DateTimeFormat('nb-NO', { day: 'numeric', month: 'short' });
      const dateFmtLong = new Intl.DateTimeFormat('nb-NO', { weekday: 'short', day: 'numeric', month: 'short' });

      const apiBase = window.DASHBOARD_API_BASE || (
        (window.location && window.location.origin) ? window.location.origin : 'http://localhost:8888'
      );

      const toISODate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const today = new Date();
      const todayISO = toISODate(today);

      const dayPicker = document.querySelector('#sales-day-picker');
      const dayRevenueEl = document.querySelector('[data-day-revenue]');
      const dayAverageEl = document.querySelector('[data-day-average]');
      const dayStatusEl = document.querySelector('[data-day-status]');
      const dayReceiptsStatusEl = document.querySelector('[data-day-receipts-status]');
      const chartBalanceValueEl = document.querySelector('[data-balance-value]');
      const chartBalanceStatusEl = document.querySelector('[data-balance-status]');
      const barChart = document.querySelector('[data-daily-chart]');
      const chartPrevBtn = document.querySelector('[data-chart-nav="prev"]');
      const chartNextBtn = document.querySelector('[data-chart-nav="next"]');
      const chartWeekLabel = document.querySelector('[data-chart-week-label]');
      const chartWeekTotal = document.querySelector('[data-chart-week-total]');
      const chartWeekAverage = document.querySelector('[data-chart-week-average]');
      const chartTooltip = document.querySelector('[data-chart-tooltip]');
      const chartCard = barChart ? barChart.closest('.chart-card') : null;
      const weekdayFmt = new Intl.DateTimeFormat('nb-NO', { weekday: 'short' });
      const chartDateFmt = new Intl.DateTimeFormat('nb-NO', { day: '2-digit', month: '2-digit' });
      const aiTopListEl = document.querySelector('[data-ai-top-list]');
      const aiBottomListEl = document.querySelector('[data-ai-bottom-list]');
      const aiProductsStatusEl = document.querySelector('[data-ai-products-status]');
      const aiProductsDateEl = document.querySelector('[data-ai-products-date]');
    const aiProductsPicker = document.querySelector('#ai-products-picker');
    const aiTodayBtn = document.querySelector('[data-ai-today]');
    const reportsToolbar = document.querySelector('[data-reports-toolbar]');
      const revenueCardEl = document.querySelector('[data-revenue-card]');
      const revenueDateEl = document.querySelector('[data-revenue-date]');
      const revenueComparisonEl = document.querySelector('[data-revenue-comparison]');
      const revenueCurrentEl = document.querySelector('[data-revenue-current]');
      const revenueCurrentNoteEl = document.querySelector('[data-revenue-current-note]');
      const revenueWeekDeltaEl = document.querySelector('[data-revenue-week-delta]');
      const revenueWeekNoteEl = document.querySelector('[data-revenue-week-note]');
      const revenueMonthDeltaEl = document.querySelector('[data-revenue-month-delta]');
      const revenueMonthNoteEl = document.querySelector('[data-revenue-month-note]');
      const revenueStatusEl = document.querySelector('[data-revenue-status]');
      let chartDataAll = [];
      let chartDataMap = new Map();
      let chartCursorDate = null;
      let chartLatestDate = todayISO;
      let chartOldestDate = todayISO;
      let chartIsDemo = false;
      let chartNavBusy = false;
      let lastDayTotals = null;
      let revenueAnalysisContext = { date: null, fallbackDaily: [], entry: null };
      const productChangeCardEl = document.querySelector('[data-product-change-card]');
      const productChangeDateEl = document.querySelector('[data-product-change-date]');
      const productChangeCompareEl = document.querySelector('[data-product-change-compare]');
      const productChangeUpEl = document.querySelector('[data-product-change-up]');
      const productChangeDownEl = document.querySelector('[data-product-change-down]');
      const productChangeStatusEl = document.querySelector('[data-product-change-status]');
      let productChangeContext = { date: null, items: [], options: {}, isDemo: false };

      const renderDayStatus = (message, tone = 'muted') => {
        if (!dayStatusEl) return;
        dayStatusEl.textContent = message || '';
        dayStatusEl.dataset.tone = tone;
      };

      const setAiProductsStatus = (message = '', tone = '') => {
        if (!aiProductsStatusEl) return;
        aiProductsStatusEl.textContent = message || '';
        if (tone) {
          aiProductsStatusEl.dataset.tone = tone;
        } else {
          aiProductsStatusEl.removeAttribute('data-tone');
        }
      };

      const buildProductListItem = ({ name, revenue, quantity }) => {
        const itemEl = document.createElement('li');
        itemEl.className = 'ai-insights__item';
        const nameEl = document.createElement('span');
        nameEl.className = 'ai-insights__product';
        nameEl.textContent = name;
        const metricEl = document.createElement('span');
        metricEl.className = 'ai-insights__metric';
        const parts = [];
        const safeRevenue = Number.isFinite(revenue) ? revenue : 0;
        parts.push(moneyFmt.format(safeRevenue));
        if (Number.isFinite(quantity) && quantity > 0) {
          parts.push(`${qtyFmt.format(quantity)} stk`);
        }
        metricEl.textContent = parts.join(' • ');
        itemEl.append(nameEl, metricEl);
        return itemEl;
      };

      const sanitizeIso = (iso) => {
        if (!iso) return null;
        const value = String(iso).trim();
        return /^\d{4}-\d{2}-\d{2}$/.test(value) ? value : null;
      };

      const parseIsoDate = (iso) => {
        const clean = sanitizeIso(iso);
        if (!clean) return null;
        const parsed = new Date(`${clean}T00:00:00`);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      };

      const formatFriendlyDate = (iso) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return '–';
        const formatted = dateFmtLong.format(parsed);
        return formatted.charAt(0).toUpperCase() + formatted.slice(1);
      };

      const getISOWeekInfo = (iso) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return null;
        const target = new Date(parsed);
        target.setHours(0, 0, 0, 0);
        const day = target.getDay() === 0 ? 7 : target.getDay();
        target.setDate(target.getDate() + 4 - day);
        const yearStart = new Date(target.getFullYear(), 0, 1);
        const week = Math.ceil((((target - yearStart) / 86400000) + 1) / 7);
        return { week, year: target.getFullYear() };
      };

      const shiftIsoDate = (iso, delta) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return null;
        const shifted = new Date(parsed);
        shifted.setDate(parsed.getDate() + delta);
        return toISODate(shifted);
      };

      const formatSignedCurrency = (value) => {
        if (!Number.isFinite(value)) return '–';
        if (value === 0) return moneyFmt.format(0);
        const abs = Math.abs(value);
        const formatted = moneyFmt.format(abs);
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const formatSignedPercent = (value) => {
        if (!Number.isFinite(value)) return null;
        if (value === 0) return '0 %';
        const formatted = percentFmt.format(Math.abs(value));
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const setDeltaTone = (el, value) => {
        if (!el) return;
        if (!Number.isFinite(value)) {
          el.dataset.tone = 'flat';
          return;
        }
        if (value === 0) {
          el.dataset.tone = 'flat';
        } else {
          el.dataset.tone = value > 0 ? 'up' : 'down';
        }
      };

      const formatSignedQuantity = (value) => {
        if (!Number.isFinite(value) || value === 0) return value === 0 ? '0' : null;
        const formatted = qtyFmt.format(Math.abs(value));
        return value > 0 ? `+${formatted}` : `-${formatted}`;
      };

      const normalizeProductItems = (items = []) => {
        const map = new Map();
        items.forEach((entry) => {
          if (!entry) return;
          const name = String(entry?.name || '').trim();
          if (!name) return;
          const key = name.toLowerCase();
          const revenue = Number(entry?.revenue || 0);
          const quantity = Number(entry?.quantity ?? entry?.qty ?? 0);
          const existing = map.get(key) || { name, revenue: 0, quantity: 0 };
          existing.revenue += Number.isFinite(revenue) ? revenue : 0;
          existing.quantity += Number.isFinite(quantity) ? quantity : 0;
          map.set(key, existing);
        });
        return map;
      };

      const computeProductChanges = (currentItems = [], previousItems = []) => {
        const currMap = normalizeProductItems(currentItems);
        const prevMap = normalizeProductItems(previousItems);
        const changes = [];

        currMap.forEach((current, key) => {
          const previous = prevMap.get(key) || { name: current.name, revenue: 0, quantity: 0 };
          const revenueChange = Number(current.revenue || 0) - Number(previous.revenue || 0);
          const quantityChange = Number(current.quantity || 0) - Number(previous.quantity || 0);
          const pctChange = Number(previous.revenue || 0) > 0 ? revenueChange / Number(previous.revenue || 0) : null;
          changes.push({
            key,
            name: current.name,
            revenueCurrent: Number(current.revenue || 0),
            revenuePrevious: Number(previous.revenue || 0),
            revenueChange,
            quantityCurrent: Number(current.quantity || 0),
            quantityPrevious: Number(previous.quantity || 0),
            quantityChange,
            percentChange: pctChange,
          });
          prevMap.delete(key);
        });

        prevMap.forEach((previous, key) => {
          const revenueChange = -Number(previous.revenue || 0);
          const quantityChange = -Number(previous.quantity || 0);
          changes.push({
            key,
            name: previous.name,
            revenueCurrent: 0,
            revenuePrevious: Number(previous.revenue || 0),
            revenueChange,
            quantityCurrent: 0,
            quantityPrevious: Number(previous.quantity || 0),
            quantityChange,
            percentChange: previous.revenue > 0 ? -1 : null,
          });
        });

        const increases = changes
          .filter((entry) => entry.revenueChange > 0)
          .sort((a, b) => b.revenueChange - a.revenueChange);

        const decreases = changes
          .filter((entry) => entry.revenueChange < 0)
          .sort((a, b) => a.revenueChange - b.revenueChange);

        return { increases, decreases };
      };

      const buildProductChangeItem = (entry, { compareLabel } = {}) => {
        const li = document.createElement('li');
        li.className = 'product-change-card__item';
        const tone = entry.revenueChange > 0 ? 'up' : entry.revenueChange < 0 ? 'down' : 'flat';
        li.dataset.tone = tone;

        const nameEl = document.createElement('span');
        nameEl.className = 'product-change-card__name';
        nameEl.textContent = entry.name || 'Ukjent produkt';

        const metricsEl = document.createElement('span');
        metricsEl.className = 'product-change-card__metrics';
        const parts = [];
        const currencyLabel = formatSignedCurrency(entry.revenueChange);
        if (currencyLabel) parts.push(currencyLabel);
        const percentLabel = formatSignedPercent(entry.percentChange);
        if (percentLabel) {
          parts.push(percentLabel);
        } else if (!Number.isFinite(entry.percentChange)) {
          if (entry.revenuePrevious === 0 && entry.revenueCurrent > 0) parts.push('ny');
          if (entry.revenueCurrent === 0 && entry.revenuePrevious > 0) parts.push('ut');
        }
        const quantityLabel = formatSignedQuantity(entry.quantityChange);
        if (quantityLabel && entry.quantityChange !== 0) {
          parts.push(`${quantityLabel} stk`);
        }
        if (parts.length === 0) parts.push('–');
        metricsEl.textContent = parts.join(' • ');

        li.append(nameEl, metricsEl);
        return li;
      };

      const renderProductInsights = (items, { date, state = 'ready', message = '', isDemo = false } = {}) => {
        if (aiProductsDateEl) {
          const parsed = date ? new Date(`${date}T00:00:00`) : null;
          const formatted = parsed && !Number.isNaN(parsed.getTime()) ? dateFmtLong.format(parsed) : (date || '–');
          aiProductsDateEl.textContent = formatted ? `Tall for ${formatted}` : '–';
        }

        if (aiTopListEl) aiTopListEl.innerHTML = '';
        if (aiBottomListEl) aiBottomListEl.innerHTML = '';

        if (state === 'loading') {
          setAiProductsStatus('Henter produktinnsikt …');
          return;
        }

        if (state === 'error') {
          setAiProductsStatus(message || 'Kunne ikke hente produktinnsikt.', 'error');
          return;
        }

        const processed = Array.isArray(items) ? items.map((entry) => ({
          name: String(entry?.name || 'Ukjent produkt'),
          revenue: Number(entry?.revenue || 0),
          quantity: Number(entry?.quantity ?? entry?.qty ?? 0),
        })) : [];

        const meaningful = processed.filter((entry) => entry.revenue !== 0 || entry.quantity !== 0);

        if (!meaningful.length) {
          setAiProductsStatus(message || 'Ingen data for valgt dato.');
          return;
        }

        setAiProductsStatus(isDemo ? 'Viser demo-data for produktsalget.' : '', isDemo ? 'demo' : '');

        const topItems = [...meaningful]
          .sort((a, b) => {
            if (b.revenue !== a.revenue) return b.revenue - a.revenue;
            return b.quantity - a.quantity;
          })
          .slice(0, 5);

        const bottomItems = [...meaningful]
          .sort((a, b) => {
            if (a.revenue !== b.revenue) return a.revenue - b.revenue;
            return a.quantity - b.quantity;
          })
          .slice(0, 5);

        if (aiTopListEl) {
          topItems.forEach((item) => aiTopListEl.appendChild(buildProductListItem(item)));
        }

        if (aiBottomListEl) {
          bottomItems.forEach((item) => aiBottomListEl.appendChild(buildProductListItem(item)));
        }
      };

      const getDailyEntry = (iso, fallback = []) => {
        if (!iso) return null;
        const fromChart = chartDataMap.get(iso);
        if (fromChart) return fromChart;
        return fallback.find((entry) => entry?.date === iso) || null;
      };

      const getMonthEntries = (iso, fallback = []) => {
        const parsed = parseIsoDate(iso);
        if (!parsed) return [];
        const year = parsed.getFullYear();
        const month = parsed.getMonth();
        const matches = (entry) => {
          const entryDate = parseIsoDate(entry?.date);
          return entryDate && entryDate.getFullYear() === year && entryDate.getMonth() === month && Number.isFinite(entry?.revenue);
        };
        const fromChart = chartDataAll.filter(matches);
        if (fromChart.length) return fromChart;
        return fallback.filter(matches);
      };

      const renderRevenueAnalysisState = (state, { message = '', date } = {}) => {
        if (!revenueCardEl) return;
        if (revenueDateEl) revenueDateEl.textContent = date ? formatFriendlyDate(date) : '–';
        if (state === 'loading' && revenueComparisonEl) revenueComparisonEl.textContent = '–';
        if (state === 'loading') {
          revenueCurrentEl && (revenueCurrentEl.textContent = '–');
          revenueWeekDeltaEl && (revenueWeekDeltaEl.textContent = '–');
          revenueMonthDeltaEl && (revenueMonthDeltaEl.textContent = '–');
          setDeltaTone(revenueWeekDeltaEl, NaN);
          setDeltaTone(revenueMonthDeltaEl, NaN);
          if (revenueCurrentNoteEl) revenueCurrentNoteEl.textContent = '';
          if (revenueWeekNoteEl) { revenueWeekNoteEl.textContent = 'Henter referanse …'; setDeltaTone(revenueWeekNoteEl, NaN); }
          if (revenueMonthNoteEl) { revenueMonthNoteEl.textContent = 'Henter månedsdata …'; setDeltaTone(revenueMonthNoteEl, NaN); }
          if (revenueStatusEl) revenueStatusEl.textContent = message || 'Analyserer omsetningen …';
          return;
        }
        if (state === 'error') {
          if (revenueComparisonEl) revenueComparisonEl.textContent = '–';
          if (revenueStatusEl) revenueStatusEl.textContent = message || 'Kunne ikke hente omsetningsanalyse.';
          return;
        }
        if (revenueStatusEl) revenueStatusEl.textContent = message || '';
      };

      const renderRevenueAnalysis = ({ date, fallbackDaily = [], entry = null } = {}) => {
        revenueAnalysisContext = { date, fallbackDaily, entry };
        if (!revenueCardEl) return;
        const iso = sanitizeIso(date);
        renderRevenueAnalysisState('ready', { date: iso });
        if (!iso) {
          if (revenueStatusEl) revenueStatusEl.textContent = 'Velg en dato for å se omsetningen.';
          return;
        }

        const currentEntry = entry || getDailyEntry(iso, fallbackDaily);
        if (!currentEntry) {
          renderRevenueAnalysisState('error', { date: iso, message: 'Ingen omsetning registrert for valgt dato.' });
          return;
        }

        const currentRevenue = Number(currentEntry.revenue || 0);
        const currentReceipts = Number(currentEntry.receipts || 0);
        if (revenueCurrentEl) revenueCurrentEl.textContent = moneyFmt.format(currentRevenue);
        if (revenueCurrentNoteEl) {
          revenueCurrentNoteEl.textContent = currentReceipts > 0 ? `${qtyFmt.format(currentReceipts)} kvitteringer` : '';
        }

        const prevIso = sanitizeIso(shiftIsoDate(iso, -7));
        if (revenueComparisonEl) {
          revenueComparisonEl.textContent = prevIso ? `Referanse: ${formatFriendlyDate(prevIso)}` : 'Ingen referanse 7 dager tidligere';
        }
        const prevEntry = prevIso ? getDailyEntry(prevIso, fallbackDaily) : null;
        if (prevEntry && Number.isFinite(prevEntry.revenue)) {
          const prevRevenue = Number(prevEntry.revenue || 0);
          const diff = currentRevenue - prevRevenue;
          const pct = prevRevenue > 0 ? diff / prevRevenue : null;
          if (revenueWeekDeltaEl) {
            revenueWeekDeltaEl.textContent = formatSignedPercent(pct) || formatSignedCurrency(diff);
            setDeltaTone(revenueWeekDeltaEl, diff);
          }
          if (revenueWeekNoteEl) {
            const parts = [moneyFmt.format(prevRevenue)];
            if (currentReceipts > 0 && Number.isFinite(prevEntry.receipts)) {
              parts.push(`${qtyFmt.format(prevEntry.receipts)} kvitt.`);
            }
            revenueWeekNoteEl.textContent = `Forrige uke: ${parts.join(' • ')}`;
            setDeltaTone(revenueWeekNoteEl, diff);
          }
        } else {
          if (revenueWeekDeltaEl) {
            revenueWeekDeltaEl.textContent = '–';
            setDeltaTone(revenueWeekDeltaEl, NaN);
          }
          if (revenueWeekNoteEl) {
            revenueWeekNoteEl.textContent = 'Ingen tall 7 dager tilbake.';
            setDeltaTone(revenueWeekNoteEl, NaN);
          }
        }

        const monthEntries = getMonthEntries(iso, fallbackDaily).filter((item) => Number.isFinite(item?.revenue));
        if (monthEntries.length) {
          const total = monthEntries.reduce((sum, item) => sum + Number(item.revenue || 0), 0);
          const monthAverage = monthEntries.length ? total / monthEntries.length : 0;
          const diffMonth = currentRevenue - monthAverage;
          const pctMonth = monthAverage > 0 ? diffMonth / monthAverage : null;
          if (revenueMonthDeltaEl) {
            revenueMonthDeltaEl.textContent = formatSignedPercent(pctMonth) || formatSignedCurrency(diffMonth);
            setDeltaTone(revenueMonthDeltaEl, diffMonth);
          }
          if (revenueMonthNoteEl) {
            revenueMonthNoteEl.textContent = `Månedssnitt: ${moneyFmt.format(monthAverage)} (${monthEntries.length} dager)`;
            setDeltaTone(revenueMonthNoteEl, diffMonth);
          }
        } else {
          if (revenueMonthDeltaEl) {
            revenueMonthDeltaEl.textContent = '–';
            setDeltaTone(revenueMonthDeltaEl, NaN);
          }
          if (revenueMonthNoteEl) {
            revenueMonthNoteEl.textContent = 'Manglende månedsdata for å beregne snitt.';
            setDeltaTone(revenueMonthNoteEl, NaN);
          }
        }

        if (revenueStatusEl) revenueStatusEl.textContent = '';
      };

      const renderProductChangesState = (state, { date, compareDate, message = '', isDemo = false } = {}) => {
        if (!productChangeCardEl) return;
        if (productChangeDateEl) productChangeDateEl.textContent = date ? formatFriendlyDate(date) : '–';
        if (productChangeCompareEl) productChangeCompareEl.textContent = compareDate ? `Mot ${formatFriendlyDate(compareDate)}` : '–';
        if (productChangeUpEl) productChangeUpEl.innerHTML = '';
        if (productChangeDownEl) productChangeDownEl.innerHTML = '';
        if (state === 'loading') {
          if (productChangeStatusEl) productChangeStatusEl.textContent = message || 'Analyserer salgsendringer …';
          return;
        }
        if (state === 'error') {
          if (productChangeStatusEl) productChangeStatusEl.textContent = message || 'Kunne ikke beregne endringer.';
          return;
        }
        if (productChangeStatusEl) {
          productChangeStatusEl.textContent = message || (isDemo ? 'Viser demo-data for produktendringer.' : '');
        }
      };

      const renderProductChanges = ({ date, compareDate, currentItems = [], previousItems = [], isDemo = false }) => {
        if (!productChangeCardEl) return;
        renderProductChangesState('ready', { date, compareDate, isDemo });
        const { increases, decreases } = computeProductChanges(currentItems, previousItems);
        const hasIncreases = increases.length > 0;
        const hasDecreases = decreases.length > 0;

        if (!hasIncreases && !hasDecreases) {
          renderProductChangesState('error', { date, compareDate, message: 'Ingen endringer i salg mot forrige uke.' });
          return;
        }

        if (productChangeUpEl) {
          const topUps = increases.slice(0, 5);
          if (topUps.length) {
            topUps.forEach((entry) => {
              productChangeUpEl.appendChild(buildProductChangeItem(entry, { compareLabel: compareDate }));
            });
          } else {
            const li = document.createElement('li');
            li.className = 'product-change-card__item';
            li.textContent = 'Ingen produkter økte salget vs forrige uke.';
            productChangeUpEl.appendChild(li);
          }
        }

        if (productChangeDownEl) {
          const topDowns = decreases.slice(0, 5);
          if (topDowns.length) {
            topDowns.forEach((entry) => {
              productChangeDownEl.appendChild(buildProductChangeItem(entry, { compareLabel: compareDate }));
            });
          } else {
            const li = document.createElement('li');
            li.className = 'product-change-card__item';
            li.textContent = 'Ingen produkter falt i salg vs forrige uke.';
            productChangeDownEl.appendChild(li);
          }
        }
      };

      const pickItemsFromResponse = (data) => {
        if (!data) return [];
        if (Array.isArray(data.items)) return data.items;
        if (Array.isArray(data.top)) return data.top;
        if (Array.isArray(data.records)) return data.records;
        return [];
      };

      const loadProductChanges = ({ date, items = [], options = {}, isDemo = false }) => {
        if (!productChangeCardEl) return;
        const iso = sanitizeIso(date);
        const compareIso = iso ? sanitizeIso(shiftIsoDate(iso, -7)) : null;
        renderProductChangesState('loading', { date: iso, compareDate: compareIso });
        productChangeContext = { date: iso, items, options, isDemo };

        if (!iso) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Velg en dato for å se endringer.' });
          return;
        }
        if (!Array.isArray(items) || !items.length) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Ingen produktsalg for datoen.' });
          return;
        }
        if (!compareIso) {
          renderProductChangesState('error', { date: iso, compareDate: compareIso, message: 'Manglet referanse 7 dager tilbake.' });
          return;
        }

        const applyResult = (previousItems, compareIsDemo = false) => {
          if (productChangeContext.date !== iso) return;
          renderProductChanges({
            date: iso,
            compareDate: compareIso,
            currentItems: items,
            previousItems,
            isDemo: isDemo || compareIsDemo,
          });
        };

        const handleError = (error) => {
          if (productChangeContext.date !== iso) return;
          renderProductChangesState('error', {
            date: iso,
            compareDate: compareIso,
            message: error?.body?.message || error?.message || 'Kunne ikke hente referansesalget.',
          });
        };

        fetchDayTotals(compareIso, options)
          .then((data) => {
            const previousItems = pickItemsFromResponse(data);
            applyResult(previousItems, !!options.demo || data?.mode === 'demo');
          })
          .catch((error) => {
            const shouldDemo = !options.demo && error?.status === 400 &&
              (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL');
            if (shouldDemo) {
              fetchDayTotals(compareIso, { demo: true })
                .then((demoData) => {
                  const previousItems = pickItemsFromResponse(demoData);
                  applyResult(previousItems, true);
                })
                .catch(handleError);
              return;
            }
            handleError(error);
          });
      };

      const hideGlobalTooltip = () => {
        if (!chartTooltip) return;
        chartTooltip.dataset.visible = '0';
        chartTooltip.hidden = true;
      };

      const defaultDayStatus = 'Henter omsetning …';

      const loadBalanceCard = () => {
        if (!chartBalanceValueEl) return;
        if (typeof fetch !== 'function') {
          if (chartBalanceStatusEl) {
            chartBalanceStatusEl.textContent = 'Nettleseren støtter ikke datahenting.';
            chartBalanceStatusEl.dataset.tone = 'error';
          }
          return;
        }
        chartBalanceValueEl.textContent = '–';
        chartBalanceValueEl.classList.remove('positive', 'negative');
        if (chartBalanceStatusEl) {
          chartBalanceStatusEl.textContent = 'Henter saldo …';
          chartBalanceStatusEl.dataset.tone = 'muted';
        }
        const yearStartISO = `${today.getFullYear()}-01-01`;
        const url = new URL('/.netlify/functions/tripletex', window.location.origin);
        url.searchParams.set('from', yearStartISO);
        url.searchParams.set('to', todayISO);
        url.searchParams.set('accounts', 'balanceOperating|Saldo Driftskonto:id-289892105');
        fetch(url.toString(), { headers: { accept: 'application/json' } })
          .then(async (response) => {
            const payload = await response.json().catch(() => null);
            if (!response.ok) {
              const message = payload?.message || payload?.error || `HTTP ${response.status}`;
              throw new Error(message);
            }
            const entry = Array.isArray(payload?.accounts)
              ? payload.accounts.find((item) => item.key === 'balanceOperating')
              : null;
            if (!entry) throw new Error('Fant ikke driftskontoen i Tripletex-responsen.');
            const balance = Number(entry.total ?? entry.totalAbsolute ?? 0);
            chartBalanceValueEl.textContent = moneyFmt.format(balance);
            chartBalanceValueEl.classList.remove('positive', 'negative');
            if (balance > 0) chartBalanceValueEl.classList.add('positive');
            if (balance < 0) chartBalanceValueEl.classList.add('negative');
            if (chartBalanceStatusEl) {
              chartBalanceStatusEl.textContent = `Per ${dateFmtLong.format(today)}`;
              chartBalanceStatusEl.dataset.tone = 'muted';
            }
          })
          .catch((error) => {
        console.error('Kunne ikke hente saldo for driftskonto:', error);
            chartBalanceValueEl.textContent = '–';
            chartBalanceValueEl.classList.remove('positive', 'negative');
            if (chartBalanceStatusEl) {
              chartBalanceStatusEl.textContent = error?.message || 'Kunne ikke hente saldo';
              chartBalanceStatusEl.dataset.tone = 'error';
            }
          });
      };

      loadBalanceCard();

      const renderDayTotals = ({ date, revenue, receipts }, { isDemo = false, suppressStatus = false, cache = true } = {}) => {
        if (!dayRevenueEl) return;
        const parsed = date ? new Date(`${date}T00:00:00`) : null;
        const friendly = parsed && !Number.isNaN(parsed.getTime()) ? dateFmtLong.format(parsed) : date || '–';
        const revenueValue = Number(revenue || 0);
        const receiptsValue = Number(receipts || 0);
        const averageSale = receiptsValue > 0 ? revenueValue / receiptsValue : null;
        dayRevenueEl.textContent = moneyFmt.format(revenueValue);
        dayRevenueEl.classList.remove('positive', 'negative');
        if (revenueValue > 0) dayRevenueEl.classList.add('positive');
        if (revenueValue < 0) dayRevenueEl.classList.add('negative');
        if (dayAverageEl) {
          dayAverageEl.textContent = averageSale != null ? moneyFmt.format(averageSale) : '–';
        }
        if (!suppressStatus && dayStatusEl) {
          dayStatusEl.textContent = isDemo ? `Per ${friendly} · demo` : `Per ${friendly}`;
          dayStatusEl.dataset.tone = 'muted';
        }
        if (dayReceiptsStatusEl) {
          if (receiptsValue > 0) {
            dayReceiptsStatusEl.textContent = `${qtyFmt.format(receiptsValue)} kvitteringer`;
            dayReceiptsStatusEl.dataset.tone = 'muted';
          } else {
            dayReceiptsStatusEl.textContent = 'Ingen kvitteringer';
            dayReceiptsStatusEl.dataset.tone = 'warning';
          }
        }
        if (cache) {
          lastDayTotals = { date, revenue: revenueValue, receipts: receiptsValue, isDemo };
        }
      };

      const fetchDayTotals = (date, { demo = false } = {}) => {
        const url = new URL('/.netlify/functions/lightspeed', apiBase);
        url.searchParams.set('date', date);
        url.searchParams.set('limit', '50');
        if (demo) url.searchParams.set('demo', '1');
        return fetch(url.toString(), { headers: { accept: 'application/json' } })
          .then(async (response) => {
            const payload = await response.json().catch(() => null);
            if (!response.ok) {
              const error = new Error(`HTTP ${response.status}`);
              error.status = response.status;
              error.body = payload;
              throw error;
            }
            return payload;
          });
      };

      const loadDayTotals = (date) => {
        if (!dayRevenueEl) return;
        if (aiProductsPicker && aiProductsPicker.value !== date) {
          aiProductsPicker.value = date;
        }
        dayRevenueEl.textContent = '–';
        if (dayAverageEl) dayAverageEl.textContent = '–';
        renderDayStatus(defaultDayStatus);
        if (dayReceiptsStatusEl) {
          dayReceiptsStatusEl.textContent = 'Henter …';
          dayReceiptsStatusEl.dataset.tone = 'muted';
        }
        renderProductInsights(null, { date, state: 'loading' });
        renderRevenueAnalysisState('loading', { date });
        renderProductChangesState('loading', { date });
        revenueAnalysisContext = { date, fallbackDaily: [], entry: null };
        productChangeContext = { date, items: [], options: {}, isDemo: false };

        let attemptedDemo = false;

        const attempt = (options = {}) => {
          fetchDayTotals(date, options)
            .then((data) => {
              const isDemo = !!options.demo;
              const items = Array.isArray(data?.items) ? data.items : Array.isArray(data?.top) ? data.top : [];
              let selected = data?.dayTotal || null;
              const daily = Array.isArray(data?.daily) ? data.daily : [];
              if (!selected && daily.length) {
                selected = daily.find((d) => d.date === date) || daily[0];
              }
              if (selected) {
                renderDayTotals(selected, { isDemo });
              } else {
                renderDayStatus('Ingen omsetning funnet for valgt dato.', 'warning');
                if (dayReceiptsStatusEl) {
                  dayReceiptsStatusEl.textContent = 'Ingen kvitteringer';
                  dayReceiptsStatusEl.dataset.tone = 'warning';
                }
              }
              renderProductInsights(items, { date, isDemo, message: 'Ingen data for valgt dato.' });
              revenueAnalysisContext = { date, fallbackDaily: daily, entry: selected };
              renderRevenueAnalysis(revenueAnalysisContext);
              productChangeContext = { date, items, options, isDemo };
              loadProductChanges(productChangeContext);
            })
            .catch((error) => {
              console.error('Kunne ikke hente dagsomsetning:', error);
              const isTimeout = error?.status === 408 || /408/.test(String(error?.message || ''));
              const allowDemo = !attemptedDemo && error?.status === 400 &&
                (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL');
              if (allowDemo) {
                attemptedDemo = true;
                renderDayStatus('Bytter til demo-data …');
                renderProductInsights(null, { date, state: 'loading' });
                renderRevenueAnalysisState('loading', { date });
                renderProductChangesState('loading', { date });
                attempt({ demo: true });
                return;
              }
              if (attemptedDemo && options.demo && error?.body?.dayTotal) {
                renderDayTotals(error.body.dayTotal, { isDemo: true });
                const items = Array.isArray(error?.body?.items) ? error.body.items : Array.isArray(error?.body?.top) ? error.body.top : [];
                renderProductInsights(items, { date, isDemo: true });
                revenueAnalysisContext = { date, fallbackDaily: Array.isArray(error?.body?.daily) ? error.body.daily : [], entry: error.body.dayTotal };
                renderRevenueAnalysis(revenueAnalysisContext);
                productChangeContext = { date, items, options, isDemo: true };
                loadProductChanges(productChangeContext);
                return;
              }
              const fallbackMessage = isTimeout
                ? 'Lightspeed brukte for lang tid. Viser siste kjente tall.'
                : (error?.body?.message || error?.message || 'Feil ved henting av omsetning');
              if (lastDayTotals && sanitizeIso(lastDayTotals.date) === sanitizeIso(date)) {
                renderDayTotals(lastDayTotals, { isDemo: lastDayTotals.isDemo, suppressStatus: true, cache: false });
                renderDayStatus(fallbackMessage, isTimeout ? 'warning' : 'error');
                if (dayReceiptsStatusEl && Number.isFinite(lastDayTotals.receipts)) {
                  if (lastDayTotals.receipts > 0) {
                    dayReceiptsStatusEl.textContent = `${qtyFmt.format(lastDayTotals.receipts)} kvitteringer`;
                    dayReceiptsStatusEl.dataset.tone = isTimeout ? 'warning' : 'muted';
                  } else {
                    dayReceiptsStatusEl.textContent = fallbackMessage;
                    dayReceiptsStatusEl.dataset.tone = isTimeout ? 'warning' : 'error';
                  }
                }
              } else {
                renderDayStatus(fallbackMessage, isTimeout ? 'warning' : 'error');
                if (dayReceiptsStatusEl) {
                  dayReceiptsStatusEl.textContent = fallbackMessage;
                  dayReceiptsStatusEl.dataset.tone = isTimeout ? 'warning' : 'error';
                }
              }
              renderProductInsights(null, {
                date,
                state: 'error',
                message: fallbackMessage,
              });
              renderRevenueAnalysisState('error', { date, message: fallbackMessage });
              renderProductChangesState('error', { date, message: fallbackMessage });
            });
        };

        attempt();
      };

      if (barChart) {
        barChart.addEventListener('mouseleave', hideGlobalTooltip);
      }

      if (dayPicker) {
        dayPicker.max = todayISO;
        if (!dayPicker.value) dayPicker.value = todayISO;
        loadDayTotals(dayPicker.value);
        dayPicker.addEventListener('change', () => {
          const date = dayPicker.value || todayISO;
          loadDayTotals(date);
        });
      }

      if (aiProductsPicker) {
        aiProductsPicker.max = todayISO;
        if (!aiProductsPicker.value) {
          aiProductsPicker.value = dayPicker?.value || todayISO;
        }
        aiProductsPicker.addEventListener('change', () => {
          const date = aiProductsPicker.value || todayISO;
          if (dayPicker && dayPicker.value !== date) {
            dayPicker.value = date;
          }
          loadDayTotals(date);
        });
      }

      if (aiTodayBtn) {
        aiTodayBtn.addEventListener('click', () => {
          if (aiProductsPicker) aiProductsPicker.value = todayISO;
          if (dayPicker) dayPicker.value = todayISO;
          loadDayTotals(todayISO);
        });
      }

      if (typeof fetch === 'function') {
        const renderChart = (days, { isDemo = false, message = '', direction = '' } = {}) => {
          updateWeekSummary(days);
          if (!barChart) return;
          barChart.innerHTML = '';
          if (chartTooltip) {
            chartTooltip.hidden = true;
            chartTooltip.dataset.visible = '0';
          }
          if (!Array.isArray(days) || !days.length) {
            barChart.dataset.empty = '1';
            barChart.removeAttribute('data-demo');
            barChart.innerHTML = `<div class="bar-chart__empty">${message || 'Ingen data for valgt dato.'}</div>`;
            return;
          }

          const revenues = days.map(d => Math.max(0, Number(d.revenue || 0)));
          const maxRevenueRaw = Math.max(...revenues);
          const positiveRevenues = revenues.filter(value => value > 0);
          const maxPositive = positiveRevenues.length ? Math.max(...positiveRevenues) : null;
          const minPositive = positiveRevenues.length > 1 ? Math.min(...positiveRevenues) : null;
          const highlightBest = Number.isFinite(maxPositive);
          const highlightWorst = Number.isFinite(minPositive) && minPositive !== maxPositive;
          const maxRevenue = maxRevenueRaw > 0 ? maxRevenueRaw : 1;
          const chartHeight = barChart.clientHeight || 240;
          const maxBarHeight = chartHeight * 0.8;
          const minBarHeight = Math.max(6, chartHeight * 0.05);

          barChart.removeAttribute('data-empty');
          if (isDemo) {
            barChart.dataset.demo = '1';
          } else {
            barChart.removeAttribute('data-demo');
          }

          const showTooltip = (barEl, friendly, revenue) => {
            if (!chartTooltip) return;
            clearTimeout(chartTooltip._hideTimer);
            const containerRect = chartCard?.getBoundingClientRect() || barChart.getBoundingClientRect();
            const barRect = barEl.getBoundingClientRect();
            const leftRaw = barRect.left + barRect.width / 2 - containerRect.left;
            const topRaw = barRect.top - containerRect.top;
            const maxLeft = containerRect.width - 16;
            const clampedLeft = Math.min(Math.max(leftRaw, 16), maxLeft);
            const clampedTop = Math.max(24, topRaw);
            chartTooltip.innerHTML = `<strong>${friendly}</strong><br><span>${moneyFmt.format(revenue)}</span>`;
            chartTooltip.style.left = `${clampedLeft}px`;
            chartTooltip.style.top = `${clampedTop}px`;
            chartTooltip.hidden = false;
            chartTooltip.dataset.visible = '1';
          };

          const hideTooltip = () => {
            if (!chartTooltip) return;
            chartTooltip.dataset.visible = '0';
            clearTimeout(chartTooltip._hideTimer);
            chartTooltip._hideTimer = setTimeout(() => {
              chartTooltip.hidden = true;
            }, 160);
          };

          days.forEach((day, index) => {
            const revenue = Math.max(0, Number(day.revenue || 0));
            const ratio = maxRevenue > 0 ? Math.max(0, Math.min(1, revenue / maxRevenue)) : 0;
            const column = document.createElement('div');
            column.className = 'bar__column';
            const columnHeight = Math.max(minBarHeight, ratio * maxBarHeight);
            const fillHeight = revenue > 0
              ? Math.max(20, Math.min(maxBarHeight, columnHeight))
              : 12;
            column.style.setProperty('--fill-height', `${fillHeight}px`);
            column.style.setProperty('--track-height', `${chartHeight}px`);
            column.dataset.zero = revenue > 0 ? '0' : '1';
            if (highlightBest && revenue === maxPositive) {
              column.dataset.tone = 'best';
            } else if (highlightWorst && revenue === minPositive) {
              column.dataset.tone = 'worst';
            }
            const bar = document.createElement('div');
            bar.className = 'bar';
            const dateObj = day.date ? new Date(`${day.date}T00:00:00`) : null;
            const dayNameRaw = dateObj && !Number.isNaN(dateObj.getTime()) ? weekdayFmt.format(dateObj) : '';
            const dayName = dayNameRaw ? dayNameRaw.replace('.', '').slice(0,3).toUpperCase() : '';
            const dateLabel = dateObj && !Number.isNaN(dateObj.getTime()) ? chartDateFmt.format(dateObj) : (day.date || '');
            const friendly = dateObj && !Number.isNaN(dateObj.getTime()) ? dateFmtLong.format(dateObj) : (day.date || '');
            const label = document.createElement('span');
            label.className = 'bar__label';
            label.innerHTML = `<strong>${dayName}</strong><small>${dateLabel}</small>`;
            bar.append(column, label);
            bar.style.setProperty('--bar-index', index);
            const eventTarget = column;
            const handleEnter = () => showTooltip(bar, friendly, revenue);
            const handleLeave = () => hideTooltip();
            eventTarget.addEventListener('mouseenter', handleEnter);
            eventTarget.addEventListener('mouseleave', handleLeave);
            eventTarget.addEventListener('focus', handleEnter);
            eventTarget.addEventListener('blur', handleLeave);
            eventTarget.tabIndex = 0;
            eventTarget.setAttribute('aria-label', `${friendly}: ${moneyFmt.format(revenue)}`);
            barChart.appendChild(bar);
          });
          triggerChartTransition(direction);
        };

        const FAST_SPAN_DAYS = 63;
        const HISTORY_PREFETCH_BUFFER_DAYS = 21;
        let historyPrefetchPromise = null;

        const updateWeekSummary = (range = []) => {
          if (!chartWeekLabel && !chartWeekTotal && !chartWeekAverage) return;
          if (!Array.isArray(range) || !range.length) {
            if (chartWeekLabel) chartWeekLabel.textContent = 'Uke –';
            if (chartWeekTotal) chartWeekTotal.textContent = 'Totalt: –';
            if (chartWeekAverage) chartWeekAverage.textContent = 'Snitt: –';
            return;
          }
          const last = range[range.length - 1];
          const first = range[0];
          const weekInfo = getISOWeekInfo(last?.date || first?.date);
          const weekNumber = weekInfo ? String(weekInfo.week).padStart(2, '0') : null;
          if (chartWeekLabel) {
            chartWeekLabel.textContent = weekNumber ? `Uke ${weekNumber}` : 'Uke –';
          }
          const totalRevenue = range.reduce((sum, entry) => {
            const value = Number(entry?.revenue || 0);
            return sum + (Number.isFinite(value) ? Math.max(0, value) : 0);
          }, 0);
          if (chartWeekTotal) {
            chartWeekTotal.textContent = `Totalt: ${moneyFmt.format(totalRevenue)}`;
          }
          if (chartWeekAverage) {
            const average = range.length ? totalRevenue / range.length : 0;
            chartWeekAverage.textContent = `Snitt: ${moneyFmt.format(average)}`;
          }
        };

        const triggerChartTransition = (direction) => {
          if (!barChart || !direction) return;
          const className = direction === 'next'
            ? 'bar-chart--slide-next'
            : direction === 'prev'
              ? 'bar-chart--slide-prev'
              : '';
          if (!className) return;
          barChart.classList.remove('bar-chart--slide-next', 'bar-chart--slide-prev');
          void barChart.offsetWidth;
          barChart.classList.add(className);
          clearTimeout(barChart._slideTimer);
          barChart._slideTimer = setTimeout(() => {
            barChart.classList.remove(className);
            barChart._slideTimer = null;
          }, 360);
        };

        const mergeDailyPayload = (payload, { replace = false } = {}) => {
          const days = Array.isArray(payload?.daily) ? payload.daily : [];
          const workingMap = replace ? new Map() : new Map(chartDataMap);
          days.forEach((entry) => {
            if (!entry?.date) return;
            workingMap.set(entry.date, entry);
          });
          const sortedDesc = Array.from(workingMap.values())
            .sort((a, b) => b.date.localeCompare(a.date));
          chartDataAll = sortedDesc;
          chartDataMap = new Map(sortedDesc.map((entry) => [entry.date, entry]));
          chartLatestDate = sortedDesc.length ? sortedDesc[0].date : todayISO;
          chartOldestDate = sortedDesc.length ? sortedDesc[sortedDesc.length - 1].date : chartLatestDate;
          return {
            sortedDesc,
            isDemo: payload?.mode === 'demo',
          };
        };

        const loadHistoricalData = async (minIso, { demo = chartIsDemo } = {}) => {
          if (!minIso || !chartDataAll.length) return { isDemo: false };
          let normalizedMin = minIso;
          if (normalizedMin.localeCompare(from) < 0) normalizedMin = from;
          const currentOldest = chartOldestDate;
          if (!currentOldest || currentOldest.localeCompare(normalizedMin) <= 0) {
            return { isDemo: false };
          }
          const buffered = addDaysISO(normalizedMin, -HISTORY_PREFETCH_BUFFER_DAYS);
          if (buffered && buffered.localeCompare(from) > 0) {
            normalizedMin = buffered;
          } else {
            normalizedMin = from;
          }
          const chunkEnd = addDaysISO(currentOldest, -1);
          if (!chunkEnd || chunkEnd.localeCompare(normalizedMin) < 0) {
            return { isDemo: false };
          }
          const payload = await fetchDaily({ demo, fromISO: normalizedMin, toISO: chunkEnd });
          const { isDemo } = mergeDailyPayload(payload, { replace: false });
          return { isDemo };
        };

      const chartWindowDays = 7;

        const startOfWeekISO = (iso) => {
          const base = parseIsoDate(iso) || parseIsoDate(todayISO);
          if (!base) return todayISO;
          const day = base.getDay();
          const offset = day === 0 ? -6 : (1 - day);
          const monday = new Date(base);
          monday.setDate(base.getDate() + offset);
          return toISODate(monday);
        };

        const endOfWeekISO = (iso) => {
          const monday = parseIsoDate(startOfWeekISO(iso));
          if (!monday) return todayISO;
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + (chartWindowDays - 1));
          return toISODate(sunday);
        };

        const addDaysISO = (iso, delta) => {
          const base = iso ? new Date(`${iso}T00:00:00`) : new Date(`${todayISO}T00:00:00`);
          if (Number.isNaN(base.getTime())) return toISODate(new Date(`${todayISO}T00:00:00`));
          base.setDate(base.getDate() + delta);
          return toISODate(base);
        };

        const clampCursorDate = (iso) => {
          const latestActual = chartDataAll.length ? chartDataAll[0].date : todayISO;
          const oldestActual = chartDataAll.length ? chartDataAll[chartDataAll.length - 1].date : latestActual;
          const latestEnd = endOfWeekISO(latestActual);
          const earliestCandidate = chartDataAll.length >= chartWindowDays
            ? addDaysISO(oldestActual, chartWindowDays - 1)
            : latestActual;
          const earliestEnd = endOfWeekISO(earliestCandidate);
          let target = iso || latestEnd;
          if (target.localeCompare(latestEnd) > 0) target = latestEnd;
          if (target.localeCompare(earliestEnd) < 0) target = earliestEnd;
          return endOfWeekISO(target);
        };

        const buildChartRange = (endIso) => {
          const cursor = clampCursorDate(endIso);
          const endDate = parseIsoDate(cursor) || parseIsoDate(todayISO);
          const startDate = (() => {
            const monday = parseIsoDate(startOfWeekISO(cursor));
            if (monday) return monday;
            if (!endDate) return null;
            const fallback = new Date(endDate);
            fallback.setDate(endDate.getDate() - (chartWindowDays - 1));
            return fallback;
          })();
          const range = [];
          if (!endDate || !startDate) return { cursor, range };
          for (let i = 0; i < chartWindowDays; i++) {
            const current = new Date(startDate);
            current.setDate(startDate.getDate() + i);
            const iso = toISODate(current);
            const entry = chartDataMap.get(iso) || { date: iso, revenue: 0, guests: 0, receipts: 0 };
            range.push(entry);
          }
          return { cursor, range };
        };

        const updateChartNavButtons = () => {
          if (!chartPrevBtn || !chartNextBtn) return;
          if (chartNavBusy) {
            chartPrevBtn.disabled = true;
            chartNextBtn.disabled = true;
            return;
          }
          if (!chartDataAll.length) {
            chartPrevBtn.disabled = true;
            chartNextBtn.disabled = true;
            return;
          }
          const latestActual = chartDataAll[0]?.date || todayISO;
          const oldestActual = chartDataAll[chartDataAll.length - 1]?.date || latestActual;
          const latestEnd = endOfWeekISO(latestActual);
          const earliestCandidate = chartDataAll.length >= chartWindowDays
            ? addDaysISO(oldestActual, chartWindowDays - 1)
            : latestActual;
          const earliestEnd = endOfWeekISO(earliestCandidate);
          const cursorEnd = chartCursorDate || latestEnd;
          chartPrevBtn.disabled = cursorEnd.localeCompare(earliestEnd) <= 0;
          chartNextBtn.disabled = cursorEnd.localeCompare(latestEnd) >= 0;
        };

        const renderChartWindow = (endIso, { isDemo = false, direction = '' } = {}) => {
          const { cursor, range } = buildChartRange(endIso);
          chartCursorDate = cursor;
          renderChart(range, { isDemo, direction });
          updateChartNavButtons();
        };

        const shiftChartWindow = (offsetDays) => {
          if (!chartCursorDate || chartNavBusy) return;
          chartNavBusy = true;
          if (chartPrevBtn) chartPrevBtn.disabled = true;
          if (chartNextBtn) chartNextBtn.disabled = true;
          hideGlobalTooltip();
          const targetRaw = addDaysISO(chartCursorDate, offsetDays);
          const direction = offsetDays > 0 ? 'next' : offsetDays < 0 ? 'prev' : '';
          const perform = async () => {
            let fetchDemo = chartIsDemo;
            if (direction === 'prev') {
              const weekStart = startOfWeekISO(targetRaw);
              if (weekStart) {
                if (historyPrefetchPromise) {
                  try { await historyPrefetchPromise; } catch (_) { /* ignore */ }
                }
                const { isDemo: historyDemo } = await loadHistoricalData(weekStart, { demo: chartIsDemo });
                if (historyDemo) fetchDemo = true;
              }
            }
            chartIsDemo = chartIsDemo || fetchDemo;
            renderChartWindow(targetRaw, { isDemo: chartIsDemo, direction });
          };
          perform()
            .catch((error) => {
              console.error('Kunne ikke bla i omsetningsdiagram:', error);
            })
            .finally(() => {
              chartNavBusy = false;
              updateChartNavButtons();
            });
        };

        const fromDate = (() => {
          const current = new Date(today);
          const mayFirst = new Date(current.getFullYear(), 4, 1);
          if (current < mayFirst) {
            mayFirst.setFullYear(mayFirst.getFullYear() - 1);
          }
          return mayFirst;
        })();
        const from = toISODate(fromDate);

        const fetchDailyRange = async ({ fromISO, toISO, demo = false } = {}) => {
          const url = new URL('/.netlify/functions/lightspeed', apiBase);
          url.searchParams.set('from', fromISO);
          url.searchParams.set('to', toISO);
          url.searchParams.set('group', 'daily');
          const fromDateParsed = parseIsoDate(fromISO);
          const toDateParsed = parseIsoDate(toISO);
          const spanDays = (fromDateParsed && toDateParsed)
            ? Math.max(1, Math.round((toDateParsed - fromDateParsed) / 86400000) + 1)
            : 60;
          const windowSize = Math.min(90, Math.max(spanDays, 21));
          url.searchParams.set('limit', String(windowSize));
          url.searchParams.set('window', String(windowSize));
          if (demo) url.searchParams.set('demo', '1');

          const response = await fetch(url.toString(), { headers: { accept: 'application/json' } });
          const payload = await response.json().catch(() => null);
          if (!response.ok) {
            const error = new Error(`HTTP ${response.status}`);
            error.status = response.status;
            error.body = payload;
            throw error;
          }
          return payload;
        };

        const fetchDailyWithSplit = async ({ fromISO, toISO, demo = false, depth = 0 } = {}) => {
          try {
            const payload = await fetchDailyRange({ fromISO, toISO, demo });
            return [payload];
          } catch (error) {
            if (error?.status === 504 && depth < 4) {
              const fromDateObj = parseIsoDate(fromISO);
              const toDateObj = parseIsoDate(toISO);
              if (fromDateObj && toDateObj && fromDateObj < toDateObj) {
                const spanDays = Math.max(2, Math.round((toDateObj - fromDateObj) / 86400000) + 1);
                const splitDays = Math.floor(spanDays / 2);
                const midDate = new Date(fromDateObj);
                midDate.setDate(midDate.getDate() + splitDays - 1);
                if (midDate >= toDateObj) {
                  midDate.setDate(toDateObj.getDate() - 1);
                }
                if (midDate < fromDateObj) {
                  throw error;
                }
                const midISO = toISODate(midDate);
                const nextStart = new Date(midDate);
                nextStart.setDate(nextStart.getDate() + 1);
                if (nextStart > toDateObj) {
                  throw error;
                }
                const nextISO = toISODate(nextStart);
                const firstHalf = await fetchDailyWithSplit({ fromISO, toISO: midISO, demo, depth: depth + 1 });
                const secondHalf = await fetchDailyWithSplit({ fromISO: nextISO, toISO, demo, depth: depth + 1 });
                return [...firstHalf, ...secondHalf];
              }
            }
            throw error;
          }
        };

        const fetchDaily = async ({ demo = false, fromISO = from, toISO = todayISO } = {}) => {
          const baseRange = { fromISO, toISO, demo };
          try {
            return await fetchDailyRange(baseRange);
          } catch (error) {
            if (!(error?.status === 504)) {
              throw error;
            }
          }

          const startDate = parseIsoDate(fromISO);
          const endDate = parseIsoDate(toISO);
          if (!startDate || !endDate) {
            return fetchDailyRange(baseRange);
          }

          const ranges = [];
          const chunkSize = 60;
          let cursorStart = new Date(startDate);
          while (cursorStart <= endDate) {
            const chunkStart = new Date(cursorStart);
            const chunkEnd = new Date(cursorStart);
            chunkEnd.setDate(chunkEnd.getDate() + (chunkSize - 1));
            if (chunkEnd > endDate) chunkEnd.setTime(endDate.getTime());
            ranges.push({
              fromISO: toISODate(chunkStart),
              toISO: toISODate(chunkEnd),
            });
            chunkEnd.setDate(chunkEnd.getDate() + 1);
            cursorStart = new Date(chunkEnd);
          }

          const results = await Promise.all(
            ranges.map((range) => fetchDailyWithSplit({ ...range, demo }))
          );
          const payloads = results.flat();

          const combinedMap = new Map();
          let representativePayload = null;

          payloads.forEach((payload) => {
            if (!payload) return;
            if (!representativePayload) {
              representativePayload = { ...payload };
            } else if (payload && typeof payload === 'object') {
              if (payload.mode) representativePayload.mode = payload.mode;
              if (payload.statusMessage && !representativePayload.statusMessage) {
                representativePayload.statusMessage = payload.statusMessage;
              }
            }
            if (Array.isArray(payload?.daily)) {
              payload.daily.forEach((entry) => {
                if (!entry?.date) return;
                combinedMap.set(entry.date, entry);
              });
            }
          });

          const daily = Array.from(combinedMap.values())
            .sort((a, b) => a.date.localeCompare(b.date));

          if (!representativePayload) {
            return { daily };
          }
          representativePayload.daily = daily;
          return representativePayload;
        };

        let attemptedDemoFallback = false;
        renderChart([], { message: 'Henter …' });
        updateChartNavButtons();

        const load = (options = {}) => {
          const demo = !!options.demo;
          const initialCandidate = addDaysISO(todayISO, -(FAST_SPAN_DAYS - 1));
          const initialFromISO = initialCandidate && initialCandidate.localeCompare(from) > 0 ? initialCandidate : from;
          const needsHistoryPrefetch = initialFromISO.localeCompare(from) > 0;

          fetchDaily({ demo, fromISO: initialFromISO, toISO: todayISO })
            .then((payload) => {
              const { isDemo } = mergeDailyPayload(payload, { replace: true });
              chartIsDemo = demo || isDemo;
              renderChartWindow(chartLatestDate, { isDemo: chartIsDemo });
              if (revenueAnalysisContext?.date) {
                renderRevenueAnalysis(revenueAnalysisContext);
              }
              updateChartNavButtons();

              if (needsHistoryPrefetch && !historyPrefetchPromise) {
                const scheduleHistoryFetch = async () => {
                  const { isDemo: historyDemo } = await loadHistoricalData(from, { demo });
                  if (historyDemo) chartIsDemo = true;
                  updateChartNavButtons();
                };
                historyPrefetchPromise = scheduleHistoryFetch()
                  .catch((historyError) => {
                    console.error('Kunne ikke hente historiske data:', historyError);
                  })
                  .finally(() => {
                    historyPrefetchPromise = null;
                  });
              }
            })
            .catch((error) => {
              console.error('Kunne ikke hente daglig omsetning:', error);
              const isTimeout = error?.status === 408 || /408/.test(String(error?.message || ''));
              const shouldTryDemo = !attemptedDemoFallback && (
                error?.status === 400 &&
                (error?.body?.error === 'CONFIG_MISSING' || error?.body?.error === 'RECEIPTS_FAIL')
              );
              if (shouldTryDemo) {
                attemptedDemoFallback = true;
                renderChart([], { message: 'Bytter til demo-data …' });
                load({ demo: true });
                return;
              }
              if (attemptedDemoFallback && options.demo) {
                try {
                  mergeDailyPayload(
                    { daily: Array.isArray(error?.body?.daily) ? error.body.daily : [] },
                    { replace: true }
                  );
                  chartIsDemo = true;
                  renderChartWindow(chartLatestDate, { isDemo: true });
                  updateChartNavButtons();
                  return;
                } catch (_) {
                  /* fall through */
                }
              }
              if (chartDataAll.length) {
                const fallbackCursor = chartCursorDate || chartLatestDate;
                renderChartWindow(fallbackCursor, { isDemo: chartIsDemo, direction: '' });
              } else {
                chartDataAll = [];
                chartDataMap = new Map();
                chartCursorDate = null;
                chartLatestDate = todayISO;
                chartOldestDate = todayISO;
                chartIsDemo = false;
                const chartMessage = isTimeout
                  ? 'Lightspeed brukte for lang tid. Prøv igjen om litt.'
                  : (error?.body?.message || error?.message || 'Feil ved henting');
                renderChart([], { message: chartMessage });
              }
              updateChartNavButtons();
            });
        };

        if (chartPrevBtn) {
          chartPrevBtn.addEventListener('click', () => shiftChartWindow(-chartWindowDays));
        }
        if (chartNextBtn) {
          chartNextBtn.addEventListener('click', () => shiftChartWindow(chartWindowDays));
        }

        load();
      }

      const tripletexSection = document.querySelector('[data-tripletex-config]');
      if (tripletexSection) {
        const resolveTripletexEndpoint = async () => {
          if (resolveTripletexEndpoint.cache) return resolveTripletexEndpoint.cache;
          const candidates = [
            '/.netlify/functions/tripletex',
            '/api/tripletex',
            '/functions/tripletex'
          ];
          for (const base of candidates) {
            try {
              const ping = await fetch(`${base}?ping=1`, { method: 'GET' });
              if (ping.ok) {
                resolveTripletexEndpoint.cache = base;
                return base;
              }
            } catch (_) {
              /* ignore */
            }
          }
          resolveTripletexEndpoint.cache = candidates[0];
          return resolveTripletexEndpoint.cache;
        };

        const sectionConfigRaw = tripletexSection.dataset.tripletexConfig || '{}';
        let sectionConfig = {};
        try { sectionConfig = JSON.parse(sectionConfigRaw); } catch (_) {
          console.warn('Tripletex-config: kunne ikke tolke JSON');
        }

        const products = Object.entries(sectionConfig).map(([key, value]) => ({
          key,
          label: value?.label || key,
          revenueAccount: value?.accounts?.revenue || null,
          costAccount: value?.accounts?.cost || null,
        })).filter((item) => item.revenueAccount || item.costAccount);

        if (!products.length) {
          products.push({ key: 'beer', label: 'Øl', revenueAccount: 'id-289896744', costAccount: 'id-289896742' });
        }

        const accountsParam = [];
        products.forEach((product) => {
          if (product.revenueAccount) accountsParam.push(`${product.key}Revenue|${product.label} salg:${product.revenueAccount}`);
          if (product.costAccount) accountsParam.push(`${product.key}Cost|${product.label} varekost:${product.costAccount}`);
        });

        const todayDate = new Date();
        const reportingYear = todayDate.getFullYear();
        const fromISO = `${reportingYear}-01-01`;
        const toISO = toISODate(todayDate);
        const reportsToolbarEl = reportsToolbar;
        const monthButtons = reportsToolbarEl ? Array.from(reportsToolbarEl.querySelectorAll('.reports-month')) : [];
        const weekGrid = reportsToolbarEl ? reportsToolbarEl.querySelector('[data-week-grid]') : null;
        const dayGrid = reportsToolbarEl ? reportsToolbarEl.querySelector('[data-day-grid]') : null;
        const dayPanelInput = reportsToolbarEl ? reportsToolbarEl.querySelector('[data-range-day-input]') : null;
        const dayPanelToday = reportsToolbarEl ? reportsToolbarEl.querySelector('[data-range-day-today]') : null;
        const dayHintEl = reportsToolbarEl ? reportsToolbarEl.querySelector('[data-range-panel="day"] .reports-hint') : null;
        const monthLabelFmt = new Intl.DateTimeFormat('nb-NO', { month: 'long', year: 'numeric' });
        const weekRangeFmt = new Intl.DateTimeFormat('nb-NO', { day: '2-digit', month: 'short' });
        const dayLabelFmt = new Intl.DateTimeFormat('nb-NO', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        const reportsState = {
          activeRange: null,
          data: { month: null, week: null, day: null },
          selection: { month: null, week: null, day: null },
          loading: { month: false, week: false, day: false },
          error: { month: null, week: null, day: null },
        };
        if (dayPicker && dayPicker.value) {
          const initialDay = sanitizeIso(dayPicker.value);
          if (initialDay) reportsState.selection.day = initialDay;
        }
        if (dayPanelInput && reportsState.selection.day) {
          dayPanelInput.value = reportsState.selection.day;
        }

        const ensureWeekButtons = () => {
          if (!weekGrid) return;
          if (weekGrid.dataset.initialized === '1') return;
          weekGrid.innerHTML = '';
          for (let week = 1; week <= 53; week += 1) {
            const weekKey = `${reportingYear}-W${String(week).padStart(2, '0')}`;
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'reports-week';
            button.textContent = `Uke ${String(week).padStart(2, '0')}`;
            button.dataset.week = String(week);
            button.dataset.weekKey = weekKey;
            button.setAttribute('aria-pressed', 'false');
            weekGrid.appendChild(button);
          }
          weekGrid.dataset.initialized = '1';
        };

        const updateProductHeader = (productKey, label) => {
          const card = tripletexSection.querySelector(`[data-tripletex-product="${productKey}"]`);
          const heading = card?.querySelector('[data-tripletex-label]');
          if (card && heading) heading.textContent = `Tripletex · ${label}`;
        };

        products.forEach((product) => updateProductHeader(product.key, product.label));

        const getRangePanel = (range) => reportsToolbarEl ? reportsToolbarEl.querySelector(`[data-range-panel="${range}"]`) : null;
        const getRangeButton = (range) => reportsToolbarEl ? reportsToolbarEl.querySelector(`[data-range="${range}"]`) : null;

        const updateRangeButtonsState = () => {
          if (!reportsToolbarEl) return;
          reportsToolbarEl.querySelectorAll('[data-range]').forEach((btn) => {
            const btnRange = btn.dataset.range;
            const isActive = reportsState.activeRange === btnRange;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            const panel = getRangePanel(btnRange);
            const expanded = panel ? !panel.hidden : false;
            btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          });
        };

        const setRangePanelsVisibility = (rangeToShow = null) => {
          if (!reportsToolbarEl) return;
          reportsToolbarEl.querySelectorAll('[data-range-panel]').forEach((panel) => {
            const shouldShow = Boolean(rangeToShow && panel.dataset.rangePanel === rangeToShow);
            panel.hidden = !shouldShow;
            if (shouldShow) panel.dataset.open = 'true';
            else panel.removeAttribute('data-open');
          });
          updateRangeButtonsState();
        };

        const hideRangePanel = (range) => {
          const panel = getRangePanel(range);
          if (!panel) return;
          panel.hidden = true;
          panel.removeAttribute('data-open');
          updateRangeButtonsState();
        };

        const setStatus = (productKey, text, tone = 'muted') => {
          const card = tripletexSection.querySelector(`[data-tripletex-product="${productKey}"]`);
          const statusEl = card?.querySelector('[data-tripletex-status]');
          if (statusEl) {
            statusEl.textContent = text;
            statusEl.dataset.tone = tone;
          }
        };

        const setStatusAll = (text, tone = 'muted') => {
          products.forEach((product) => setStatus(product.key, text, tone));
        };

        const setTable = (productKey, rows) => {
          const card = tripletexSection.querySelector(`[data-tripletex-product="${productKey}"]`);
          const body = card?.querySelector('[data-tripletex-table]');
          if (!body) return;
          body.innerHTML = '';
          if (!rows.length) {
            const emptyRow = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.className = 'muted';
            cell.textContent = 'Ingen transaksjoner i perioden';
            emptyRow.appendChild(cell);
            body.appendChild(emptyRow);
            return;
          }
          rows.forEach((row) => {
            const tr = document.createElement('tr');
            const periodCell = document.createElement('td');
            periodCell.textContent = row.label || row.monthLabel || row.key || '–';
            if (row.hint) periodCell.title = row.hint;
            const revenueCell = document.createElement('td');
            revenueCell.className = 'numeric';
            revenueCell.textContent = row.revenue;
            const costCell = document.createElement('td');
            costCell.className = 'numeric';
            costCell.textContent = row.cost;
            const marginCell = document.createElement('td');
            marginCell.className = 'numeric';
            if (row.margin == null) {
              marginCell.classList.add('muted');
              marginCell.textContent = '–';
            } else {
              if (row.margin >= 0) marginCell.classList.add('trend-positive');
              else marginCell.classList.add('trend-negative');
              marginCell.textContent = percentFmt.format(row.margin);
            }
            tr.append(periodCell, revenueCell, costCell, marginCell);
            body.appendChild(tr);
          });
        };

        const makeIsoDate = (yearVal, monthVal, dayVal) => `${String(yearVal).padStart(4, '0')}-${String(monthVal).padStart(2, '0')}-${String(dayVal).padStart(2, '0')}`;

        const formatPeriodHint = (meta) => {
          const start = meta?.start ? parseIsoDate(meta.start) : null;
          const end = meta?.end ? parseIsoDate(meta.end) : null;
          if (start && end) return `${dateFmtShort.format(start)} – ${dateFmtShort.format(end)}`;
          if (start) return dateFmtShort.format(start);
          return '';
        };

        const formatPeriodLabel = (rangeType, key, meta) => {
          if (rangeType === 'month') {
            const labelDate = meta?.start ? parseIsoDate(meta.start) : null;
            if (labelDate) return monthLabelFmt.format(labelDate);
            const [yearPart, monthPart] = key.split('-');
            if (yearPart && monthPart) {
              return monthLabelFmt.format(new Date(Number(yearPart), Number(monthPart) - 1, 1));
            }
          } else if (rangeType === 'week') {
            const weekNumber = meta?.week || Number(String(key).split('-W')[1] || 0);
            const start = meta?.start ? parseIsoDate(meta.start) : null;
            const end = meta?.end ? parseIsoDate(meta.end) : null;
            if (start && end) {
              return `Uke ${String(weekNumber).padStart(2, '0')} · ${weekRangeFmt.format(start)} – ${weekRangeFmt.format(end)}`;
            }
            if (weekNumber) return `Uke ${String(weekNumber).padStart(2, '0')}`;
          } else if (rangeType === 'day') {
            const dateValue = meta?.date ? parseIsoDate(meta.date) : meta?.start ? parseIsoDate(meta.start) : parseIsoDate(key);
            if (dateValue) return dayLabelFmt.format(dateValue);
          }
          return key;
        };

        const normalizeTripletexResponse = (payload, { rangeType, from, to, year }) => {
          const aggregates = Array.isArray(payload?.accounts) ? payload.accounts : [];
          const aggregateMap = new Map(aggregates.map((entry) => [entry.key, entry]));
          const dataset = {
            rangeType,
            products: {},
            availableKeys: new Set(),
            meta: new Map(),
            keyByMonth: new Map(),
            summary: { start: from || null, end: to || null, label: '' },
          };

          const updateSummary = (value) => {
            if (!value) return;
            if (!dataset.summary.start || value < dataset.summary.start) dataset.summary.start = value;
            if (!dataset.summary.end || value > dataset.summary.end) dataset.summary.end = value;
          };

        const ensureMeta = (key, bucket) => {
          if (!key || key === 'ukjent') return null;
          if (!dataset.meta.has(key)) {
              const start = bucket?.meta?.start || bucket?.firstDate || null;
              const end = bucket?.meta?.end || bucket?.lastDate || null;
              const meta = {
                key,
                start,
                end,
                week: bucket?.meta?.week || null,
                year: bucket?.meta?.year || null,
                date: bucket?.meta?.date || null,
              };
              dataset.meta.set(key, meta);
            } else {
              const meta = dataset.meta.get(key);
              const start = bucket?.meta?.start || bucket?.firstDate || null;
              const end = bucket?.meta?.end || bucket?.lastDate || null;
              if (start && (!meta.start || start < meta.start)) meta.start = start;
              if (end && (!meta.end || end > meta.end)) meta.end = end;
              if (!meta.week && bucket?.meta?.week) meta.week = bucket.meta.week;
              if (!meta.year && bucket?.meta?.year) meta.year = bucket.meta.year;
              if (!meta.date && bucket?.meta?.date) meta.date = bucket.meta.date;
            }
            return dataset.meta.get(key);
          };

          products.forEach((product) => {
            const revenueEntry = product.revenueAccount ? aggregateMap.get(`${product.key}Revenue`) : null;
            const costEntry = product.costAccount ? aggregateMap.get(`${product.key}Cost`) : null;
            const revenueBuckets = revenueEntry?.periods || revenueEntry?.months || {};
            const costBuckets = costEntry?.periods || costEntry?.months || {};
            const periodKeys = new Set([
              ...Object.keys(revenueBuckets || {}),
              ...Object.keys(costBuckets || {}),
            ]);
            const rows = [];
            periodKeys.forEach((periodKey) => {
              if (!periodKey || periodKey === 'ukjent') return;
              const revenueBucket = revenueBuckets?.[periodKey];
              const costBucket = costBuckets?.[periodKey];
              const meta = ensureMeta(periodKey, revenueBucket || costBucket || {});
              if (meta) {
                meta.label = meta.label || formatPeriodLabel(rangeType, periodKey, meta);
                meta.hint = meta.hint || formatPeriodHint(meta);
                updateSummary(meta.start);
                updateSummary(meta.end);
                if (rangeType === 'month') {
                  const monthPart = periodKey.slice(5, 7);
                  if (monthPart) dataset.keyByMonth.set(monthPart, periodKey);
                }
              }
              const revenueAbs = Number(revenueBucket?.totalAbsolute || 0);
              const costAbs = Number(costBucket?.totalAbsolute || 0);
              const margin = revenueAbs > 0 ? (revenueAbs - costAbs) / revenueAbs : null;
              rows.push({
                key: periodKey,
                label: meta?.label || periodKey,
                hint: meta?.hint || '',
                revenue: moneyFmt.format(revenueAbs),
                cost: moneyFmt.format(costAbs),
                revenueValue: revenueAbs,
                costValue: costAbs,
                margin,
              });
              if (revenueAbs > 0.001 || costAbs > 0.001) dataset.availableKeys.add(periodKey);
            });
            rows.sort((a, b) => a.key.localeCompare(b.key));
            dataset.products[product.key] = { label: product.label, rows };
          });

          if (rangeType === 'month') {
            for (let month = 1; month <= 12; month += 1) {
              const monthPart = String(month).padStart(2, '0');
              const key = `${year}-${monthPart}`;
              if (!dataset.meta.has(key)) {
                const start = makeIsoDate(year, month, 1);
                const endDate = new Date(Date.UTC(year, month, 0));
                const end = makeIsoDate(endDate.getUTCFullYear(), endDate.getUTCMonth() + 1, endDate.getUTCDate());
                const labelDate = parseIsoDate(start);
                dataset.meta.set(key, {
                  key,
                  start,
                  end,
                  label: labelDate ? monthLabelFmt.format(labelDate) : key,
                  hint: formatPeriodHint({ start, end }),
                });
              }
              if (!dataset.keyByMonth.has(monthPart)) {
                dataset.keyByMonth.set(monthPart, key);
              }
            }
          }

          const metaValues = Array.from(dataset.meta.values()).sort((a, b) => a.key.localeCompare(b.key));
          if (!dataset.summary.start && metaValues[0]?.start) dataset.summary.start = metaValues[0].start;
          if (!dataset.summary.end && metaValues[metaValues.length - 1]?.end) dataset.summary.end = metaValues[metaValues.length - 1].end;
          if (dataset.summary.start && dataset.summary.end) {
            const startDate = parseIsoDate(dataset.summary.start);
            const endDate = parseIsoDate(dataset.summary.end);
            if (startDate && endDate) {
              dataset.summary.label = `${dateFmtShort.format(startDate)} – ${dateFmtShort.format(endDate)}`;
            }
          }
          return dataset;
        };

        const scrollIntoViewQuietly = (element) => {
          if (!element || typeof element.scrollIntoView !== 'function') return;
          element.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
        };

        const getSortedRangeKeys = (rangeType) => {
          const dataset = reportsState.data[rangeType];
          if (!dataset) return [];
          const metaKeys = Array.from(dataset.meta?.keys?.() || []);
          metaKeys.sort((a, b) => a.localeCompare(b));
          if (dataset.availableKeys && dataset.availableKeys.size) {
            const filtered = metaKeys.filter((key) => dataset.availableKeys.has(key));
            if (filtered.length) return filtered;
          }
          return metaKeys;
        };

        const setRangeSelection = (rangeType, key) => {
          reportsState.selection[rangeType] = key || null;
          if (rangeType === 'day' && dayPicker) {
            dayPicker.value = key || '';
          }
          if (rangeType === 'day' && dayPanelInput) {
            dayPanelInput.value = key || '';
          }
        };

        const cycleRangeSelection = (rangeType, direction = 1) => {
          const keys = getSortedRangeKeys(rangeType);
          if (!keys.length) return;
          const current = reportsState.selection[rangeType];
          let index = current ? keys.indexOf(current) : -1;
          if (index === -1) {
            index = direction > 0 ? -1 : 0;
          }
          const nextIndex = (index + direction + keys.length) % keys.length;
          const nextKey = keys[nextIndex];
          setRangeSelection(rangeType, nextKey);
          renderTripletexTables();
        };

        const pickInitialSelection = (rangeType) => {
          const keys = getSortedRangeKeys(rangeType);
          if (!keys.length) return null;
          if (rangeType === 'month') {
            const currentMonthKey = todayISO.slice(0, 7);
            if (keys.includes(currentMonthKey)) return currentMonthKey;
          } else if (rangeType === 'week') {
            const info = getISOWeekInfo(todayISO);
            if (info?.key && keys.includes(info.key)) return info.key;
          } else if (rangeType === 'day') {
            if (keys.includes(todayISO)) return todayISO;
          }
          return keys[keys.length - 1];
        };

        const applyMonthSelectionState = () => {
          if (!monthButtons.length) return;
          const dataset = reportsState.data.month;
          const available = dataset?.availableKeys || new Set();
          const activeKey = reportsState.selection.month;
          monthButtons.forEach((button) => {
            const monthPart = button.dataset.month;
            const periodKey = dataset?.keyByMonth?.get(monthPart) || `${reportingYear}-${monthPart}`;
            button.dataset.periodKey = periodKey;
            if (available.has(periodKey)) button.setAttribute('data-available', 'true');
            else button.removeAttribute('data-available');
            const isActive = Boolean(activeKey && activeKey === periodKey);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            if (isActive) button.setAttribute('data-active', 'true');
            else button.removeAttribute('data-active');
            const meta = dataset?.meta?.get(periodKey);
            if (meta?.hint) button.title = meta.hint;
            else button.removeAttribute('title');
            if (isActive) scrollIntoViewQuietly(button);
          });
        };

        const ensureWeekButtonForKey = (key, meta) => {
          if (!weekGrid) return null;
          let button = weekGrid.querySelector(`[data-week-key="${key}"]`);
          if (button) return button;
          button = document.createElement('button');
          button.type = 'button';
          button.className = 'reports-week';
          button.dataset.weekKey = key;
          button.setAttribute('aria-pressed', 'false');
          const weekNumber = meta?.week || Number(String(key).split('-W')[1] || 0);
          button.textContent = weekNumber ? `Uke ${String(weekNumber).padStart(2, '0')}` : key;
          if (meta?.hint) button.title = meta.hint;
          weekGrid.appendChild(button);
          return button;
        };

        const updateWeekButtons = () => {
          if (!weekGrid) return;
          ensureWeekButtons();
          const dataset = reportsState.data.week;
          const available = dataset?.availableKeys || new Set();
          const metaMap = dataset?.meta || new Map();
          const activeKey = reportsState.selection.week;
          metaMap.forEach((meta, key) => {
            ensureWeekButtonForKey(key, meta);
          });
          const buttons = Array.from(weekGrid.querySelectorAll('.reports-week'));
          buttons.forEach((button) => {
            const key = button.dataset.weekKey;
            const meta = metaMap.get(key);
            if (meta?.label) button.textContent = meta.label.split('·')[0].trim();
            if (meta?.hint) button.title = meta.hint;
            if (available.has(key)) button.setAttribute('data-available', 'true');
            else button.removeAttribute('data-available');
            const isActive = Boolean(activeKey && activeKey === key);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            if (isActive) button.setAttribute('data-active', 'true');
            else button.removeAttribute('data-active');
            if (isActive) scrollIntoViewQuietly(button);
          });
        };

        const updateDayButtons = () => {
          if (!dayGrid) return;
          const dataset = reportsState.data.day;
          const keys = getSortedRangeKeys('day').slice().sort((a, b) => b.localeCompare(a));
          const activeKey = reportsState.selection.day;
          dayGrid.innerHTML = '';
          if (!dataset || !keys.length) {
            if (dayPanelInput) {
              dayPanelInput.value = reportsState.selection.day || '';
            }
            return;
          }
          keys.forEach((key) => {
            const meta = dataset.meta?.get(key);
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'reports-day';
            button.dataset.dayKey = key;
            const isActive = activeKey === key;
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            if (isActive) button.dataset.active = 'true';
            else delete button.dataset.active;
            const label = meta?.label || formatFriendlyDate(key);
            const caption = meta?.hint && meta.hint !== label ? meta.hint : '';
            button.textContent = '';
            const labelSpan = document.createElement('span');
            labelSpan.textContent = label;
            button.appendChild(labelSpan);
            if (caption) {
              const hint = document.createElement('small');
              hint.textContent = caption;
              button.appendChild(hint);
            }
            dayGrid.appendChild(button);
            if (activeKey === key) scrollIntoViewQuietly(button);
          });
          if (dayPanelInput) {
            dayPanelInput.value = activeKey || '';
          }
        };

        const updateDayHint = () => {
          if (!dayHintEl) return;
          const dayKey = reportsState.selection.day;
          if (!dayKey) {
            dayHintEl.textContent = 'Velg en dag fra listen eller angi dato.';
            return;
          }
          const dateObj = parseIsoDate(dayKey);
          if (!dateObj) {
            dayHintEl.textContent = 'Velg en dag via datovelgeren i kortet.';
            return;
          }
          dayHintEl.textContent = `Valgt dag: ${dayLabelFmt.format(dateObj)}`;
        };

        const renderTripletexTables = () => {
          const range = reportsState.activeRange;
          const dataset = reportsState.data[range];
          if (!dataset) return;
          const selectionKey = reportsState.selection[range];
          if (range === 'day' && dayPicker) {
            dayPicker.value = selectionKey || '';
          }
          products.forEach((product) => {
            const rowsSource = dataset.products[product.key]?.rows || [];
            const rows = selectionKey ? rowsSource.filter((row) => row.key === selectionKey) : rowsSource;
            setTable(product.key, rows);
            let statusText = dataset.summary.label;
            if (selectionKey) {
              const meta = dataset.meta.get(selectionKey);
              statusText = meta?.label || meta?.hint || statusText || selectionKey;
            }
            setStatus(product.key, statusText || '');
          });
          if (range === 'month') applyMonthSelectionState();
          if (range === 'week') updateWeekButtons();
          if (range === 'day') {
            updateDayButtons();
            updateDayHint();
          }
        };

        const fetchTripletexRange = async (rangeType) => {
          if (reportsState.loading[rangeType]) return;
          reportsState.loading[rangeType] = true;
          if (reportsState.activeRange === rangeType) {
            setStatusAll('Henter …', 'muted');
          }
          try {
            const base = await resolveTripletexEndpoint();
            const url = new URL(base, window.location.origin);
            url.searchParams.set('from', fromISO);
            url.searchParams.set('to', toISO);
            if (['month', 'week', 'day'].includes(rangeType)) {
              url.searchParams.set('group', rangeType);
            }
            accountsParam.forEach((entry) => url.searchParams.append('accounts', entry));
            const res = await fetch(url.toString(), { headers: { accept: 'application/json' } });
            const text = await res.text();
            let data = {};
            try { data = JSON.parse(text); } catch (_) {}
            if (!res.ok) {
              const message = data?.message || data?.error || res.statusText || text || 'Kunne ikke hente Tripletex-data';
              throw new Error(message);
            }
            const dataset = normalizeTripletexResponse(data, { rangeType, from: fromISO, to: toISO, year: reportingYear });
            reportsState.data[rangeType] = dataset;
            reportsState.error[rangeType] = null;
            if (!reportsState.selection[rangeType]) {
              const initialKey = pickInitialSelection(rangeType);
              if (initialKey) setRangeSelection(rangeType, initialKey);
            }
            if (rangeType === 'month') applyMonthSelectionState();
            if (rangeType === 'week') updateWeekButtons();
            if (rangeType === 'day') {
              if (!reportsState.selection.day) {
                setRangeSelection('day', sanitizeIso(toISO));
              }
              updateDayButtons();
              updateDayHint();
            }
            if (reportsState.activeRange === rangeType) {
              renderTripletexTables();
            }
          } catch (error) {
            reportsState.error[rangeType] = error;
            if (reportsState.activeRange === rangeType) {
              products.forEach((product) => setTable(product.key, []));
              setStatusAll(String(error.message || error), 'error');
            }
          } finally {
            reportsState.loading[rangeType] = false;
          }
        };

        if (reportsToolbarEl) {
          reportsToolbarEl.querySelectorAll('[data-range]').forEach((button) => {
            button.addEventListener('click', () => {
              const range = button.dataset.range;
              if (!range) return;
              const panel = getRangePanel(range);
              const panelVisible = panel ? !panel.hidden : false;
              const isActive = reportsState.activeRange === range;

              if (range === 'month') {
                if (!isActive) {
                  reportsState.activeRange = range;
                  setRangePanelsVisibility('month');
                  if (!reportsState.data[range] && !reportsState.loading[range]) {
                    fetchTripletexRange(range);
                  } else {
                    if (!reportsState.selection[range]) {
                      const initialKey = pickInitialSelection(range);
                      if (initialKey) setRangeSelection(range, initialKey);
                    }
                    applyMonthSelectionState();
                    renderTripletexTables();
                  }
                  return;
                }
                if (!panelVisible) {
                  setRangePanelsVisibility('month');
                  if (!reportsState.data[range] && !reportsState.loading[range]) {
                    fetchTripletexRange(range);
                  } else {
                    applyMonthSelectionState();
                  }
                  return;
                }
                hideRangePanel('month');
                return;
              }

              if (range === 'week') {
                if (!isActive) {
                  reportsState.activeRange = range;
                  ensureWeekButtons();
                  setRangePanelsVisibility('week');
                  if (!reportsState.data[range] && !reportsState.loading[range]) {
                    fetchTripletexRange(range);
                  } else {
                    if (!reportsState.selection[range]) {
                      const initialKey = pickInitialSelection(range);
                      if (initialKey) setRangeSelection(range, initialKey);
                    }
                    updateWeekButtons();
                    renderTripletexTables();
                  }
                  return;
                }
                if (!panelVisible) {
                  setRangePanelsVisibility('week');
                  return;
                }
                if (reportsState.loading[range]) return;
                if (!reportsState.data[range]) {
                  fetchTripletexRange(range);
                  return;
              }
              cycleRangeSelection(range);
              return;
            }

            if (range === 'day') {
              if (!isActive) {
                reportsState.activeRange = range;
                setRangePanelsVisibility('day');
                if (!reportsState.data[range] && !reportsState.loading[range]) {
                  fetchTripletexRange(range);
                } else {
                  if (!reportsState.selection[range]) {
                    const initialKey = pickInitialSelection(range);
                    if (initialKey) setRangeSelection(range, initialKey);
                  }
                  updateDayButtons();
                  renderTripletexTables();
                }
                return;
              }
              if (!panelVisible) {
                setRangePanelsVisibility('day');
                updateDayButtons();
                return;
              }
              hideRangePanel('day');
              return;
            }

            reportsState.activeRange = range;
            setRangePanelsVisibility(null);
            if (!reportsState.data[range] && !reportsState.loading[range]) {
              fetchTripletexRange(range);
            } else {
                if (!reportsState.selection[range]) {
                  const initialKey = pickInitialSelection(range);
                  if (initialKey) setRangeSelection(range, initialKey);
                }
                renderTripletexTables();
              }
              updateRangeButtonsState();
            });
          });

          monthButtons.forEach((button) => {
            button.addEventListener('click', () => {
              const periodKey = button.dataset.periodKey || `${reportingYear}-${button.dataset.month}`;
              setRangeSelection('month', periodKey);
              renderTripletexTables();
              applyMonthSelectionState();
              hideRangePanel('month');
            });
          });

          if (weekGrid) {
            weekGrid.addEventListener('click', (event) => {
              const trigger = event.target.closest('.reports-week');
              if (!trigger || trigger.disabled) return;
              const key = trigger.dataset.weekKey;
              if (!key) return;
              const isActive = reportsState.selection.week === key;
              setRangeSelection('week', isActive ? null : key);
              renderTripletexTables();
              updateWeekButtons();
            });
          }

          if (dayGrid) {
            dayGrid.addEventListener('click', (event) => {
              const trigger = event.target.closest('.reports-day');
              if (!trigger) return;
              const key = trigger.dataset.dayKey;
              if (!key) return;
              setRangeSelection('day', key);
              updateDayButtons();
              renderTripletexTables();
              hideRangePanel('day');
            });
          }

          if (dayPanelInput) {
            dayPanelInput.addEventListener('change', () => {
              const value = sanitizeIso(dayPanelInput.value);
              if (!value) return;
              setRangeSelection('day', value);
              updateDayButtons();
              renderTripletexTables();
            });
          }

          if (dayPanelToday) {
            dayPanelToday.addEventListener('click', () => {
              setRangeSelection('day', todayISO);
              updateDayButtons();
              renderTripletexTables();
              hideRangePanel('day');
            });
          }

          document.addEventListener('click', (event) => {
            ['month', 'day'].forEach((range) => {
              const panel = getRangePanel(range);
              if (!panel || panel.hidden) return;
              const button = getRangeButton(range);
              if (panel.contains(event.target)) return;
              if (button && button.contains(event.target)) return;
              hideRangePanel(range);
            });
          });

          document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            let handled = false;
            ['month', 'day'].forEach((range) => {
              if (handled) return;
              const panel = getRangePanel(range);
              if (!panel || panel.hidden) return;
              hideRangePanel(range);
              const button = getRangeButton(range);
              if (button) button.focus();
              handled = true;
            });
          });
        }

        if (dayPicker) {
          dayPicker.addEventListener('change', () => {
            const value = sanitizeIso(dayPicker.value);
            setRangeSelection('day', value);
            if (!reportsState.data.day && !reportsState.loading.day) {
              fetchTripletexRange('day');
            } else if (reportsState.activeRange === 'day') {
              renderTripletexTables();
            } else {
              updateDayHint();
            }
          });
        }

        if (reportsToolbarEl) {
          setRangePanelsVisibility(null);
        }
      }

      const navMobileToggle = document.querySelector('.nav-actions .mobile-toggle');
      const navControls = document.querySelector('.nav-controls');
      const topBar = document.querySelector('.top-bar');
      const mobileThemeSwitch = document.querySelector('.mobile-theme-switch');
      if (navMobileToggle && navControls) {
        navMobileToggle.addEventListener('click', () => {
          const open = !navControls.classList.contains('open');
          navControls.classList.toggle('open', open);
          navMobileToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (mobileThemeSwitch && dashMq.matches) mobileThemeSwitch.hidden = !open;
        });
        const dashMq = window.matchMedia('(max-width: 720px)');
        const resetDash = () => {
          if (!dashMq.matches) {
            navControls.classList.remove('open');
            navMobileToggle.setAttribute('aria-expanded', 'false');
            if (mobileThemeSwitch) mobileThemeSwitch.hidden = false;
          } else {
            if (mobileThemeSwitch) mobileThemeSwitch.hidden = !navControls.classList.contains('open');
          }
        };
        dashMq.addEventListener ? dashMq.addEventListener('change', resetDash) : dashMq.addListener(resetDash);
        resetDash();
      }

      const themeToggleInput = document.querySelector('#dash-theme-toggle');
      if (themeToggleInput) {
        const isDark = document.body.getAttribute('data-theme') !== 'light';
        themeToggleInput.checked = isDark;
        themeToggleInput.addEventListener('change', () => {
          const toDark = themeToggleInput.checked;
          document.body.setAttribute('data-theme', toDark ? 'dark' : 'light');
          if (mobileThemeSwitch) {
            const mobileInput = mobileThemeSwitch.querySelector('input');
            if (mobileInput) mobileInput.checked = toDark;
          }
        });
      }

      if (mobileThemeSwitch) {
        const mobileInput = mobileThemeSwitch.querySelector('input');
        if (mobileInput && themeToggleInput) {
          const syncMobileState = () => {
            mobileInput.checked = themeToggleInput.checked;
          };
          syncMobileState();
          mobileInput.addEventListener('change', () => {
            const toDark = mobileInput.checked;
            document.body.setAttribute('data-theme', toDark ? 'dark' : 'light');
            themeToggleInput.checked = toDark;
          });
          themeToggleInput.addEventListener('change', syncMobileState);
        }
      }

      const languageToggleGroup = document.querySelector('[data-language-toggle]');
      if (languageToggleGroup) {
        languageToggleGroup.addEventListener('click', (event) => {
          const trigger = event.target.closest('[data-lang]');
          if (!trigger) return;
          languageToggleGroup.querySelectorAll('[data-lang]').forEach((btn) => {
            btn.setAttribute('aria-pressed', btn === trigger ? 'true' : 'false');
          });
        });
      }

      if (topBar) {
        let lastScrollY = window.scrollY;
        let ticking = false;
        const threshold = 10;
        const handleScroll = () => {
          const currentY = window.scrollY;
          const delta = currentY - lastScrollY;
          if (Math.abs(delta) > threshold) {
            const shouldHide = currentY > lastScrollY && currentY > 48;
            topBar.dataset.hidden = shouldHide ? '1' : '0';
            lastScrollY = currentY;
          }
          ticking = false;
        };
        window.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(handleScroll);
            ticking = true;
          }
        }, { passive: true });
      }

      const userMenu = document.querySelector('[data-menu]');
      if (userMenu) {
        const trigger = userMenu.querySelector('.user-menu__trigger');
        const panel = userMenu.querySelector('.user-menu__panel');
        const items = Array.from(userMenu.querySelectorAll('.user-menu__item'));

        const setOpen = (open) => {
          userMenu.classList.toggle('open', open);
          trigger.setAttribute('aria-expanded', String(open));
          panel.toggleAttribute('hidden', !open);
          if (open) {
            requestAnimationFrame(() => items[0]?.focus());
          }
        };

        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          const open = !userMenu.classList.contains('open');
          setOpen(open);
        });

        trigger.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            if (!userMenu.classList.contains('open')) {
              setOpen(true);
            } else {
              items[0]?.focus();
            }
          } else if (event.key === 'Escape') {
            setOpen(false);
            trigger.focus();
          }
        });

        items.forEach((item, index) => {
          item.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
              event.preventDefault();
              const direction = event.key === 'ArrowDown' ? 1 : -1;
              const nextIndex = (index + direction + items.length) % items.length;
              items[nextIndex].focus();
            } else if (event.key === 'Escape') {
              setOpen(false);
              trigger.focus();
            }
          });

          item.addEventListener('click', () => {
            setOpen(false);
            trigger.focus();
          });
        });

        document.addEventListener('click', (event) => {
          if (!userMenu.contains(event.target)) {
            setOpen(false);
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && userMenu.classList.contains('open')) {
            setOpen(false);
            trigger.focus();
          }
        });
      }
    })();
  </script>
</body>
</html>
